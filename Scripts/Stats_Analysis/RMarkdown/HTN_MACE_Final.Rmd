---
title: "HTN PRS MACE prospective"
author:  "Jennifer Collister"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  word_document:
      reference_docx: "K:/TEU/TEU_Guides/TEU_DocStyle_Rmd_2020.dotx"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include=TRUE, echo=FALSE)

library(kableExtra)
library(knitr)
library(yaml)
library(here)
library(DiagrammeR)
library(DiagrammeRsvg)
library(svglite)
library(rsvg)
library(png)
library(dplyr)
library(ggplot2)
library(survival)
library(survminer)
library(rms)
library(shiny)
library(rcompanion)
library(Publish)
library(gridExtra)
library(ResourceSelection)
library(naniar)
library(mice)
library(gtools)
library(epitools)
library(tools)

# Specify the markdown format for knitr tables, otherwise they're not compatible with kableExtra
options(knitr.kable.NA='', knitr.table.format = "markdown")
options(kableExtra.auto_format = FALSE)
# Set the root directory to the project directory (otherwise knitr works in the directory of the Rmd file by default)
knitr::opts_knit$set(root.dir = here::here())
knitr::opts_chunk$set(include=TRUE, echo=FALSE)

# Load the project config file for filepaths etc
config = yaml.load_file(here::here("./config.yml"))
source(here::here(config$functions$JC))

#-------------------------------------------------------------------------------------------------------------------
# Setup

figure <- 1
table <- 1
suppfig <- 1
footnote_no <- 1

# Check if the session is being knitted or run interactively
# When we're knitting the documentation, we don't want to include the diagnostic checks
live <- interactive()

```

```{r data-derivation, include=FALSE, cache=TRUE}

source(file.path(config$scripts$cleaning, "dataset_generator.R"))

exclusions <- function(data){
  
  excl$initial <<- nrow(data)
  
  # Restrict to genetically white British
  data <- data[!is.na(data$GeP_ethnic),]
  
  excl$whiteBrit <<- nrow(data)
  
  # Exclude those outside the 40-70 age range
  data <- data[data$TEU_BaC_AgeAtRec >= 40 & data$TEU_BaC_AgeAtRec < 70,]
  
  excl$agerange <<- nrow(data)

  # Exclude individuals with missing BP data
  data <- data[!is.na(data$TEU_BlP_SBP.avg),]
  data <- data[!is.na(data$TEU_BlP_DBP.avg),]
  
  # or missing answers to BP questions on touchscreen questionnaire
  # data <- data[data$TEU_HMH_prevHTN != "Unanswered",]
  # data <- data[data$TEU_HMH_Meds_BP != "Unanswered",]
  
  # Exclude participants who only had BP measured once
  data <- data[data$TEU_BlP_nSBP == 2 & data$TEU_BlP_nDBP == 2,]
  
  excl$BPmiss <<- nrow(data)

  # Exclude individuals with implausible BP data
  data <- data[data$TEU_BlP_SBP.avg >= 70 & data$TEU_BlP_SBP.avg <= 270,]
  data <- data[data$TEU_BlP_DBP.avg >= 50 & data$TEU_BlP_DBP.avg <= 150,]
  
  excl$BPimp <<- nrow(data)
  
  # Only keep those with genetic data
  data <- data[!is.na(data$TEU_BP_PRS),]
  
  excl$PRSmiss <<- nrow(data)

  # Exclude pregnant women ("Yes" or "Unsure")
  data <- data[is.na(data$VeI_PregnantNow) | data$VeI_PregnantNow == "No",]
  
  excl$pregnant <<- nrow(data)

  # Exclude individuals who have serious health conditions
  data <- data[is.na(data$TEU_VeI_seriouscomb),]

  # And individuals with cancer (except for skin cancer?)
  data <- data[is.na(data$TEU_VeI_cancer),]
  
  excl$seriouscomorb <<- nrow(data)
  
  # Exclude MACE at baseline
  data <- data[!data$TEU_MACE_prev=="Yes",]
  
  excl$MACE <<- nrow(data)
  
  # Exclude those who were not hypertensive
  data <- data[data$TEU_evidenceHTN == TRUE & !is.na(data$TEU_evidenceHTN),]
  
  excl$evidenceHTN <<- nrow(data)
  
  # Exclude those who were not aware
  data <- data[data$TEU_awareHTN == TRUE & !is.na(data$TEU_awareHTN),]
  
  excl$aware <<- nrow(data)
  
  # Only interested in treated hypertensives
  data <- data[data$TEU_treatedHTN == TRUE & !is.na(data$TEU_treatedHTN),]
  
  excl$treated <<- nrow(data)
  
  return(data) 
}

excl <- list(initial=0)

data <-
  evalWithMemoization(
    derive_variables(
      database = "K:/TEU/UKB33952_Data/Data_Downloads/V3_database_duckdb0.2.1/ukb_v3.db",
      field_definitions = TEU_SPECS$HTN_control_MACE,
      exclusions = exclusions
    ),
    key = c(TEU_SPECS$HTN_control_MACE, exclusions)
  )

pretty_func <- pretty_switch(field_definitions=TEU_SPECS$HTN_control_MACE, return_type = "function")
pretty_names <- pretty_switch(field_definitions=TEU_SPECS$HTN_control_MACE, return_type = "list")

export_svg(DiagrammeR::grViz(here::here(file.path(config$outputs$flowcharts, "HTN_PRS_MACE.gv")))
           ) %>% charToRaw %>% rsvg %>% 
  png::writePNG(here::here(file.path(config$outputs$figures, "HTN_PRS_MACE.png")))


```

# Analysis Population

## Figure `r figure`. Flowchart illustrating selection of analytic dataset (n = `r nrow(data)`).
`r figure <- figure + 1`
![Missing BP data was defined as fewer than 2 BP measurements at baseline. Hypertension was defined as self-report of hypertensive medication use, or self-report of a prior diagnosis of hypertension, or mean BP >= 140 /90 mmHg at baseline assessment. Awareness was defined as self-report of a prior diagnosis of hypertension among those who were hypertensive. Treatment was defined as self-report of hypertensive medication among those who were aware. Control was defined as mean BP < 140/90 mmHg at baseline assessment, among those who were treated.](Figures/HTN_PRS_MACE.png){height=700px}

## Multiple Imputation

**Multiple imputation (MI)** was used to impute missing values for covariates fitted in the analysis model under missing at random (MAR) assumption. We constructed imputation model using rawest format of covariates from the analysis model and performed 10 imputations (ran for 20 iterations) using default imputation method according to covariate type. 


Table 1 shows the descriptive statistics of the original dataset (i.e. before multiple imputation). Tables 2-5 show the pooled analysis outputs using 10 imputed datasets (i.e. complete datasets with imputed missing values). 


```{r}

MI_data=data%>%
  select(ID,TEU_MACE_status,TEU_MACE_time_yrs, TEU_MACE_MI, TEU_MACE_Stroke, TEU_controlledHTN, TEU_uncontrolledHTN,
         TEU_BaC_AgeAtRec,BaC_Sex,
         TEU_SBP_PRS,
         BSM_BMI,TEU_Smo_Status,
         TEU_Alc_WeeklyCat,
         TEU_Alc_WeeklyAlcUnits,
         PhA_METsWkAllAct,TEU_FaH_CVD,
         Prosp_comorb_numcat,
         TEU_VeI_numHTNmeds,
         TEU_BlP_SBP.avg, 
         BBC_LDL_Result,
         TownsendDepInd, TEU_HouseholdIncome,TEU_Emp_category,TEU_Edu_ISCED,
         TEU_Rec_Country,
         paste0('GeP_PC_',1:4), GeP_Array
         )%>%
  # Change missing categories to NA
  mutate_if(is.factor, list(~na_if(., "Unanswered")))%>%
  mutate_if(is.factor, list(~na_if(., "Prefer not to answer")))%>%
  droplevels()
            
            


# Check missing percentage 
if(live){MI_data%>%miss_var_summary()}

# Based on our Stats Guide, one can consider MI when missing percentage 10%-30%
# Assumption: MAR

# Investigate missing mechanism: Assess association between missing and observed data 

# Check KM plot by missing indicator for variables that contain missing data 
# Prepare for KM plot against missingness 
missing_var=MI_data%>%miss_var_summary()%>%filter(n_miss!=0)%>%pull(variable)

mp_data=MI_data%>%
  mutate_at(missing_var,~ifelse(is.na(.),'Missing','Not Missing'))


# unadjusted KM (adjusted KM would be better but covariates adjusted contain missing data)
# log rank test
plot_list = list()
for(i in missing_var){
  #var=missing_var[i]
  
  p<-ggsurvplot(
    fit = survfit(Surv(TEU_MACE_time_yrs,TEU_MACE_status)~  mp_data[[i]], data = mp_data), 
    xlab = "Years", 
    ylab = "Survival probability",
    title = paste0(i),
    pval = TRUE)
  
  plot_list[[i]]<-p
  
}
if(live){plot_list}

# In general, if there is visual and statistical evidence of significant differences in survival distributions stratified by missing value indicator, then simply removing missing data (i.e. complete case analysis) would lead to biased estimate of the true survival of the cohort.

```

```{r}

# Create Imputations (iter=20, M=5)
iter <- 20
M <- 10

# Using default imputation method based on variable type

if(live) {
  ini <- mice(MI_data,maxit = 0,print=FALSE)
  pred <- ini$predictorMatrix
  
  # Remove predictors: ID; TEU_MACE_MI; TEU_MACE_Stroke; TEU_Alc_WeeklyCat (want to use alc continuous variables instead)
  pred[,c("ID","TEU_MACE_MI","TEU_MACE_Stroke")] <- 0
  
  
  imp1<-mice(MI_data,pred=pred, m = M, maxit = iter,seed = 100)
  
  saveRDS(imp1,file=file.path(config$data$derived, paste0("imputation", format(Sys.time(), '%d%B%Y'), ".rds")))
} else {
  imp1 <- readRDS(file.path(config$data$derived, "imputation14May2021_newPRS.rds"))
}
```

```{r, eval=live}

# Diagnostics 

## 1. Assess Convergence 
plot(imp1)

## 2. Compare summary stats between observed and completed (observed + imputed) data

# Extract completed data after MI
long1 <- complete(imp1,"long") 
long1$.imp <- as.factor(long1$.imp)



num_plot <- list() #Save the density plots
factor_tb <- list() # Save the freq tables 

for (var in missing_var){
  
  if (is.numeric(MI_data[[var]])){
    # If numeric, plot density between observed and imputed 
    
    #long1 <- cbind(long1, ind.na=is.na(imp1$data[[var]]))
    long1 <- long1 %>%
      mutate(ind.na=rep(is.na(imp1$data[[var]]), M))
    
    p<-densityplot(~long1[[var]]|.imp, data=long1, group=ind.na, plot.points=FALSE,
                ref=TRUE, xlab=paste0(var),scales=list(y=list(draw=F)),
                par.settings=simpleTheme(col.line=rep(c("blue","red"))), 
                auto.key = list(columns=2,text=c("Observed","Imputed")))
    
    num_plot[[var]]=p
    
  }else{
    # If factor, produce freq table of each level between observed and imputed 
    long1 <- long1 %>%
      mutate(ind.na=rep(ifelse(is.na(imp1$data[[var]]),'Imputed','Observed'), M))
    
    factor_tb[[var]] <- lapply(unique(long1$.imp), function(i) 
      prop.table(table(long1%>%filter(.imp==i)%>%pull(ind.na),
                       long1%>%filter(.imp==i)%>%pull(var)), margin = 1)*100)
    
  }
}

num_plot
factor_tb


# Check overall descriptive between observed and completed (observed + imputed)
summary(MI_data$TEU_BlP_SBP.avg)

lapply(1:M, function(i) summary(long1%>%filter(.imp==i)%>%pull(TEU_BlP_SBP.avg)))

summary(MI_data$TownsendDepInd)

lapply(1:M, function(i) summary(long1%>%filter(.imp==i)%>%pull(TownsendDepInd)))


```

```{r}

# Post processing: Change continuous covariates to categorical for further analysis 

long1 <- complete(imp1,"long",include = TRUE) 

comp_long1<-long1%>%
  mutate(
    TEU_BaC_AgeCat=cut(TEU_BaC_AgeAtRec,
                       breaks = c(40, 50, 60, 70),
                       labels = c("40-49", "50-59", "60-69"),
                       right = FALSE
    ),
    
    TEU_BSM_BMIcat=factor(cut(BSM_BMI,
                       breaks = c(0, 18.5, 25, 30, 200),
                       c("Underweight", "Normal", "Overweight", "Obese"),
                       right = FALSE
    ),levels = c('Normal','Underweight','Overweight','Obese')),
    
    TEU_LDLctrl_v1=factor(ifelse(BBC_LDL_Result<3,1,0),levels=c(0,1), 
                          labels=c("Not controlled", "Controlled")),
    TEU_Smo_Status=factor(TEU_Smo_Status,levels = c('Never','Previous','Current')),
    TEU_Pha_METsover1200 = factor(ifelse(PhA_METsWkAllAct<=1200,"Low (MET minutes <= 1200)",
                                         "High (MET minutes > 1200)"),
                                  levels = c("Low (MET minutes <= 1200)", "High (MET minutes > 1200)")),
    TEU_VeI_numHTNmedscat = factor( dplyr::case_when(
        is.na(TEU_VeI_numHTNmeds) ~ "None reported",
        TEU_VeI_numHTNmeds == 0 ~ "None reported",
        TEU_VeI_numHTNmeds == 1 ~ "1",
        TEU_VeI_numHTNmeds == 2 ~ "2",
        TEU_VeI_numHTNmeds >= 3 ~ "3 or more",
        TRUE ~ as.character(TEU_VeI_numHTNmeds)
      ), levels=c("None reported", "1", "2", "3 or more"))
      )%>%
  
  group_by(.imp)%>%
  mutate(TEU_SBP_PRS_quintiles= quantcut(TEU_SBP_PRS,q=5,labels = c('Q1: Lowest score','Q2','Q3','Q4','Q5: Highest score')),
         TEU_TownsendDepInd_Quint= quantcut(TownsendDepInd,q=5,labels = c('Q1: least deprived','Q2','Q3','Q4','Q5: most deprived')),
         TEU_BlP_SBP_quintiles=quantcut(TEU_BlP_SBP.avg,q=5,labels=c('Q1: lowest','Q2','Q3','Q4','Q5: highest')),
         TEU_LDL_Quintiles=quantcut(BBC_LDL_Result,q=5,labels=c('Q1: lowest','Q2','Q3','Q4','Q5: highest')),
         GeP_Array=factor(GeP_Array, levels=c("Axiom", "BiLEVE")))

comp_long1<-as.mids(comp_long1)


```




# Hypertension PRS cross-sectional analysis

## Table `r table`. Age-standardised descriptive statistics of analysis population by systolic BP PRS quintiles (N = `r nrow(data)`).
`r table <- table + 1`

Age is presented as mean (SD) in each PRS quintile, all categorical variables are given as percentages standardised to the age distribution (in 1 year brackets) of the analysis population.

```{r descriptive-table, include=TRUE, echo=FALSE}
varlist=c("TEU_BaC_AgeAtRec", "BaC_Sex", "TEU_BlP_SBP_quintiles",
          "TEU_BSM_BMIcat", "TEU_Smo_Status", "TEU_Alc_WeeklyCat", "TEU_Pha_METsover1200",
          "TEU_FaH_CVD", "Prosp_comorb_numcat", "TEU_VeI_numHTNmedscat", "TEU_LDL_Quintiles",
          "TEU_TownsendDepInd_Quint", "TEU_HouseholdIncome", "TEU_Emp_category", "TEU_Edu_ISCED", "TEU_Rec_Country"
          )

data$age_standardise <- cut(data$TEU_BaC_AgeAtRec, seq(40, 70, by=1))

tab <- table1_standardised(data=data, varlist=varlist, adj="age_standardise", 
                 stratify="TEU_SBP_PRS_quintiles", strata=c("Q1: Lowest score", "Q3", "Q5: Highest score"),
                 pretty_names=pretty_names, singlecol=TRUE)

colnames(tab)[1] <- "Variable"

# Output the resulting table
kable(tab)

```


## Table `r table`: Multivariable logistic regression exploring association of systolic BP PRS with uncontrolled hypertension (N =`r nrow(data)`)
`r table <- table + 1`

```{r logistic-regression, include=TRUE, echo=FALSE}

varlist=c("TEU_BaC_AgeCat", "BaC_Sex", "TEU_SBP_PRS_quintiles",
          "TEU_BSM_BMIcat", "TEU_Smo_Status", "TEU_Alc_WeeklyCat", "TEU_Pha_METsover1200",
          "TEU_FaH_CVD", "Prosp_comorb_numcat", "TEU_VeI_numHTNmedscat", "TEU_LDL_Quintiles",
          "TEU_TownsendDepInd_Quint", "TEU_HouseholdIncome", "TEU_Emp_category", "TEU_Edu_ISCED", "TEU_Rec_Country",
          "GeP_PC_1", "GeP_PC_2", "GeP_PC_3", "GeP_PC_4", "GeP_Array"
          )

formula <- paste0("TEU_uncontrolledHTN  ~ ", paste(varlist, collapse="+"))
rmodel <- with(comp_long1, glm(as.formula(formula), family="binomial"))

routput <- printMIresults(df=comp_long1$data, varlist=varlist, modeloutput=summary(pool(rmodel)),
                            pretty_names=pretty_names, onecol=FALSE, IDcol=FALSE)

rownames(routput) <- NULL

colnames(routput) <- c("Coefficient", "Level", "OR", "95% CI", "p")

# Output the resulting table
kable(routput)

```

```{r}

# p-value of including PRS in model

anova <- with(comp_long1, glm(as.formula(paste0("TEU_uncontrolledHTN ~ ",
                             paste(varlist[-which(varlist=="TEU_SBP_PRS_quintiles")], collapse="+"))), family="binomial"))

LRT <- anova(rmodel, anova, method = 'D2',use = 'likelihood')

SBP_p <- LRT$out$`1 ~~ 2`$result[4]

```

### Overall p-value of SBP PRS

Based on likelihood ratio test, inclusion of SBP PRS `r if(SBP_p < 0.05){"**does**"}else{"does **not**"}` provide significant improvement in model fit (p = `r pretty_pval(SBP_p)`).

```{r cross-sectional model check,echo=FALSE,eval=live}

HL_test<-list() #saves how many groups have HL test p<0.05 for each imputation, if large indicates poor model fit

vifs<-list() #saves vif output for each imputation

for (i in 1:comp_long1$m) {
  ## 1. HL test (goodness of fit) across multiple choices of g,5:15
  HL_pvalues<-sapply(5:15,function(k) hoslem.test(rmodel$analyses[[i]]$y,fitted(rmodel$analyses[[i]]),
                                                  g=k)$p.value)
  
  HL_test[[i]]<-sum(HL_pvalues<0.05)
  
  ## 2. Multicollinearity
  vifs[[i]]<-data.frame(car::vif(rmodel$analyses[[i]]))
  vifs[[i]]$squared=(vifs[[i]]$GVIF..1..2.Df..)^2
}

if(live){HL_test}
if(live){vifs}

```

### Model Checking on each imputed dataset:

*	Assessing model fit: Performed Hosmer-Lemeshow test across multiple choices of g (number of groups) from 5 to 15 and majority of p-values were above 5% significance level, which suggested good model fit.
*	Multicollinearity: Assessed via ‘car’ R package and VIFs across all covariates were below 10. No multicollinearity detected.

# Hypertension PRS prospective analysis

Including SBP PRS (quintiles), showing for each outcome:

* Model A: without measured SBP at baseline
* Model B: with measured SBP at baseline

```{r varlists for models}

varlist_a <- c("TEU_BaC_AgeCat", "BaC_Sex", "TEU_SBP_PRS_quintiles",
          "TEU_BSM_BMIcat", "TEU_Smo_Status", "TEU_Alc_WeeklyCat", "TEU_Pha_METsover1200",
          "TEU_FaH_CVD", "Prosp_comorb_numcat", "TEU_VeI_numHTNmedscat", "TEU_LDL_Quintiles",
          "TEU_TownsendDepInd_Quint", "TEU_HouseholdIncome", "TEU_Emp_category", "TEU_Edu_ISCED", "TEU_Rec_Country",
          "GeP_PC_1", "GeP_PC_2", "GeP_PC_3", "GeP_PC_4", "GeP_Array"
          )

varlist_b <- c("TEU_BaC_AgeCat", "BaC_Sex", "TEU_SBP_PRS_quintiles", "TEU_BlP_SBP_quintiles", 
          "TEU_BSM_BMIcat", "TEU_Smo_Status", "TEU_Alc_WeeklyCat", "TEU_Pha_METsover1200",
          "TEU_FaH_CVD", "Prosp_comorb_numcat", "TEU_VeI_numHTNmedscat", "TEU_LDL_Quintiles",
          "TEU_TownsendDepInd_Quint", "TEU_HouseholdIncome", "TEU_Emp_category", "TEU_Edu_ISCED", "TEU_Rec_Country",
          "GeP_PC_1", "GeP_PC_2", "GeP_PC_3", "GeP_PC_4", "GeP_Array"
          )

```

## Cox regression of time until MACE event (`r nrow(data[data$TEU_MACE_status==1,])` events)

MI event defined as diagnosis of MACE event or MACE prevention procedure in HES data, or MACE recorded as primary cause of death.

```{r Cox model mace, echo=FALSE}

status <- "TEU_MACE_status"

```

```{r, cox-output, eval=TRUE}

# Model A
formula_a <- paste0("Surv(TEU_MACE_time_yrs,", status, ") ~ ", paste(varlist_a, collapse="+"))
rmodel_a <- with(comp_long1, coxph(as.formula(formula_a)))

routput_a <- printMIresults(df=comp_long1$data, varlist=varlist_b, modeloutput=summary(pool(rmodel_a)),
                            pretty_names=pretty_names, onecol=FALSE, IDcol=TRUE)

# Model B
formula_b <- paste0("Surv(TEU_MACE_time_yrs,", status, ") ~ ", paste(varlist_b, collapse="+"))
rmodel_b <- with(comp_long1, coxph(as.formula(formula_b)))

routput_b <- printMIresults(df=comp_long1$data, varlist=varlist_b, modeloutput=summary(pool(rmodel_b)),
                            pretty_names=pretty_names, onecol=FALSE, IDcol=TRUE)

# Combine into one table
tab4 <- left_join(routput_a, routput_b, by=c("IDcol", "Coefficient", "Levels")) %>%
  select(-IDcol) %>%
  replace(., is.na(.), "")

rownames(tab4) <- NULL
tab4 <- rbind(c("Coefficient", "Level", "HR", "95% CI", "p", "HR", "95% CI", "p"),
              as.matrix(tab4))
colnames(tab4) <- c("", "",
                    "Model A", "", "", 
                    "Model B", "", "")

kable(tab4)

```

```{r, SBP_pval}

anova_a <- with(comp_long1, 
                coxph(as.formula(paste0("Surv(TEU_MACE_time_yrs,", status, ") ~ ",
                                        paste(varlist_a[-which(varlist_a=="TEU_SBP_PRS_quintiles")], collapse="+")))))
anova_b <- with(comp_long1, 
                coxph(as.formula(paste0("Surv(TEU_MACE_time_yrs,", status, ") ~ ",
                                        paste(varlist_b[-which(varlist_b=="TEU_SBP_PRS_quintiles")], collapse="+")))))

LRT_a <- anova(rmodel_a, anova_a, method='D2', use='likelihood')
LRT_b <- anova(rmodel_b, anova_b, method='D2', use='likelihood')

SBP_p_a <- LRT_a$out$`1 ~~ 2`$result[4] 
SBP_p_b <- LRT_b$out$`1 ~~ 2`$result[4]

```

### Overall p-value of SBP PRS

* Model A: Based on likelihood ratio test, inclusion of SBP PRS `r if(SBP_p_a < 0.05){"**does**"}else{"does **not**"}` provide significant improvement in model fit (p = `r pretty_pval(SBP_p_a)`).
* Model B: Based on likelihood ratio test, inclusion of SBP PRS `r if(SBP_p_b < 0.05){"**does**"}else{"does **not**"}` provide significant improvement in model fit (p = `r pretty_pval(SBP_p_b)`).


```{r model-checks,echo=FALSE,eval=live}
# Model 1: Multivariable model (without baseline LDL)
pha_plots<-list() #save PHA plot for each imputation
vifs<-list() #save multicollinearity results

for (i in 1:comp_long1$m) {
  ## 1. PHA
  pha_plots[[i]]<-ggcoxzph(cox.zph(rmodel_a$analyses[[i]]))
  
  ## 2. Multicollinearity
  
  vifs[[i]]<-rms::vif(cph(as.formula(formula_a),data=complete(comp_long1,i)))
  cat("Imputation",i,", Any VIF above>10:",any(vifs[[i]]>10),'\n')
  
}

# Use shinyapp for better visualisation

choices = 1:comp_long1$m

names(choices) <- paste("Imputation",1:comp_long1$m)
shinyApp(
  ui = fluidPage(
    titlePanel("PHA plot on each imputation"),
    sidebarPanel(
      selectInput("plot", "Choose plot:", choices=choices),
      hr()),
      #helpText("Trail plots")),
    plotOutput("mainplot")
  ),
  server = function(input, output) {
    output$mainplot<-renderPlot({
      i<- as.integer(input$plot)
      pha_plots[[i]]
    }, height = 1000, width = 2000)
  }
)


# Model 2: Multivariable model (With baseline LDL)

pha_plots2<-list() #save PHA plot for each imputation
vifs2<-list() #save multicollinearity results

for (i in 1:comp_long1$m) {
  ## 1. PHA
  pha_plots2[[i]]<-ggcoxzph(cox.zph(rmodel_b$analyses[[i]]))
  
  ## 2. Multicollinearity
  
  vifs2[[i]]<-rms::vif(cph(as.formula(formula_b),data=complete(comp_long1,i)))
  cat("Imputation",i,", Any VIF above>10:",any(vifs2[[i]]>10),'\n')
  
}

# Use shinyapp for better visualisation

choices = 1:comp_long1$m

names(choices) <- paste("Imputation",1:comp_long1$m)
shinyApp(
  ui = fluidPage(
    titlePanel("PHA plot on each imputation"),
    sidebarPanel(
      selectInput("plot", "Choose plot:", choices=choices),
      hr()),
    #helpText("Trail plots")),
    plotOutput("mainplot")
  ),
  server = function(input, output) {
    output$mainplot<-renderPlot({
      i<- as.integer(input$plot)
      pha_plots2[[i]]
    }, height = 1000, width = 2000)
  }
)


```

### Model Checking (for both Model A and B on each imputed dataset):

*	Proportional hazard assumption (PHA): Assessed by plotting Schoenfeld residuals against time and testing the significance of relationship between residuals and time. Schoenfeld residuals plots indicated no evidence of PHA violation.
*	Multicollinearity: Assessed via ‘rms’ R package and VIFs across all covariates were below 10. No multicollinearity detected.

## Cox regression of time until MI event (`r nrow(data[data$TEU_MACE_MI==1,])` events)

MI event defined as diagnosis of myocardial infarction or MI prevention procedure in HES data, or MI recorded as primary cause of death (censoring at first MACE event applied)

```{r Cox model MI, echo=FALSE}

status <- "TEU_MACE_MI"

<<cox-output>>

```

```{r, echo=FALSE}

<<SBP_pval>>

```

### Overall p-value of SBP PRS

* Model A: Based on likelihood ratio test, inclusion of SBP PRS `r if(SBP_p_a < 0.05){"**does**"}else{"does **not**"}` provide significant improvement in model fit (p = `r pretty_pval(SBP_p_a)`).
* Model B: Based on likelihood ratio test, inclusion of SBP PRS `r if(SBP_p_b < 0.05){"**does**"}else{"does **not**"}` provide significant improvement in model fit (p = `r pretty_pval(SBP_p_b)`).

### Model Checking (for both Model A and B on each imputed dataset):

*	Proportional hazard assumption (PHA): Assessed by plotting Schoenfeld residuals against time and testing the significance of relationship between residuals and time. Schoenfeld residuals plots indicated no evidence of PHA violation.
*	Multicollinearity: Assessed via ‘rms’ R package and VIFs across all covariates were below 10. No multicollinearity detected.

## Cox regression of the time until stroke event (`r nrow(data[data$TEU_MACE_Stroke==1,])` events)

Stroke event defined as diagnosis of stroke (any kind) or stroke prevention procedure in HES data, or stroke recorded as primary cause of death (censoring at first MACE event applied).

```{r Cox model stroke, echo=FALSE}

status <- "TEU_MACE_Stroke"

<<cox-output>>

```

```{r, echo=FALSE}

<<SBP_pval>>

```

### Overall p-value of SBP PRS

* Model A: Based on likelihood ratio test, inclusion of SBP PRS `r if(SBP_p_a < 0.05){"**does**"}else{"does **not**"}` provide significant improvement in model fit (p = `r pretty_pval(SBP_p_a)`).
* Model B: Based on likelihood ratio test, inclusion of SBP PRS `r if(SBP_p_b < 0.05){"**does**"}else{"does **not**"}` provide significant improvement in model fit (p = `r pretty_pval(SBP_p_b)`).

### Model Checking (for both Model A and B on each imputed dataset):

*	Proportional hazard assumption (PHA): Assessed by plotting Schoenfeld residuals against time and testing the significance of relationship between residuals and time. Schoenfeld residuals plots indicated no evidence of PHA violation.
*	Multicollinearity: Assessed via ‘rms’ R package and VIFs across all covariates were below 10. No multicollinearity detected.
