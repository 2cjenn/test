---
title: "HTN PRS MACE prospective"
author:  "Jennifer Collister"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  word_document:
      reference_docx: "K:/TEU/TEU_Guides/TEU_DocStyle_Rmd_2020.dotx"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include=TRUE, echo=FALSE)

library(kableExtra)
library(knitr)
library(yaml)
library(here)
library(DiagrammeR)
library(DiagrammeRsvg)
library(svglite)
library(rsvg)
library(png)
library(dplyr)
library(ggplot2)
library(survival)
library(survminer)
library(rms)
library(shiny)
library(rcompanion)
library(Publish)
library(gridExtra)

# Specify the markdown format for knitr tables, otherwise they're not compatible with kableExtra
options(knitr.kable.NA='', knitr.table.format = "markdown")
options(kableExtra.auto_format = FALSE)
# Set the root directory to the project directory (otherwise knitr works in the directory of the Rmd file by default)
knitr::opts_knit$set(root.dir = here::here())
knitr::opts_chunk$set(include=TRUE, echo=FALSE)

# Load the project config file for filepaths etc
config = yaml.load_file(here::here("./config.yml"))
source(here::here(config$functions$JC))

#-------------------------------------------------------------------------------------------------------------------
# Setup

figure <- 1
table <- 1
suppfig <- 1
footnote_no <- 1

# Check if the session is being knitted or run interactively
# When we're knitting the documentation, we don't want to include the diagnostic checks
live <- interactive()

```

```{r data-derivation, include=FALSE, cache=TRUE}
 
source(file.path(config$scripts$cleaning, "dataset_generator.R"))

exclusions <- function(data){
  
  excl$initial <<- nrow(data)
  
  # Exclude those outside the 40-70 age range
  data <- data[data$TEU_BaC_AgeAtRec >= 40 & data$TEU_BaC_AgeAtRec < 70,]
  
  excl$agerange <<- nrow(data)

  # Exclude individuals with missing BP data
  # or missing answers to BP questions on touchscreen questionnaire
  data <- data[!is.na(data$TEU_BlP_SBP.avg),]
  data <- data[!is.na(data$TEU_BlP_DBP.avg),]
  data <- data[data$TEU_HMH_prevHTN != "Unanswered",]
  data <- data[data$TEU_HMH_Meds_BP != "Unanswered",]
  # Exclude participants who only had BP measured once
  data <- data[data$TEU_BlP_nSBP == 2 & data$TEU_BlP_nDBP == 2,]
  
  excl$BPmiss <<- nrow(data)

  # Exclude individuals with implausible BP data
  data <- data[data$TEU_BlP_SBP.avg >= 70 & data$TEU_BlP_SBP.avg <= 270,]
  data <- data[data$TEU_BlP_DBP.avg >= 50 & data$TEU_BlP_DBP.avg <= 150,]
  
  excl$BPimp <<- nrow(data)
  
  # Only keep those with genetic data
  data <- data[!is.na(data$TEU_BP_PRS),]
  
  excl$PRSmiss <<- nrow(data)

  # Exclude pregnant women ("Yes" or "Unsure")
  data <- data[is.na(data$VeI_PregnantNow) | data$VeI_PregnantNow == "No",]
  
  excl$pregnant <<- nrow(data)

  # Exclude individuals who have serious health conditions
  data <- data[is.na(data$TEU_VeI_seriouscomb),]

  # And individuals with cancer (except for skin cancer?)
  data <- data[is.na(data$TEU_VeI_cancer),]
  
  excl$seriouscomorb <<- nrow(data)
  
  # Any durations less than 0 are clearly errors (only 2)
  # Any diagnoses before the age of about 20 are probably due to other causes
  data$TEU_VeI_HTN_dur[data$TEU_VeI_HTN_dur < 0] <- NA
  # data[data$TEU_VeI_HTN_dur > data$TEU_BaC_AgeAtRec-20,]
  
  # Exclude those who were not hypertensive
  data <- data[data$TEU_evidenceHTN == TRUE & !is.na(data$TEU_evidenceHTN),]
  
  excl$evidenceHTN <<- nrow(data)
  
  # Exclude those who were not aware
  data <- data[data$TEU_awareHTN == TRUE & !is.na(data$TEU_awareHTN),]
  
  excl$aware <<- nrow(data)
  
  # Only interested in treated hypertensives
  data <- data[data$TEU_treatedHTN == TRUE & !is.na(data$TEU_treatedHTN),]
  
  excl$treated <<- nrow(data)
  
  # Exclude MACE at baseline
  data <- data[!data$TEU_MACE_prev=="Yes",]
  
  excl$MACE <<- nrow(data)
  
  # Restrict to genetically white British
  data <- data[!is.na(data$GeP_ethnic),]
  
  excl$whiteBrit <<- nrow(data)
  
  return(data) 
}

excl <- list(initial=0)

data <-
  evalWithMemoization(
    derive_variables(
      database = "K:/TEU/UKB33952_Data/Data_Downloads/V3_database_duckdb0.2.1/ukb_v3.db",
      field_definitions = TEU_SPECS$HTN_control_MACE,
      exclusions = exclusions
    ),
    key = c(TEU_SPECS$HTN_control_MACE, exclusions)
  )

pretty_func <- pretty_switch(field_definitions=TEU_SPECS$HTN_control_MACE, return_type = "function")
pretty_names <- pretty_switch(field_definitions=TEU_SPECS$HTN_control_MACE, return_type = "list")

export_svg(DiagrammeR::grViz(here::here(file.path(config$outputs$flowcharts, "HTN_PRS_MACE.gv")))
           ) %>% charToRaw %>% rsvg %>% 
  png::writePNG(here::here(file.path(config$outputs$figures, "HTN_PRS_MACE.png")))


```

```{r}
# Temporary fix:

levels(data$TEU_TownsendDepInd_Quint) <- c(levels(data$TEU_TownsendDepInd_Quint), "Unavailable")
data$TEU_TownsendDepInd_Quint[is.na(data$TEU_TownsendDepInd_Quint)] <- "Unavailable"

```


# Hypertension PRS cross-sectional analysis

## Table `r table`. Characteristics of participants included in the analysis, by Systolic BP PRS quintile (treated hypertensives, n = `r nrow(data)`).
`r table <- table + 1`

```{r descriptive-table, include=TRUE, echo=FALSE}
varlist=c("TEU_BaC_AgeAtRec", "TEU_BaC_AgeCat", "BaC_Sex", "TEU_BlP_SBP_quintiles",
          "TEU_BSM_BMIcat", "TEU_Smo_Status", "TEU_Alc_WeeklyCat", "TEU_Pha_METsover1200",
          "TEU_FaH_CVD", "Prosp_comorb_numcat", "TEU_VeI_numHTNmedscat", "TEU_LDL_Quintiles",
          "TEU_TownsendDepInd_Quint", "TEU_HouseholdIncome", "TEU_Emp_category", "TEU_Edu_ISCED", "TEU_Rec_Country"
          )

tab_all <- descriptivetable(df=data, 
                         varlist=varlist,
                         contavg='median',
                         pretty_names=pretty_names)

tab_1 <- descriptivetable(df=data[data$TEU_SBP_PRS_quintiles=="Q1: lowest",], 
                         varlist=varlist,
                         contavg='median',
                         pretty_names=pretty_names)

tab_3 <- descriptivetable(df=data[data$TEU_SBP_PRS_quintiles=="Q3",], 
                         varlist=varlist,
                         contavg='median',
                         pretty_names=pretty_names)

tab_5 <- descriptivetable(df=data[data$TEU_SBP_PRS_quintiles=="Q5: highest",], 
                         varlist=varlist,
                         contavg='median',
                         pretty_names=pretty_names)

tab <- inner_join(tab_all, tab_1%>%select(-Variable), by="IDcol")
tab <- inner_join(tab, tab_3%>%select(-Variable), by="IDcol")
tab <- inner_join(tab, tab_5%>%select(-Variable), by="IDcol")

rownames(tab) <- NULL
tab <- rbind(c("", "Variable", "n", "%", "n", "%", "n", "%", "n", "%"),
              as.matrix(tab))
colnames(tab) <- c("", "", "Overall", "", "Q1: lowest", "", "Q3", "", "Q5: highest", "")

# Output the resulting table
kable(tab[,-1])

```

## Table `r table`: Multivariable logistic regression identifying factors associated with hypertension control, among middle-aged UK adults on anti-hypertensive treatment (n=`r nrow(data)`)
`r table <- table + 1`

```{r logistic-regression, include=TRUE, echo=FALSE}

varlist=c("TEU_BaC_AgeCat", "BaC_Sex", "TEU_SBP_PRS_quintiles",
          "TEU_BSM_BMIcat", "TEU_Smo_Status", "TEU_Alc_WeeklyCat", "TEU_Pha_METsover1200",
          "TEU_FaH_CVD", "Prosp_comorb_numcat", "TEU_VeI_numHTNmedscat", "TEU_LDL_Quintiles",
          "TEU_TownsendDepInd_Quint", "TEU_HouseholdIncome", "TEU_Emp_category", "TEU_Edu_ISCED", "TEU_Rec_Country",
          "GeP_PC_1", "GeP_PC_2", "GeP_PC_3", "GeP_PC_4"
          )

desctable2 <- function(df){
  n <- nrow(df)
  control <- prop.test(x=nrow(df[df$TEU_controlledHTN==TRUE & !is.na(df$TEU_controlledHTN),]),
                           n=nrow(df), alternative="two.sided", conf.level=0.95)
  pct_control <- pretty_dp(control$estimate, dp=1, pct=TRUE)
  
  table <- cbind(n, pct_control)
  return(table)
}

pct_ctrl <- c()
for(var in varlist){
  header <- c(var, paste0("**", pretty_func(var), "**"), NA, NA)
  pct_ctrl <- rbind(pct_ctrl, header)
  for(level in levels(data[[var]])){
    newrow <- desctable2(data[data[var]==level,])
    IDcol <- paste0(var, level)
    pct_ctrl <- rbind(pct_ctrl, cbind(IDcol, level, newrow))
  }
}
pct_ctrl <- data.frame(pct_ctrl)

adj <- regressiontable(df=data, outcome="TEU_controlledHTN", varlist=varlist, 
                       regresstype="adjusted", adjvarlist=c("TEU_BaC_AgeCat", "BaC_Sex"))
multi <- regressiontable(df=data, outcome="TEU_controlledHTN", varlist=varlist, 
                         regresstype="multivariable")

tab3 <- merge(adj, multi, by=c("IDcol", "Coefficient", "Levels"), sort=FALSE) %>% select(-Coefficient, -Levels)
# Add n column

tab3 <- left_join(pct_ctrl, tab3, by=c("IDcol")) %>% select(-IDcol)

# Hide "unanswered"/"unknown"/"do not know" categories
# tab3 <- tab3[-which(tab3$level %in% c("Unknown", "Unanswered", "Do not know", "Prefer not to answer")),]
rownames(tab3) <- NULL

tab3 <- rbind(c("Coefficient", "n^1^", "% Controlled^2^", "OR", "95% CI", "p", "OR", "95% CI", "p"),
              as.matrix(tab3))
colnames(tab3) <- c("","","", 
                    "Age- and sex-adjusted", "", "", 
                    "Multivariable- adjusted", "", "")

# Output the resulting table
kable(tab3)

```

```{r cross-sectional Model Check,eval=FALSE,echo=FALSE}
## Assess model fit

formula <- as.formula(paste0("TEU_controlledHTN ~ ", paste(varlist, collapse="+")))
multi <- glm(formula=formula, data=data, family="binomial")


## 1. Hosmer-Lemeshow Test

HL <- hoslem.test(multi$y,fitted(multi),g=10)

# g is the number of groups into which to split the observations in the sample
# For g in 5 to 15, check Hosmer Lemeshow p-vals
HL_pvals=sapply(5:15,function(i) hoslem.test(multi$y, fitted(multi), g=i)$p.value)
sum(HL_pvals<0.05)

## 2. Multicollinearity
m2_vifs=data.frame(car::vif(multi))
m2_vifs$squared=(m2_vifs$GVIF..1..2.Df..)^2

# 3. p-value of including PRS in model


```

# Hypertension PRS prospective analysis

Including SBP PRS (quintiles), showing for each outcome:

* Model A: without measured SBP at baseline
* Model B: with measured SBP at baseline

```{r varlists for models}

varlist_a <- c("TEU_BaC_AgeCat", "BaC_Sex", "TEU_SBP_PRS_quintiles",
          "TEU_BSM_BMIcat", "TEU_Smo_Status", "TEU_Alc_WeeklyCat", "TEU_Pha_METsover1200",
          "TEU_FaH_CVD", "Prosp_comorb_numcat", "TEU_VeI_numHTNmedscat", "TEU_LDL_Quintiles",
          "TEU_TownsendDepInd_Quint", "TEU_HouseholdIncome", "TEU_Emp_category", "TEU_Edu_ISCED", "TEU_Rec_Country",
          "GeP_PC_1", "GeP_PC_2", "GeP_PC_3", "GeP_PC_4"
          )
anova_a <- varlist_a[-which(varlist_a=="TEU_SBP_PRS_quintiles")]


varlist_b <- c("TEU_BaC_AgeCat", "BaC_Sex", "TEU_SBP_PRS_quintiles", "TEU_BlP_SBP_quintiles", 
          "TEU_BSM_BMIcat", "TEU_Smo_Status", "TEU_Alc_WeeklyCat", "TEU_Pha_METsover1200",
          "TEU_FaH_CVD", "Prosp_comorb_numcat", "TEU_VeI_numHTNmedscat", "TEU_LDL_Quintiles",
          "TEU_TownsendDepInd_Quint", "TEU_HouseholdIncome", "TEU_Emp_category", "TEU_Edu_ISCED", "TEU_Rec_Country",
          "GeP_PC_1", "GeP_PC_2", "GeP_PC_3", "GeP_PC_4"
          )
anova_b <- varlist_b[-which(varlist_b=="TEU_SBP_PRS_quintiles")]

```

## Cox regression of time until MACE event (`r nrow(data[data$TEU_MACE_status==1,])` events)

MI event defined as diagnosis of MACE event or MACE prevention procedure in HES data, or MACE recorded as primary cause of death.

```{r Cox model mace, echo=FALSE}

formula_a <- as.formula(paste0("Surv(TEU_MACE_time_yrs,TEU_MACE_status) ~ ", paste(varlist_a, collapse="+")))
formula_b <- as.formula(paste0("Surv(TEU_MACE_time_yrs,TEU_MACE_status) ~ ", paste(varlist_b, collapse="+")))

```

```{r, cox-output, eval=TRUE}

rmodel_a <- coxph(formula_a, data=data)

routput_a <- printcoxresults(df=data, varlist=varlist_b, modeloutput=rmodel_a,
                            pretty_names=pretty_names, onecol=FALSE, IDcol=TRUE)
routput_a$HR[grepl("TEU_BlP_SBP_quintiles", routput_a$IDcol, fixed=TRUE)] <- NA

rmodel_b <- coxph(formula_b, data=data)

routput_b <- printcoxresults(df=data, varlist=varlist_b, modeloutput=rmodel_b,
                            pretty_names=pretty_names, onecol=FALSE, IDcol=TRUE)


tab4 <- left_join(routput_a, routput_b, by=c("IDcol", "Coefficient", "Levels")) %>%
  select(-IDcol) %>%
  replace(., is.na(.), "")

rownames(tab4) <- NULL
tab4 <- rbind(c("Coefficient", "Level", "OR", "95% CI", "p", "OR", "95% CI", "p"),
              as.matrix(tab4))
colnames(tab4) <- c("", "",
                    "Model A", "", "", 
                    "Model B", "", "")

kable(tab4)

```

```{r, model-checks, echo=FALSE}

# Model 1 Model check

## 1. PHA 
ggsave("ggcoxzph.pdf", arrangeGrob(grobs = ggcoxzph(cox.zph(rmodel_a))), width=20, height=14, limitsize = FALSE)
ggsave("ggcoxzph.pdf", arrangeGrob(grobs = ggcoxzph(cox.zph(rmodel_b))), width=20, height=14, limitsize = FALSE)

## 2. Multicollinearity
# VIF

# Model 1
vif_a <- rms::vif(cph(formula_a,data=data))
max_a <- max(vif_a)
var_a <- names(vif_a)[which(vif_a == max(vif_a))]

# Model 2 
vif_b <- rms::vif(cph(formula_b, data=data))
max_b <- max(vif_b)
var_b <- names(vif_b)[which(vif_b == max(vif_b))]

if(max_a > max_b){
  maxvif <- max_a
  varvif <- var_a
} else {
  maxvif <- max_b
  varvif <- var_b
}
prettyvif <- strsplit(varvif, "=")[[1]]

# Check correlation among covariates 
corr <- data%>%select(any_of(varlist_b))%>%select(!starts_with("GeP_PC"))
corr_matrix <- corr_mat(corr)
# Find covariates with highest correlation
inds <- which(corr_matrix==max(corr_matrix), arr.ind=TRUE)
maxrow <- pretty_func(rownames(corr_matrix)[inds[1,1]])
maxcol <- pretty_func(colnames(corr_matrix)[inds[1,2]])

```

### Model checks:

**Proportional hazards assumption**: Visual inspection of the Schoenfeld residuals gave no evidence of PHA violation.

**Multicollinearity**: 
  - VIFs across all covariates `r if(maxvif<10){"were"}else{"were not"}` below 10. The highest VIF was `r maxvif`, from level *`r prettyvif[2]`* of *`r pretty_func(prettyvif[1])`*. 
  - The highest correlation between any pair of variables in the model was `r max(corr_matrix)`, between *`r maxrow`* and *`r maxcol`*.

## Cox regression of time until MI event (`r nrow(data[data$TEU_MACE_MI==1,])` events)

MI event defined as diagnosis of myocardial infarction or MI prevention procedure in HES data, or MI recorded as primary cause of death (censoring at first MACE event applied)

```{r Cox model MI, echo=FALSE}

formula_a <- as.formula(paste0("Surv(TEU_MACE_time_yrs,TEU_MACE_MI) ~ ", paste(varlist_a, collapse="+")))
formula_b <- as.formula(paste0("Surv(TEU_MACE_time_yrs,TEU_MACE_MI) ~ ", paste(varlist_b, collapse="+")))

<<cox-output>>

```

```{r, echo=FALSE}

<<model-checks>>

```

### Model checks:

**Proportional hazards assumption**: Visual inspection of the Schoenfeld residuals gave no evidence of PHA violation.

**Multicollinearity**: 
  - VIFs across all covariates `r if(maxvif<10){"were"}else{"were not"}` below 10. The highest VIF was `r maxvif`, from level *`r prettyvif[2]`* of *`r pretty_func(prettyvif[1])`*. 
  - The highest correlation between any pair of variables in the model was `r max(corr_matrix)`, between *`r maxrow`* and *`r maxcol`*.

## Cox regression of the time until stroke event (`r nrow(data[data$TEU_MACE_Stroke==1,])` events)

Stroke event defined as diagnosis of stroke (any kind) or stroke prevention procedure in HES data, or stroke recorded as primary cause of death (censoring at first MACE event applied).

```{r Cox model stroke, echo=FALSE}

formula_a <- as.formula(paste0("Surv(TEU_MACE_time_yrs,TEU_MACE_Stroke) ~ ", paste(varlist_a, collapse="+")))
formula_b <- as.formula(paste0("Surv(TEU_MACE_time_yrs,TEU_MACE_Stroke) ~ ", paste(varlist_b, collapse="+")))

<<cox-output>>

```

```{r, echo=FALSE}

<<model-checks>>

```

### Model checks:

**Proportional hazards assumption**: Visual inspection of the Schoenfeld residuals gave no evidence of PHA violation.

**Multicollinearity**: 
  - VIFs across all covariates `r if(maxvif<10){"were"}else{"were not"}` below 10. The highest VIF was `r maxvif`, from level *`r prettyvif[2]`* of *`r pretty_func(prettyvif[1])`*. 
  - The highest correlation between any pair of variables in the model was `r max(corr_matrix)`, between *`r maxrow`* and *`r maxcol`*.
