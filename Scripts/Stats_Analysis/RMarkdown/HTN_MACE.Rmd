---
title: "HTN Prospective"
author: "Jennifer Collister (JC)"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  word_document:
      reference_docx: "K:/TEU/TEU_Guides/TEU_DocStyle_Rmd_2020.dotx"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include=TRUE, echo=FALSE)

library(kableExtra)
library(knitr)
library(yaml)
library(here)
library(Publish)
library(DiagrammeR)
library(DiagrammeRsvg)
library(magrittr)
library(svglite)
library(rsvg)
library(png)
library(dplyr)
library(ggplot2)


# Specify the markdown format for knitr tables, otherwise they're not compatible with kableExtra
options(knitr.kable.NA='', knitr.table.format = "markdown")
options(kableExtra.auto_format = FALSE)
# Set the root directory to the project directory (otherwise knitr works in the directory of the Rmd file by default)
knitr::opts_knit$set(root.dir = here::here())
knitr::opts_chunk$set(include=TRUE, echo=FALSE)

# Load the project config file for filepaths etc
config = yaml.load_file(here::here("./config.yml"))
source(here::here(config$functions))

#-------------------------------------------------------------------------------------------------------------------
# Setup

figure <- 1
table <- 1
suppfig <- 1
footnote_no <- 1

```

```{r, include=FALSE, cache=TRUE}

source(file.path(config$scripts$cleaning, "dataset_generator.R"))

exclusions <- function(data){
  
  excl$initial <<- nrow(data)
  
  # Exclude those outside the 40-70 age range
  data <- data[data$TEU_BaC_AgeAtRec >= 40 & data$TEU_BaC_AgeAtRec < 70,]
  
  excl$agerange <<- nrow(data)

  # Exclude individuals with missing BP data
  # or missing answers to BP questions on touchscreen questionnaire
  data <- data[!is.na(data$TEU_BlP_SBP.avg),]
  data <- data[!is.na(data$TEU_BlP_DBP.avg),]
  data <- data[data$TEU_HMH_prevHTN != "Unanswered",]
  data <- data[data$TEU_HMH_Meds_BP != "Unanswered",]
  # Exclude participants who only had BP measured once
  data <- data[data$TEU_BlP_nSBP == 2 & data$TEU_BlP_nDBP == 2,]
  
  excl$BPmiss <<- nrow(data)

  # Exclude individuals with implausible BP data
  data <- data[data$TEU_BlP_SBP.avg >= 70 & data$TEU_BlP_SBP.avg <= 270,]
  data <- data[data$TEU_BlP_DBP.avg >= 50 & data$TEU_BlP_DBP.avg <= 150,]
  
  excl$BPimp <<- nrow(data)
  
  # Only keep those with genetic data
  data <- data[!is.na(data$TEU_BP_PRS),]
  
  excl$PRSmiss <<- nrow(data)

  # Exclude pregnant women ("Yes" or "Unsure")
  data <- data[is.na(data$VeI_PregnantNow) | data$VeI_PregnantNow == "No",]
  
  excl$pregnant <<- nrow(data)

  # Exclude individuals who have serious health conditions
  data <- data[is.na(data$TEU_VeI_seriouscomb),]

  # And individuals with cancer (except for skin cancer?)
  data <- data[is.na(data$TEU_VeI_cancer),]
  
  excl$seriouscomorb <<- nrow(data)
  
  # Any durations less than 0 are clearly errors (only 2)
  # Any diagnoses before the age of about 20 are probably due to other causes
  data$TEU_VeI_HTN_dur[data$TEU_VeI_HTN_dur < 0] <- NA
  # data[data$TEU_VeI_HTN_dur > data$TEU_BaC_AgeAtRec-20,]
  
  # Exclude those who were not hypertensive
  data <- data[data$TEU_evidenceHTN == TRUE & !is.na(data$TEU_evidenceHTN),]
  
  excl$evidenceHTN <<- nrow(data)
  
  # Exclude those who were not aware
  data <- data[data$TEU_awareHTN == TRUE & !is.na(data$TEU_awareHTN),]
  
  excl$aware <<- nrow(data)
  
  # Only interested in treated hypertensives
  data <- data[data$TEU_treatedHTN == TRUE & !is.na(data$TEU_treatedHTN),]
  
  excl$treated <<- nrow(data)
  
  # Exclude MACE at baseline
  data <- data[!data$TEU_MACE_prev=="Yes",]
  
  excl$MACE <<- nrow(data)
  
  # Restrict to genetically white British
  data <- data[!is.na(data$GeP_ethnic),]
  
  excl$whiteBrit <<- nrow(data)
  
  return(data)
}

excl <- list(initial=0)

data <-
  evalWithMemoization(
    derive_variables(
      database = "K:/TEU/UKB33952_Data/Data_Downloads/V3_database_duckdb0.2.1/ukb_v3.db",
      field_definitions = TEU_SPECS$HTN_control_MACE,
      exclusions = exclusions
    ),
    key = c(TEU_SPECS$HTN_control_MACE, exclusions)
  )

pretty_names <- pretty_switch(field_definitions=TEU_SPECS$HTN_control_MACE)

export_svg(DiagrammeR::grViz(here::here(file.path(config$outputs$flowcharts, "HTN_PRS_MACE.gv")))
           ) %>% charToRaw %>% rsvg %>% 
  png::writePNG(here::here(file.path(config$outputs$figures, "HTN_PRS_MACE.png")))


```


# Figure `r figure`. Flowchart illustrating selection of analytic dataset (n = `r nrow(data)`).
`r figure <- figure + 1`
![Missing BP data was fewer than 2 BP measurements, or missing answers to the prior diagnosis and treatment questions. Hypertension was defined as self-report of hypertensive medication use, or self-report of a prior diagnosis of hypertension, or mean BP >= 140 /90 mmHg at baseline assessment. Awareness was defined as self-report of a prior diagnosis of hypertension among those who were hypertensive. Treatment was defined as self-report of hypertensive medication among those who were aware. Control was defined as mean BP < 140/90 mmHg at baseline assessment, among those who were treated.](Figures/HTN_PRS_MACE.png){height=700px}

# MACE outcome

Primary outcome is MACE composite outcome at follow-up. MACE is defined as a composite of the following:

* Non-fatal Myocardial Infraction (MI)
* MI prevention procedure
* Non-fatal Stroke
* Stroke prevention procedure
* Cardiovascular Death

## Note final MACE definition is still pending so all results below are preliminary!

```{r MACE incidence,echo=FALSE}

MACE_n=table(data$TEU_MACE_status)[2]
Censored_n=table(data$TEU_MACE_status)[1]

# Total number of incidence
MACE_tab=propped(table(data$TEU_MACE_status))

# Median Follow-up (MACE cases)
MACE_fu=data%>%filter(TEU_MACE_status==1)%>%summarise(median=median(TEU_MACE_time_yrs),IQR=IQR(TEU_MACE_time_yrs))

# Incidence rate whole analysis pop
MACE_inc<-round((sum(data$TEU_MACE_status)/sum(data$TEU_MACE_time_yrs))*1000,2)

```

**Among our analysis population of `r nrow(data)` participants, we identified `r MACE_tab[2]` incident MACE events.**

# Table `r table`. Incidence rates per 1000 person-years by BP PRS quintile group

```{r}

# Incidence rate per PRS quintile group
MACE_inc_byPRS=data%>%
  group_by(TEU_BP_PRS_quintiles)%>%
  summarise(`Incidence Rate`=round((sum(TEU_MACE_status)/sum(TEU_MACE_time_yrs))*1000,2))%>%
  rename(`PRS quintiles`=TEU_BP_PRS_quintiles)

kable(MACE_inc_byPRS)

```

# Descriptive stats of the population

## Preliminary results pending final definitions

```{r}

varlist=c("TEU_BaC_AgeCat", "BaC_Sex",
          "TEU_BSM_BMIcat", "TEU_Smo_Status", "TEU_Alc_WeeklyAlcUnits", "TEU_Pha_METsover1200",
          "TEU_FaH_CVD", "HTN_comorb_num", "TEU_VeI_numHTNmedscat",
          "TEU_TownsendDepInd_Quint", "TEU_HoH_PreTaxInc", "TEU_Emp_category", "TEU_Edu_ISCED", "TEU_Rec_Country"
          )
pnames <- lapply(varlist, pretty_names)
names(pnames) <- varlist

tab1 <- descriptivetable(df=data, 
                         varlist=varlist,
                         contavg='median',
                         pretty_names=pnames)

kable(tab1%>%select(-IDcol))

```

