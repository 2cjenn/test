---
title: "HTN PRS MACE SA4"
author:  "Jennifer Collister"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  word_document:
      reference_docx: "K:/TEU/TEU_Guides/TEU_DocStyle_Rmd_2020.dotx"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include=TRUE, echo=FALSE)

library(kableExtra)
library(knitr)
library(yaml)
library(here)
library(glue)
library(DiagrammeR)
library(DiagrammeRsvg)
library(svglite)
library(rsvg)
library(png)
library(dplyr)
library(ggplot2)
library(survival)
library(survminer)
library(rms)
library(shiny)
library(rcompanion)
library(Publish)
library(gridExtra)
library(ResourceSelection)
library(naniar)
library(mice)
library(gtools)
library(epitools)
library(tools)
library(readr)
library(tibble)
library(tidyr)
library(ggeffects)

# Specify the markdown format for knitr tables, otherwise they're not compatible with kableExtra
options(knitr.kable.NA='', knitr.table.format = "markdown")
options(kableExtra.auto_format = FALSE)
# Set the root directory to the project directory (otherwise knitr works in the directory of the Rmd file by default)
knitr::opts_knit$set(root.dir = here::here())
knitr::opts_chunk$set(include=TRUE, echo=FALSE)

# Load the project config file for filepaths etc
config = yaml.load_file(here::here("./config.yml"))
source(here::here(config$functions$JC))

#-------------------------------------------------------------------------------------------------------------------
# Setup

figure <- 1
table <- 1
suppfig <- 1
footnote_no <- 1

# Check if the session is being knitted or run interactively
# When we're knitting the documentation, we don't want to include the diagnostic checks
live <- interactive()

```

```{r data-derivation, include=FALSE, cache=TRUE}

source(file.path(config$scripts$cleaning, "dataset_generator.R"))
 
exclusions <- function(data){
  
  excl$initial <<- nrow(data)
    
  # Exclude those outside the 40-70 age range
  data <- data[data$TEU_BaC_AgeAtRec >= 40 & data$TEU_BaC_AgeAtRec < 70,]
  
  excl$agerange <<- nrow(data)
  
  # Only keep those with genetic data
  data <- data[!is.na(data$GeP_Array),]
  
  excl$genetic <<- nrow(data)
  
  # Restrict to genetically white British
  data <- data[!is.na(data$GeP_ethnic),]
  
  excl$whiteBrit <<- nrow(data)

  # Exclude individuals with missing BP data
  data <- data[!is.na(data$TEU_BlP_SBP.avg),]
  data <- data[!is.na(data$TEU_BlP_DBP.avg),]
  
  # or missing answers to BP questions on touchscreen questionnaire
  # data <- data[data$TEU_HMH_prevHTN != "Unanswered",]
  # data <- data[data$TEU_HMH_Meds_BP != "Unanswered",]
  
  # Exclude participants who only had BP measured once
  data <- data[data$TEU_BlP_nSBP == 2 & data$TEU_BlP_nDBP == 2,]
  
  excl$BPmiss <<- nrow(data)

  # Exclude individuals with implausible BP data
  data <- data[data$TEU_BlP_SBP.avg >= 70 & data$TEU_BlP_SBP.avg <= 270,]
  data <- data[data$TEU_BlP_DBP.avg >= 50 & data$TEU_BlP_DBP.avg <= 150,]
  
  excl$BPimp <<- nrow(data)
  
  # Only keep those who met genetic QC and were included in PRS
  data <- data[!is.na(data$TEU_SBP_PRS),]
  
  excl$PRSmiss <<- nrow(data)

  # Exclude pregnant women ("Yes" or "Unsure")
  data <- data[is.na(data$VeI_PregnantNow) | data$VeI_PregnantNow == "No",]
  
  excl$pregnant <<- nrow(data)

  # Exclude individuals who have serious health conditions
  data <- data[is.na(data$TEU_VeI_seriouscomb),]

  # And individuals with cancer (except for skin cancer?)
  data <- data[is.na(data$TEU_VeI_cancer),]
  
  excl$seriouscomorb <<- nrow(data)
  
  # Exclude MACE at baseline
  data <- data[!data$TEU_MACE_prev=="Yes",]
  
  excl$MACE <<- nrow(data)
  
  # Exclude those who were not hypertensive
  data <- data[data$TEU_evidenceHTN == TRUE & !is.na(data$TEU_evidenceHTN),]
  
  excl$evidenceHTN <<- nrow(data)
  
  # Exclude those who were not aware
  data <- data[data$TEU_awareHTN == TRUE & !is.na(data$TEU_awareHTN),]
  
  excl$aware <<- nrow(data)
  
  # Only interested in treated hypertensives
  data <- data[data$TEU_treatedHTN == TRUE & !is.na(data$TEU_treatedHTN),]
  
  excl$treated <<- nrow(data)
  
  return(data) 
}

excl <- list(initial=0)

data <-
  evalWithMemoization(
    derive_variables(
      database = "K:/TEU/UKB33952_Data/Data_Downloads/V3_database_duckdb0.2.1/ukb_v3.db",
      field_definitions = TEU_SPECS$HTN_control_MACE,
      exclusions = exclusions
    ),
    key = c(TEU_SPECS$HTN_control_MACE, exclusions)
  )

pretty_func <- pretty_switch(field_definitions=TEU_SPECS$HTN_control_MACE, return_type = "function")
pretty_names <- pretty_switch(field_definitions=TEU_SPECS$HTN_control_MACE, return_type = "list")


```

```{r}
label1 <- paste0('UKB participants\\nn = ', excl$initial)
label2 <- paste0('Genetically White British participants\\nwith genotyping data, aged between 40 and 70\\nn = ', excl$whiteBrit)
label3 <- paste0('Complete information on core variables\\nn = ', excl$PRSmiss)
label4 <- paste0('Without serious comorbidities\\nn = ', excl$seriouscomorb)
label5 <- paste0('No prior MACE events at baseline\\nn = ', excl$MACE)
label6 <- paste0('Study population: antihypertensive\nmedication users at baseline\\nn = ', excl$treated)

label7 <- paste0(excl$initial-excl$agerange,' outside the age range of [40,70) years\\l ', excl$agerange-excl$genetic, ' missing genotyping data\\l', excl$genetic-excl$whiteBrit, ' not of genetically White British ancestry\\l')
label8 <- paste0(excl$whiteBrit-excl$BPmiss,' missing BP data from baseline assessment\\l', excl$BPmiss-excl$BPimp, ' implausible BP data from baseline assessment\\l', excl$BPimp-excl$PRSmiss, ' excluded in genetic quality control\\l')
label9 <- paste0(excl$PRSmiss-excl$pregnant, ' possibly pregnant at baseline\\l', excl$pregnant-excl$seriouscomorb,' serious comorbidities, including cancer\\l(except skin cancer)\\l')
label10 <- paste0(excl$seriouscomorb-excl$MACE, ' prevalent MACE at baseline\\l')
label11 <- paste0(excl$MACE-excl$evidenceHTN, ' no evidence of hypertension\\l', excl$evidenceHTN-excl$aware, ' unaware hypertensives\\l', excl$aware-excl$treated, ' untreated hypertensives\\l')

gv <- read_file(here::here(file.path(config$outputs$flowcharts, "HTN_PRS_MACE.gv")))

export_svg(DiagrammeR::grViz(glue(gv))
           ) %>% charToRaw %>% rsvg %>%
  png::writePNG(here::here(file.path(config$outputs$figures, "HTN_PRS_MACE.png")))
```


```{r}

# Create Imputations (iter=10, M=10)
iter <- 10
M <- 10

# Using default imputation method based on variable type

if(live) {
  ini <- mice(MI_data,maxit = 0,print=FALSE)
  pred <- ini$predictorMatrix
  
  # Remove predictors: ID; TEU_MACE_MI; TEU_MACE_Stroke; TEU_Alc_WeeklyCat (want to use alc continuous variables instead)
  pred[,c("ID","TEU_MACE_MI","TEU_MACE_Stroke")] <- 0
  
  
  imp1<-mice(MI_data,pred=pred, m = M, maxit = iter,seed = 100)
  
  saveRDS(imp1,file=file.path(config$data$derived, paste0("imputation", format(Sys.time(), '%d%B%Y'), "_noCallRateHWE.rds")))
} else {
  imp1 <- readRDS(file.path(config$data$derived, "imputation19July2021_noCallRateHWE.rds"))
}
```


```{r}

# Post processing: Change continuous covariates to categorical for further analysis 

long1 <- complete(imp1,"long",include = TRUE) 

comp_long1<-long1%>%
  mutate(
    TEU_BaC_AgeCat=cut(TEU_BaC_AgeAtRec,
                       breaks = c(40, 50, 60, 70),
                       labels = c("40-49", "50-59", "60-69"),
                       right = FALSE
    ),
    
    TEU_BSM_BMIcat=factor(cut(BSM_BMI,
                       breaks = c(0, 18.5, 25, 30, 200),
                       c("Underweight", "Normal", "Overweight", "Obese"),
                       right = FALSE
    ),levels = c('Normal','Underweight','Overweight','Obese')),
    
    TEU_LDLctrl_v1=factor(ifelse(BBC_LDL_Result<3,1,0),levels=c(0,1), 
                          labels=c("Not controlled", "Controlled")),
    
    TEU_uncontrolledHTN=factor(ifelse(TEU_BlP_SBP.avg >= 140 | TEU_BlP_DBP.avg >= 90, 1, 0), 
                               levels=c(0, 1), labels=c("Controlled", "Uncontrolled")),
    
    TEU_Smo_Status=factor(TEU_Smo_Status,levels = c('Never','Previous','Current')),
    
    TEU_Pha_METsover1200 = factor(ifelse(PhA_METsWkAllAct<=1200,"Low (MET minutes <= 1200)",
                                         "High (MET minutes > 1200)"),
                                  levels = c("Low (MET minutes <= 1200)", "High (MET minutes > 1200)")),
    
    TEU_VeI_numHTNmedscat = factor( dplyr::case_when(
        is.na(TEU_VeI_numHTNmeds) ~ "None reported",
        TEU_VeI_numHTNmeds == 0 ~ "None reported",
        TEU_VeI_numHTNmeds == 1 ~ "1",
        TEU_VeI_numHTNmeds == 2 ~ "2",
        TEU_VeI_numHTNmeds >= 3 ~ "3 or more",
        TRUE ~ as.character(TEU_VeI_numHTNmeds)
      ), levels=c("None reported", "1", "2", "3 or more"))
      )%>%
  
  group_by(.imp)%>%
  mutate(TEU_SBP_PRS_quintiles= quantcut(TEU_SBP_PRS,q=5,labels = c('Q1: Lowest score','Q2','Q3','Q4','Q5: Highest score')),
         TEU_TownsendDepInd_Quint= quantcut(TownsendDepInd,q=5,labels = c('Q1: least deprived','Q2','Q3','Q4','Q5: most deprived')),
         TEU_BlP_SBP_quintiles=quantcut(TEU_BlP_SBP.avg,q=5,labels=c('Q1: lowest','Q2','Q3','Q4','Q5: highest')),
         TEU_LDL_Quintiles=quantcut(BBC_LDL_Result,q=5,labels=c('Q1: lowest','Q2','Q3','Q4','Q5: highest')),
         GeP_Array=factor(GeP_Array, levels=c("Axiom", "BiLEVE")))

comp_long1<-as.mids(comp_long1)


```



# Multivariable logistic regression exploring association of systolic BP PRS with uncontrolled hypertension (N=`r nrow(data)`)

```{r}

interact_to_strata <- function(modeloutput, var, stratify, expon=FALSE, dp=2) {
  strata <- modeloutput$term[stringr::str_detect(modeloutput$term, var, negate=TRUE)]
  interact <-  modeloutput[stringr::str_detect(modeloutput$term, var) &
                                  stringr::str_detect(modeloutput$term, stratify),] %>%
    separate(term, into=c("stratum", "term"), sep=":", remove=TRUE, extra='merge')
  coeffs <- modeloutput[stringr::str_detect(modeloutput$term, stratify, negate=TRUE),] %>%
    select(term, estimate)
  
  for (s in strata) {
    pretty_s <- str_remove(s, stratify)
    inter <- interact %>% 
      filter(stratum == s) %>% 
      select(term, estimate) %>%
      rename(s_est = estimate)
    coeffs <- left_join(coeffs, inter, by=c("term")) %>%
      mutate(!!pretty_s := estimate + s_est) %>%
      select(-s_est)
  }
  coeffs <- coeffs %>% 
    mutate(., across(.cols=where(is.numeric), .fns=if(expon) exp else NULL)) %>%
    mutate(., across(.cols=where(is.numeric), .fns=pretty_dp,dp=dp)) %>%
    mutate(term=str_remove(term, var))
}

```


## Table `r table`: including age x PRS interaction
`r table <- table + 1`

```{r logistic-regression age-int, include=TRUE, echo=FALSE}

varlist=c("TEU_BaC_AgeCat", "BaC_Sex" , "TEU_SBP_PRS_quintiles", "TEU_BaC_AgeCat:TEU_SBP_PRS_quintiles",
          "TEU_BSM_BMIcat", "TEU_Smo_Status", "TEU_Alc_WeeklyCat", "TEU_Pha_METsover1200",
          "TEU_FaH_CVD", "Prosp_comorb_numcat", "TEU_LDL_Quintiles", "TEU_VeI_numHTNmedscat", 
          "TEU_TownsendDepInd_Quint", "TEU_HouseholdIncome", "TEU_Emp_category", "TEU_Edu_ISCED", "TEU_Rec_Country",
          "GeP_PC_1", "GeP_PC_2", "GeP_PC_3", "GeP_PC_4", "GeP_Array"
          )
pretty_names[["TEU_BaC_AgeCat:TEU_SBP_PRS_quintiles"]] <- "Interaction between Age group and SBP PRS quintiles"


formula <- paste0("TEU_uncontrolledHTN  ~ ", paste(varlist, collapse="+"))
rmodel <- with(comp_long1, glm(as.formula(formula), family="binomial"))
modeloutput <- summary(pool(rmodel)) %>%
  filter(stringr::str_detect(term, "TEU_BaC_AgeCat|TEU_SBP_PRS_quintiles")) %>%
  mutate(term=as.character(term))


routput <- interact_to_strata(modeloutput=modeloutput, expon=TRUE, var="TEU_SBP_PRS_quintiles", stratify="TEU_BaC_AgeCat")
routput <- rbind(c("SBP PRS quintiles", "40-49", "50-59", "60-69"),
                 c("Q1: Lowest score", 1, 1, 1),
                 routput)
rownames(routput) <- NULL
colnames(routput) <- c("", "Age group, years", "", "")

# Output the resulting table
kable(routput, caption="Fully adjusted odds ratio (OR) for uncontrolled hypertension of SBP PRS quintile by age group")

varlist_base <- varlist[-which(varlist=="TEU_BaC_AgeCat:TEU_SBP_PRS_quintiles")]
rmodel_base <- with(comp_long1, glm(
  as.formula(paste0("TEU_uncontrolledHTN  ~ ", paste(varlist_base, collapse="+"))), 
  family="binomial"
  )
)
LRT <- anova(rmodel, rmodel_base, method='D2', use='likelihood')
pval <- pretty_pval(LRT$out$`1 ~~ 2`$result[4])

```

Overall p-value for including interaction in the model is `r pval`. There `r if(pval<0.05) "**is**" else "is **no**"` statistical evidence for an interaction term.

```{r cs int plot,echo=FALSE,eval=TRUE, fig.width=7}

# plot (Age*PRS)
predictions <- lapply(1:10, function(i) {
    m <- glm(TEU_uncontrolledHTN ~ 
               TEU_BaC_AgeCat + BaC_Sex + TEU_SBP_PRS_quintiles + TEU_BaC_AgeCat:TEU_SBP_PRS_quintiles +
               TEU_BSM_BMIcat + TEU_Smo_Status+TEU_Alc_WeeklyCat + TEU_Pha_METsover1200 + 
               TEU_FaH_CVD + Prosp_comorb_numcat + TEU_LDL_Quintiles + TEU_VeI_numHTNmedscat +
               TEU_TownsendDepInd_Quint + TEU_HouseholdIncome + TEU_Emp_category + TEU_Edu_ISCED + TEU_Rec_Country + 
               GeP_PC_1 + GeP_PC_2 + GeP_PC_3 + GeP_PC_4+ GeP_Array,
             family = 'binomial', data = complete(comp_long1, action = i))
    ggpredict(m, terms=c("TEU_SBP_PRS_quintiles","TEU_BaC_AgeCat"))
})
  
pool_pred<-pool_predictions(predictions)

plot(pool_pred)+
  labs(x="SBP PRS",
       y="Probability of uncontrolled HTN status",
       title = "Marginal effect of SBP PRS on the probability of uncontrolled HTN status,\n with pointwise 95% CIs",
       color="Age groups (10 years)",
       caption = "Other continuous variables were kept at sample mean \n while categorical variables were kept at reference level") + theme(plot.title = element_text(size=14))

```


## Table `r table`: including gender x PRS interaction
`r table <- table + 1`

```{r logistic-regression sex-int, include=TRUE, echo=FALSE}

varlist=c("TEU_BaC_AgeCat", "BaC_Sex" , "TEU_SBP_PRS_quintiles", "BaC_Sex:TEU_SBP_PRS_quintiles",
          "TEU_BSM_BMIcat", "TEU_Smo_Status", "TEU_Alc_WeeklyCat", "TEU_Pha_METsover1200",
          "TEU_FaH_CVD", "Prosp_comorb_numcat", "TEU_LDL_Quintiles", "TEU_VeI_numHTNmedscat", 
          "TEU_TownsendDepInd_Quint", "TEU_HouseholdIncome", "TEU_Emp_category", "TEU_Edu_ISCED", "TEU_Rec_Country",
          "GeP_PC_1", "GeP_PC_2", "GeP_PC_3", "GeP_PC_4", "GeP_Array"
          )
pretty_names[["BaC_Sex:TEU_SBP_PRS_quintiles"]] <- "Interaction between Gender and SBP PRS quintiles"

formula <- paste0("TEU_uncontrolledHTN  ~ ", paste(varlist, collapse="+"))
rmodel <- with(comp_long1, glm(as.formula(formula), family="binomial"))
modeloutput <- summary(pool(rmodel)) %>%
  filter(stringr::str_detect(term, "BaC_Sex|TEU_SBP_PRS_quintiles")) %>%
  mutate(term=as.character(term))

routput <- interact_to_strata(modeloutput=modeloutput, expon=TRUE, var="TEU_SBP_PRS_quintiles", stratify="BaC_Sex")
routput <- rbind(c("SBP PRS quintiles", "Female", "Male"),
                 c("Q1: Lowest score", 1, 1),
                 routput)
rownames(routput) <- NULL
colnames(routput) <- c("", "Gender", "")

# Output the resulting table
kable(routput, caption="Fully adjusted odds ratio (OR) for uncontrolled hypertension of SBP PRS quintile by gender")

varlist_base <- varlist[-which(varlist=="BaC_Sex:TEU_SBP_PRS_quintiles")]
rmodel_base <- with(comp_long1, glm(
  as.formula(paste0("TEU_uncontrolledHTN  ~ ", paste(varlist_base, collapse="+"))), 
  family="binomial"
  )
)
LRT <- anova(rmodel, rmodel_base, method='D2', use='likelihood')
pval <- pretty_pval(LRT$out$`1 ~~ 2`$result[4])

```

Overall p-value for including interaction in the model is `r pval`. There `r if(pval<0.05) "**is**" else "is **no**"` statistical evidence for an interaction term.

```{r, fig.width=7}

# plot (gender*PRS)
predictions <- lapply(1:10, function(i) {
    m <- glm(TEU_uncontrolledHTN ~ 
               TEU_BaC_AgeCat + BaC_Sex + TEU_SBP_PRS_quintiles + BaC_Sex:TEU_SBP_PRS_quintiles +
               TEU_BSM_BMIcat + TEU_Smo_Status+TEU_Alc_WeeklyCat + TEU_Pha_METsover1200 + 
               TEU_FaH_CVD + Prosp_comorb_numcat + TEU_LDL_Quintiles + TEU_VeI_numHTNmedscat +
               TEU_TownsendDepInd_Quint + TEU_HouseholdIncome + TEU_Emp_category + TEU_Edu_ISCED + TEU_Rec_Country + 
               GeP_PC_1 + GeP_PC_2 + GeP_PC_3 + GeP_PC_4+ GeP_Array,
             family = 'binomial', data = complete(comp_long1, action = i))
    ggpredict(m, terms=c("TEU_SBP_PRS_quintiles","BaC_Sex"))
})

pool_pred<-pool_predictions(predictions)

plot(pool_pred)+
  labs(x="SBP PRS",
       y="Probability of uncontrolled HTN status",
       title = "Marginal effect of SBP PRS on the probability of uncontrolled HTN status,\n with pointwise 95% CIs",
       color="Gender",
       caption = "Other continuous variables were kept at sample mean \n while categorical variables were kept at reference level") + theme(plot.title = element_text(size=14))


```


# Multivariable Cox regression of time until MACE event (n events = `r nrow(data[data$TEU_MACE_status==1,])`)

Here we are using "Model B: with measured SBP at baseline".

MACE event was defined as diagnosis of MACE event or MACE prevention procedure in HES data, or MACE recorded as primary cause of death.

```{r age-PRS interaction}

varlist_age <- c("TEU_BaC_AgeCat", "BaC_Sex", "TEU_SBP_PRS_quintiles", "TEU_BlP_SBP_quintiles", 
               "TEU_BaC_AgeCat:TEU_SBP_PRS_quintiles",
          "TEU_BSM_BMIcat", "TEU_Smo_Status", "TEU_Alc_WeeklyCat", "TEU_Pha_METsover1200",
          "TEU_FaH_CVD", "Prosp_comorb_numcat", "TEU_VeI_numHTNmedscat", "TEU_LDL_Quintiles",
          "TEU_TownsendDepInd_Quint", "TEU_HouseholdIncome", "TEU_Emp_category", "TEU_Edu_ISCED", "TEU_Rec_Country",
          "GeP_PC_1", "GeP_PC_2", "GeP_PC_3", "GeP_PC_4", "GeP_Array"
          )

varlist_sex <- c("TEU_BaC_AgeCat", "BaC_Sex", "TEU_SBP_PRS_quintiles", "TEU_BlP_SBP_quintiles", 
               "BaC_Sex:TEU_SBP_PRS_quintiles",
          "TEU_BSM_BMIcat", "TEU_Smo_Status", "TEU_Alc_WeeklyCat", "TEU_Pha_METsover1200",
          "TEU_FaH_CVD", "Prosp_comorb_numcat", "TEU_VeI_numHTNmedscat", "TEU_LDL_Quintiles",
          "TEU_TownsendDepInd_Quint", "TEU_HouseholdIncome", "TEU_Emp_category", "TEU_Edu_ISCED", "TEU_Rec_Country",
          "GeP_PC_1", "GeP_PC_2", "GeP_PC_3", "GeP_PC_4", "GeP_Array"
          )

varlist_base <- c("TEU_BaC_AgeCat", "BaC_Sex", "TEU_SBP_PRS_quintiles", "TEU_BlP_SBP_quintiles", 
          "TEU_BSM_BMIcat", "TEU_Smo_Status", "TEU_Alc_WeeklyCat", "TEU_Pha_METsover1200",
          "TEU_FaH_CVD", "Prosp_comorb_numcat", "TEU_VeI_numHTNmedscat", "TEU_LDL_Quintiles",
          "TEU_TownsendDepInd_Quint", "TEU_HouseholdIncome", "TEU_Emp_category", "TEU_Edu_ISCED", "TEU_Rec_Country",
          "GeP_PC_1", "GeP_PC_2", "GeP_PC_3", "GeP_PC_4", "GeP_Array"
          )

```

```{r, cox-output, eval=TRUE}

cox_a_b <- function(varlist_a, varlist_b, status, label,
                    displaycols=varlist_b) {
  # Model A
  formula_a <- paste0("Surv(TEU_MACE_time_yrs,", status, ") ~ ", paste(varlist_a, collapse="+"))
  rmodel_a <- with(comp_long1, coxph(as.formula(formula_a)))
  modeloutput <- summary(pool(rmodel_a))
  
  # Model B
  formula_b <- paste0("Surv(TEU_MACE_time_yrs,", status, ") ~ ", paste(varlist_b, collapse="+"))
  rmodel_b <- with(comp_long1, coxph(as.formula(formula_b)))
  
  # LRT for interaction
  LRT <- anova(rmodel_a, rmodel_b, method='D2', use='likelihood')
  pval <- LRT$out$`1 ~~ 2`$result[4]
  
  outputs <- list(tab=modeloutput, pval=pval)
  return(outputs)
}

```

## Table `r table`: Including Age x PRS interaction
`r table <- table + 1`

```{r Cox models age, echo=FALSE}

cox_age <- cox_a_b(varlist_age, varlist_base, status="TEU_MACE_status",
                    displaycols=c("TEU_BaC_AgeCat", "TEU_SBP_PRS_quintiles", "TEU_BaC_AgeCat:TEU_SBP_PRS_quintiles"))

modeloutput <- cox_age$tab %>%
    filter(stringr::str_detect(term, "TEU_BaC_AgeCat|TEU_SBP_PRS_quintiles")) %>%
    mutate(term=as.character(term))
routput <- interact_to_strata(modeloutput=modeloutput, expon=TRUE, var="TEU_SBP_PRS_quintiles", stratify="TEU_BaC_AgeCat")
routput <- rbind(c("SBP PRS quintiles", "40-49", "50-59", "60-69"),
                 c("Q1: Lowest score", 1, 1, 1),
                 routput)
rownames(routput) <- NULL
colnames(routput) <- c("", "Age group, years", "", "")
  
kable(routput, caption="Fully adjusted hazard ratio (HR) for MACE of SBP PRS quintile by age group")
```

Overall p-value for including interaction in the model is `r pretty_pval(cox_age$pval)`. There `r if(cox_age$pval<0.05) "**is**" else "is **no**"` statistical evidence for an interaction term.

```{r, fig.width=7}

# plot (gender*PRS)
predictions <- lapply(1:10, function(i) {
    f <- paste0("Surv(TEU_MACE_time_yrs, TEU_MACE_status) ~ ", paste(varlist_age, collapse="+"))
    m <- with(complete(comp_long1, action = i), coxph(as.formula(f)))
    
    ggpredict(m, terms=c("TEU_SBP_PRS_quintiles","TEU_BaC_AgeCat"))
})

pool_pred<-pool_predictions(predictions)

plot(pool_pred)+
  labs(x="SBP PRS",
       y="Relative hazard, exp(Xbeta)",
       title = "Marginal effect of SBP PRS on the relative hazard in a Cox model, \n with pointwise 95% CIs",
       color="Age groups (10 years)",
       caption = "Other continuous variables were kept at sample mean \n while categorical variables were kept at reference level") + theme(plot.title = element_text(size=14))


```

## Table `r table`: Including Gender x PRS interaction
`r table <- table + 1`

```{r Cox models sex, echo=FALSE}

cox_sex <- cox_a_b(varlist_sex, varlist_base, status="TEU_MACE_status", 
                    displaycols=c("BaC_Sex", "TEU_SBP_PRS_quintiles", "BaC_Sex:TEU_SBP_PRS_quintiles"))

modeloutput <- cox_sex$tab %>%
    filter(stringr::str_detect(term, "BaC_Sex|TEU_SBP_PRS_quintiles")) %>%
    mutate(term=as.character(term))
routput <- interact_to_strata(modeloutput=modeloutput, expon=TRUE, var="TEU_SBP_PRS_quintiles", stratify="BaC_Sex")
routput <- rbind(c("SBP PRS quintiles", "Female", "Male"),
                 c("Q1: Lowest score", 1, 1),
                 routput)
rownames(routput) <- NULL
colnames(routput) <- c("", "Gender", "")

kable(routput, caption="Fully adjusted hazard ratio (HR) for MACE of SBP PRS quintile by gender")
```

Overall p-value for including interaction in the model is `r pretty_pval(cox_sex$pval)`. There `r if(cox_sex$pval<0.05) "**is**" else "is **no**"` statistical evidence for an interaction term.

```{r, fig.width=7}

# plot (gender*PRS)
predictions <- lapply(1:10, function(i) {
    f <- paste0("Surv(TEU_MACE_time_yrs, TEU_MACE_status) ~ ", paste(varlist_sex, collapse="+"))
    m <- with(complete(comp_long1, action = i), coxph(as.formula(f)))
    
    ggpredict(m, terms=c("TEU_SBP_PRS_quintiles","BaC_Sex"))
})

pool_pred<-pool_predictions(predictions)

plot(pool_pred)+
  labs(x="SBP PRS",
       y="Relative hazard, exp(Xbeta)",
       title = "Marginal effect of SBP PRS on the relative hazard in a Cox model, \n with pointwise 95% CIs",
       color="Gender",
       caption = "Other continuous variables were kept at sample mean \n while categorical variables were kept at reference level") + theme(plot.title = element_text(size=14))


```
