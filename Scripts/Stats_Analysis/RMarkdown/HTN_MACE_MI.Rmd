---
title: "HTN PRS MACE prospective"
author:  "Jennifer Collister"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  word_document:
      reference_docx: "K:/TEU/TEU_Guides/TEU_DocStyle_Rmd_2020.dotx"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include=TRUE, echo=FALSE)

library(kableExtra)
library(knitr)
library(yaml)
library(here)
library(DiagrammeR)
library(DiagrammeRsvg)
library(svglite)
library(rsvg)
library(png)
library(dplyr)
library(ggplot2)
library(survival)
library(survminer)
library(rms)
library(shiny)
library(rcompanion)
library(Publish)
library(gridExtra)
library(ResourceSelection)
library(naniar)
library(mice)
library(gtools)

# Specify the markdown format for knitr tables, otherwise they're not compatible with kableExtra
options(knitr.kable.NA='', knitr.table.format = "markdown")
options(kableExtra.auto_format = FALSE)
# Set the root directory to the project directory (otherwise knitr works in the directory of the Rmd file by default)
knitr::opts_knit$set(root.dir = here::here())
knitr::opts_chunk$set(include=TRUE, echo=FALSE)

# Load the project config file for filepaths etc
config = yaml.load_file(here::here("./config.yml"))
source(here::here(config$functions$JC))

#-------------------------------------------------------------------------------------------------------------------
# Setup

figure <- 1
table <- 1
suppfig <- 1
footnote_no <- 1

# Check if the session is being knitted or run interactively
# When we're knitting the documentation, we don't want to include the diagnostic checks
live <- interactive()

```

```{r data-derivation, include=FALSE, cache=TRUE}
 
source(file.path(config$scripts$cleaning, "dataset_generator.R"))

exclusions <- function(data){
  
  excl$initial <<- nrow(data)
  
  # Exclude those outside the 40-70 age range
  data <- data[data$TEU_BaC_AgeAtRec >= 40 & data$TEU_BaC_AgeAtRec < 70,]
  
  excl$agerange <<- nrow(data)

  # Exclude individuals with missing BP data
  # or missing answers to BP questions on touchscreen questionnaire
  data <- data[!is.na(data$TEU_BlP_SBP.avg),]
  data <- data[!is.na(data$TEU_BlP_DBP.avg),]
  data <- data[data$TEU_HMH_prevHTN != "Unanswered",]
  data <- data[data$TEU_HMH_Meds_BP != "Unanswered",]
  # Exclude participants who only had BP measured once
  data <- data[data$TEU_BlP_nSBP == 2 & data$TEU_BlP_nDBP == 2,]
  
  excl$BPmiss <<- nrow(data)

  # Exclude individuals with implausible BP data
  data <- data[data$TEU_BlP_SBP.avg >= 70 & data$TEU_BlP_SBP.avg <= 270,]
  data <- data[data$TEU_BlP_DBP.avg >= 50 & data$TEU_BlP_DBP.avg <= 150,]
  
  excl$BPimp <<- nrow(data)
  
  # Only keep those with genetic data
  data <- data[!is.na(data$TEU_BP_PRS),]
  
  excl$PRSmiss <<- nrow(data)

  # Exclude pregnant women ("Yes" or "Unsure")
  data <- data[is.na(data$VeI_PregnantNow) | data$VeI_PregnantNow == "No",]
  
  excl$pregnant <<- nrow(data)

  # Exclude individuals who have serious health conditions
  data <- data[is.na(data$TEU_VeI_seriouscomb),]

  # And individuals with cancer (except for skin cancer?)
  data <- data[is.na(data$TEU_VeI_cancer),]
  
  excl$seriouscomorb <<- nrow(data)
  
  # Any durations less than 0 are clearly errors (only 2)
  # Any diagnoses before the age of about 20 are probably due to other causes
  data$TEU_VeI_HTN_dur[data$TEU_VeI_HTN_dur < 0] <- NA
  # data[data$TEU_VeI_HTN_dur > data$TEU_BaC_AgeAtRec-20,]
  
  # Exclude those who were not hypertensive
  data <- data[data$TEU_evidenceHTN == TRUE & !is.na(data$TEU_evidenceHTN),]
  
  excl$evidenceHTN <<- nrow(data)
  
  # Exclude those who were not aware
  data <- data[data$TEU_awareHTN == TRUE & !is.na(data$TEU_awareHTN),]
  
  excl$aware <<- nrow(data)
  
  # Only interested in treated hypertensives
  data <- data[data$TEU_treatedHTN == TRUE & !is.na(data$TEU_treatedHTN),]
  
  excl$treated <<- nrow(data)
  
  # Exclude MACE at baseline
  data <- data[!data$TEU_MACE_prev=="Yes",]
  
  excl$MACE <<- nrow(data)
  
  # Restrict to genetically white British
  data <- data[!is.na(data$GeP_ethnic),]
  
  excl$whiteBrit <<- nrow(data)
  
  return(data) 
}

excl <- list(initial=0)

data <-
  evalWithMemoization(
    derive_variables(
      database = "K:/TEU/UKB33952_Data/Data_Downloads/V3_database_duckdb0.2.1/ukb_v3.db",
      field_definitions = TEU_SPECS$HTN_control_MACE,
      exclusions = exclusions
    ),
    key = c(TEU_SPECS$HTN_control_MACE, exclusions)
  )

pretty_func <- pretty_switch(field_definitions=TEU_SPECS$HTN_control_MACE, return_type = "function")
pretty_names <- pretty_switch(field_definitions=TEU_SPECS$HTN_control_MACE, return_type = "list")

export_svg(DiagrammeR::grViz(here::here(file.path(config$outputs$flowcharts, "HTN_PRS_MACE.gv")))
           ) %>% charToRaw %>% rsvg %>% 
  png::writePNG(here::here(file.path(config$outputs$figures, "HTN_PRS_MACE.png")))


```



```{r}

MI_data=data%>%
  select(ID,TEU_MACE_status,TEU_MACE_time_yrs, TEU_MACE_MI, TEU_MACE_Stroke, TEU_controlledHTN,
         TEU_BaC_AgeAtRec,BaC_Sex,
         TEU_SBP_PRS,
         BSM_BMI,TEU_Smo_Status,
         TEU_Alc_WeeklyCat,
         TEU_Alc_WeeklyAlcUnits,
         PhA_METsWkAllAct,TEU_FaH_CVD,
         Prosp_comorb_numcat,
         TEU_VeI_numHTNmeds,
         TEU_BlP_SBP.avg, 
         BBC_LDL_Result,
         TownsendDepInd, TEU_HouseholdIncome,TEU_Emp_category,TEU_Edu_ISCED,
         TEU_Rec_Country,paste0('GeP_PC_',1:4))%>%
  # Change missing categories to NA
  mutate_if(is.factor, list(~na_if(., "Unanswered")))%>%
  mutate_if(is.factor, list(~na_if(., "Prefer not to answer")))%>%
  droplevels()
            
            


# Check missing percentage 
if(live){MI_data%>%miss_var_summary()}

# Based on our Stats Guide, one can consider MI when missing percentage 10%-30%
# Assumption: MAR

# Investigate missing mechanism: Assess association between missing and observed data 

# Check KM plot by missing indicator for variables that contain missing data 
# Prepare for KM plot against missingness 
missing_var=MI_data%>%miss_var_summary()%>%filter(n_miss!=0)%>%pull(variable)

mp_data=MI_data%>%
  mutate_at(missing_var,~ifelse(is.na(.),'Missing','Not Missing'))


# unadjusted KM (adjusted KM would be better but covariates adjusted contain missing data)
# log rank test
plot_list = list()
for(i in missing_var){
  #var=missing_var[i]
  
  p<-ggsurvplot(
    fit = survfit(Surv(TEU_MACE_time_yrs,TEU_MACE_status)~  mp_data[[i]], data = mp_data), 
    xlab = "Years", 
    ylab = "Survival probability",
    title = paste0(i),
    pval = TRUE)
  
  plot_list[[i]]<-p
  
}
if(live){plot_list}

# In general, if there is visual and statistical evidence of significant differences in survival distributions stratified by missing value indicator, then simply removing missing data (i.e. complete case analysis) would lead to biased estimate of the true survival of the cohort.

```

```{r}

# Create Imputations (iter=20, M=5)
iter <- 20
M <- 10

# Using default imputation method based on variable type

if(live) {
  ini <- mice(MI_data,maxit = 0,print=FALSE)
  pred <- ini$predictorMatrix
  
  # Remove predictors: ID; TEU_MACE_MI; TEU_MACE_Stroke; TEU_Alc_WeeklyCat (want to use alc continuous variables instead)
  pred[,c("ID","TEU_MACE_MI","TEU_MACE_Stroke")] <- 0
  
  
  imp1<-mice(MI_data,pred=pred, m = M, maxit = iter,seed = 100)
  
  saveRDS(imp1,file=file.path(config$data$derived, paste0("imputation", format(Sys.time(), '%d%B%Y'), ".rds")))
} else {
  imp1 <- readRDS(file.path(config$data$derived, "imputation11March2021.rds"))
}
```

```{r, eval=live}

# Diagnostics 

## 1. Assess Convergence 
plot(imp1)

## 2. Compare summary stats between observed and completed (observed + imputed) data

# Extract completed data after MI
long1 <- complete(imp1,"long") 
long1$.imp <- as.factor(long1$.imp)



num_plot <- list() #Save the density plots
factor_tb <- list() # Save the freq tables 

for (var in missing_var){
  
  if (is.numeric(MI_data[[var]])){
    # If numeric, plot density between observed and imputed 
    
    #long1 <- cbind(long1, ind.na=is.na(imp1$data[[var]]))
    long1 <- long1 %>%
      mutate(ind.na=rep(is.na(imp1$data[[var]]), M))
    
    p<-densityplot(~long1[[var]]|.imp, data=long1, group=ind.na, plot.points=FALSE,
                ref=TRUE, xlab=paste0(var),scales=list(y=list(draw=F)),
                par.settings=simpleTheme(col.line=rep(c("blue","red"))), 
                auto.key = list(columns=2,text=c("Observed","Imputed")))
    
    num_plot[[var]]=p
    
  }else{
    # If factor, produce freq table of each level between observed and imputed 
    long1 <- long1 %>%
      mutate(ind.na=rep(ifelse(is.na(imp1$data[[var]]),'Imputed','Observed'), M))
    
    factor_tb[[var]] <- lapply(unique(long1$.imp), function(i) 
      prop.table(table(long1%>%filter(.imp==i)%>%pull(ind.na),
                       long1%>%filter(.imp==i)%>%pull(var)), margin = 1)*100)
    
  }
}

num_plot
factor_tb


# Check overall descriptive between observed and completed (observed + imputed)
summary(MI_data$TEU_BlP_SBP.avg)

lapply(1:M, function(i) summary(long1%>%filter(.imp==i)%>%pull(TEU_BlP_SBP.avg)))

summary(MI_data$TownsendDepInd)

lapply(1:M, function(i) summary(long1%>%filter(.imp==i)%>%pull(TownsendDepInd)))


```

```{r}

# Post processing: Change continuous covariates to categorical for further analysis 

long1 <- complete(imp1,"long",include = TRUE) 

comp_long1<-long1%>%
  mutate(
    TEU_BaC_AgeCat=cut(TEU_BaC_AgeAtRec,
                       breaks = c(40, 50, 60, 70),
                       labels = c("40-49", "50-59", "60-69"),
                       right = FALSE
    ),
    
    TEU_BSM_BMIcat=factor(cut(BSM_BMI,
                       breaks = c(0, 18.5, 25, 30, 200),
                       c("Underweight", "Normal", "Overweight", "Obese"),
                       right = FALSE
    ),levels = c('Normal','Underweight','Overweight','Obese')),
    
    TEU_LDLctrl_v1=factor(ifelse(BBC_LDL_Result<3,1,0),levels=c(0,1), 
                          labels=c("Not controlled", "Controlled")),
    TEU_Smo_Status=factor(TEU_Smo_Status,levels = c('Never','Previous','Current')),
    TEU_Pha_METsover1200 = factor(ifelse(PhA_METsWkAllAct<=1200,"Low (MET minutes <= 1200)",
                                         "High (MET minutes > 1200)"),
                                  levels = c("Low (MET minutes <= 1200)", "High (MET minutes > 1200)")),
    TEU_VeI_numHTNmedscat = factor( dplyr::case_when(
        is.na(TEU_VeI_numHTNmeds) ~ "None reported",
        TEU_VeI_numHTNmeds == 0 ~ "None reported",
        TEU_VeI_numHTNmeds == 1 ~ "1",
        TEU_VeI_numHTNmeds == 2 ~ "2",
        TEU_VeI_numHTNmeds >= 3 ~ "3 or more",
        TRUE ~ as.character(TEU_VeI_numHTNmeds)
      ), levels=c("None reported", "1", "2", "3 or more"))
      )%>%
  
  group_by(.imp)%>%
  mutate(TEU_SBP_PRS_Quint= quantcut(TEU_SBP_PRS,q=5,labels = c('Q1: Lowest score','Q2','Q3','Q4','Q5: Highest score')),
         TEU_TownsendDepInd_Quint= quantcut(TownsendDepInd,q=5,labels = c('Q1: least deprived','Q2','Q3','Q4','Q5: most deprived')),
         TEU_BlP_SBP_Quint=quantcut(TEU_BlP_SBP.avg,q=5,labels=c('Q1: Lowest level','Q2','Q3','Q4','Q5: Highest level')),
         #TEU_BlP_DBP_Quint=quantcut(TEU_BlP_DBP.avg,q=5,labels=c('Q1: Lowest level','Q2','Q3','Q4','Q5: Highest level')),
         BBC_LDL_Quint=quantcut(BBC_LDL_Result,q=5,labels=c('Q1: Lowest level','Q2','Q3','Q4','Q5: Highest level')))

comp_long1<-as.mids(comp_long1)

pretty_names$TEU_SBP_PRS_Quint <- "Systolic BP PRS Quintiles"
pretty_names$BBC_LDL_Quint <- "Baseline LDL-C quintiles"

```




# Hypertension PRS cross-sectional analysis

## Table `r table`. Characteristics of participants included in the analysis, by Systolic BP PRS quintile (treated hypertensives, n = `r nrow(data)`).
`r table <- table + 1`

```{r descriptive-table, include=TRUE, echo=FALSE}
varlist=c("TEU_BaC_AgeAtRec", "TEU_BaC_AgeCat", "BaC_Sex", "TEU_BlP_SBP_quintiles",
          "TEU_BSM_BMIcat", "TEU_Smo_Status", "TEU_Alc_WeeklyCat", "TEU_Pha_METsover1200",
          "TEU_FaH_CVD", "Prosp_comorb_numcat", "TEU_VeI_numHTNmedscat", "TEU_LDL_Quintiles",
          "TEU_TownsendDepInd_Quint", "TEU_HouseholdIncome", "TEU_Emp_category", "TEU_Edu_ISCED", "TEU_Rec_Country"
          )

tab_all <- descriptivetable(df=data, 
                         varlist=varlist,
                         contavg='median',
                         pretty_names=pretty_names)

tab_1 <- descriptivetable(df=data[data$TEU_SBP_PRS_quintiles=="Q1: lowest",], 
                         varlist=varlist,
                         contavg='median',
                         pretty_names=pretty_names)

tab_3 <- descriptivetable(df=data[data$TEU_SBP_PRS_quintiles=="Q3",], 
                         varlist=varlist,
                         contavg='median',
                         pretty_names=pretty_names)

tab_5 <- descriptivetable(df=data[data$TEU_SBP_PRS_quintiles=="Q5: highest",], 
                         varlist=varlist,
                         contavg='median',
                         pretty_names=pretty_names)

tab <- inner_join(tab_all, tab_1%>%select(-Variable), by="IDcol")
tab <- inner_join(tab, tab_3%>%select(-Variable), by="IDcol")
tab <- inner_join(tab, tab_5%>%select(-Variable), by="IDcol")

rownames(tab) <- NULL
tab <- rbind(c("", "Variable", "n", "%", "n", "%", "n", "%", "n", "%"),
              as.matrix(tab))
colnames(tab) <- c("", "", "Overall", "", "Q1: lowest", "", "Q3", "", "Q5: highest", "")

# Output the resulting table
kable(tab[,-1])

```

## Table `r table`: Multivariable logistic regression identifying factors associated with hypertension control, among middle-aged UK adults on anti-hypertensive treatment (n=`r nrow(data)`)
`r table <- table + 1`

```{r logistic-regression, include=TRUE, echo=FALSE}

varlist=c("TEU_BaC_AgeCat", "BaC_Sex", "TEU_SBP_PRS_Quint",
          "TEU_BSM_BMIcat", "TEU_Smo_Status", "TEU_Alc_WeeklyCat", "TEU_Pha_METsover1200",
          "TEU_FaH_CVD", "Prosp_comorb_numcat", "TEU_VeI_numHTNmedscat", "BBC_LDL_Quint",
          "TEU_TownsendDepInd_Quint", "TEU_HouseholdIncome", "TEU_Emp_category", "TEU_Edu_ISCED", "TEU_Rec_Country",
          "GeP_PC_1", "GeP_PC_2", "GeP_PC_3", "GeP_PC_4"
          )

formula <- paste0("TEU_controlledHTN  ~ ", paste(varlist, collapse="+"))
rmodel <- with(comp_long1, glm(as.formula(formula), family="binomial"))

routput <- printMIresults(df=data, varlist=varlist, modeloutput=summary(pool(rmodel)),
                            pretty_names=pretty_names, onecol=FALSE, IDcol=FALSE)

rownames(routput) <- NULL

colnames(routput) <- c("Coefficient", "Level", "OR", "95% CI", "p")

# Output the resulting table
kable(routput)

```

```{r}

# p-value of including PRS in model

anova <- with(comp_long1, glm(as.formula(paste0("TEU_controlledHTN ~ ",
                             paste(varlist[-which(varlist=="TEU_SBP_PRS_Quint")], collapse="+"))), family="binomial"))

LRT <- anova(rmodel, anova, method = 'D2',use = 'likelihood')

SBP_p <- LRT$out$`1 ~~ 2`$result[4]

```

### Overall p-value of SBP PRS

Based on likelihood ratio test, inclusion of SBP PRS `r if(SBP_p < 0.05){"**does**"}else{"does **not**"}` provide significant improvement in model fit (p = `r pretty_pval(SBP_p)`).

```{r cross-sectional Model Check,echo=FALSE}

## Assess model fit
## 1. Hosmer-Lemeshow Test

HL <- hoslem.test(multi$y,fitted(multi),g=10)

# g is the number of groups into which to split the observations in the sample
# For g in 5 to 15, check Hosmer Lemeshow p-vals
HL_pvals=sapply(5:15,function(i) hoslem.test(multi$y, fitted(multi), g=i)$p.value)

## 2. Multicollinearity
# VIFs
m2_vifs=data.frame(car::vif(multi))
m2_vifs$squared=(m2_vifs$GVIF..1..2.Df..)^2
max <- max(m2_vifs$squared)

# Check correlation among covariates 
corr <- data%>%select(any_of(varlist))%>%select(!starts_with("GeP_PC"))
corr_matrix <- corr_mat(corr)
# Find covariates with highest correlation
inds <- which(corr_matrix==max(corr_matrix), arr.ind=TRUE)
maxrow <- pretty_func(rownames(corr_matrix)[inds[1,1]])
maxcol <- pretty_func(colnames(corr_matrix)[inds[1,2]])

```

### Model checks:

**Hosmer-Lemeshow Test**: `r sum(HL_pvals<0.05)` p-values were above 5% significance level, across 5 to 15 groups. 

**Multicollinearity**: 
VIFs (or squared VIFs for categorical covariates) across all covariates `r if(max<10){"were"}else{"were not"}` below 10. The highest VIF was `r max`. 
The highest correlation between any pair of variables in the model was `r max(corr_matrix)`, between *`r maxrow`* and *`r maxcol`*.

# Hypertension PRS prospective analysis

Including SBP PRS (quintiles), showing for each outcome:

* Model A: without measured SBP at baseline
* Model B: with measured SBP at baseline

```{r varlists for models}

varlist_a <- c("TEU_BaC_AgeCat", "BaC_Sex", "TEU_SBP_PRS_Quint",
          "TEU_BSM_BMIcat", "TEU_Smo_Status", "TEU_Alc_WeeklyCat", "TEU_Pha_METsover1200",
          "TEU_FaH_CVD", "Prosp_comorb_numcat", "TEU_VeI_numHTNmedscat", "BBC_LDL_Quint",
          "TEU_TownsendDepInd_Quint", "TEU_HouseholdIncome", "TEU_Emp_category", "TEU_Edu_ISCED", "TEU_Rec_Country",
          "GeP_PC_1", "GeP_PC_2", "GeP_PC_3", "GeP_PC_4"
          )

varlist_b <- c("TEU_BaC_AgeCat", "BaC_Sex", "TEU_SBP_PRS_Quint", "TEU_BlP_SBP_Quint", 
          "TEU_BSM_BMIcat", "TEU_Smo_Status", "TEU_Alc_WeeklyCat", "TEU_Pha_METsover1200",
          "TEU_FaH_CVD", "Prosp_comorb_numcat", "TEU_VeI_numHTNmedscat", "BBC_LDL_Quint",
          "TEU_TownsendDepInd_Quint", "TEU_HouseholdIncome", "TEU_Emp_category", "TEU_Edu_ISCED", "TEU_Rec_Country",
          "GeP_PC_1", "GeP_PC_2", "GeP_PC_3", "GeP_PC_4"
          )

```

## Cox regression of time until MACE event (`r nrow(data[data$TEU_MACE_status==1,])` events)

MI event defined as diagnosis of MACE event or MACE prevention procedure in HES data, or MACE recorded as primary cause of death.

```{r Cox model mace, echo=FALSE}

status <- "TEU_MACE_status"

```

```{r, cox-output, eval=TRUE}

# Model A
formula_a <- paste0("Surv(TEU_MACE_time_yrs,", status, ") ~ ", paste(varlist_a, collapse="+"))
rmodel_a <- with(comp_long1, coxph(as.formula(formula_a)))

routput_a <- printMIresults(df=data, varlist=varlist_b, modeloutput=summary(pool(rmodel_a)),
                            pretty_names=pretty_names, onecol=FALSE, IDcol=TRUE)
routput_a$HR[grepl("TEU_BlP_SBP_quintiles", routput_a$IDcol, fixed=TRUE)] <- NA

# Model B
formula_b <- paste0("Surv(TEU_MACE_time_yrs,", status, ") ~ ", paste(varlist_b, collapse="+"))
rmodel_b <- with(comp_long1, coxph(as.formula(formula_b)))

routput_b <- printMIresults(df=data, varlist=varlist_b, modeloutput=summary(pool(rmodel_b)),
                            pretty_names=pretty_names, onecol=FALSE, IDcol=TRUE)

# Combine into one table
tab4 <- left_join(routput_a, routput_b, by=c("IDcol", "Coefficient", "Levels")) %>%
  select(-IDcol) %>%
  replace(., is.na(.), "")

rownames(tab4) <- NULL
tab4 <- rbind(c("Coefficient", "Level", "HR", "95% CI", "p", "OR", "95% CI", "p"),
              as.matrix(tab4))
colnames(tab4) <- c("", "",
                    "Model A", "", "", 
                    "Model B", "", "")

kable(tab4)

```

```{r, SBP_pval}

anova_a <- with(comp_long1, 
                coxph(as.formula(paste0("Surv(TEU_MACE_time_yrs,", status, ") ~ ",
                                        paste(varlist_a[-which(varlist_a=="TEU_SBP_PRS_Quint")], collapse="+")))))
anova_b <- with(comp_long1, 
                coxph(as.formula(paste0("Surv(TEU_MACE_time_yrs,", status, ") ~ ",
                                        paste(varlist_b[-which(varlist_b=="TEU_SBP_PRS_Quint")], collapse="+")))))

LRT_a <- anova(rmodel_a, anova_a, method='D2', use='likelihood')
LRT_b <- anova(rmodel_b, anova_b, method='D2', use='likelihood')

SBP_p_a <- LRT_a$out$`1 ~~ 2`$result[4] 
SBP_p_b <- LRT_b$out$`1 ~~ 2`$result[4]

```

### Overall p-value of SBP PRS

* Model A: Based on likelihood ratio test, inclusion of SBP PRS `r if(SBP_p_a < 0.05){"**does**"}else{"does **not**"}` provide significant improvement in model fit (p = `r pretty_pval(SBP_p_a)`).
* Model B: Based on likelihood ratio test, inclusion of SBP PRS `r if(SBP_p_b < 0.05){"**does**"}else{"does **not**"}` provide significant improvement in model fit (p = `r pretty_pval(SBP_p_b)`).


```{r, model-checks, echo=FALSE}

## 1. PHA 
ggsave(file.path(config$outputs$figures, paste0(status, "_modelA.pdf")), 
       arrangeGrob(grobs = ggcoxzph(cox.zph(rmodel_a))), width=20, height=14, limitsize = FALSE)
ggsave(file.path(config$outputs$figures, paste0(status, "_modelB.pdf")), 
       arrangeGrob(grobs = ggcoxzph(cox.zph(rmodel_b))), width=20, height=14, limitsize = FALSE)

## 2. Multicollinearity
# VIF

# Model A
vif_a <- rms::vif(cph(formula_a,data=data))
max_a <- max(vif_a)
var_a <- names(vif_a)[which(vif_a == max(vif_a))]

# Model B 
vif_b <- rms::vif(cph(formula_b, data=data))
max_b <- max(vif_b)
var_b <- names(vif_b)[which(vif_b == max(vif_b))]

if(max_a > max_b){
  maxvif <- max_a
  varvif <- var_a
} else {
  maxvif <- max_b
  varvif <- var_b
}
prettyvif <- strsplit(varvif, "=")[[1]]

# Check correlation among covariates 
corr <- data%>%select(any_of(varlist_b))%>%select(!starts_with("GeP_PC"))
corr_matrix <- corr_mat(corr)
# Find covariates with highest correlation
inds <- which(corr_matrix==max(corr_matrix), arr.ind=TRUE)
maxrow <- pretty_func(rownames(corr_matrix)[inds[1,1]])
maxcol <- pretty_func(colnames(corr_matrix)[inds[1,2]])

```

### Model checks:

**Proportional hazards assumption**: Visual inspection of the Schoenfeld residuals gave no evidence of PHA violation.

**Multicollinearity**: 
VIFs across all covariates `r if(maxvif<10){"were"}else{"were not"}` below 10. The highest VIF was `r maxvif`, from level *`r prettyvif[2]`* of *`r pretty_func(prettyvif[1])`*. 
The highest correlation between any pair of variables in the model was `r max(corr_matrix)`, between *`r maxrow`* and *`r maxcol`*.

## Cox regression of time until MI event (`r nrow(data[data$TEU_MACE_MI==1,])` events)

MI event defined as diagnosis of myocardial infarction or MI prevention procedure in HES data, or MI recorded as primary cause of death (censoring at first MACE event applied)

```{r Cox model MI, echo=FALSE}

status <- "TEU_MACE_MI"

<<cox-output>>

```

```{r, echo=FALSE}

<<SBP_pval>>

```

### Overall p-value of SBP PRS

* Model A: Based on likelihood ratio test, inclusion of SBP PRS `r if(SBP_p_a < 0.05){"**does**"}else{"does **not**"}` provide significant improvement in model fit (p = `r pretty_pval(SBP_p_a)`).
* Model B: Based on likelihood ratio test, inclusion of SBP PRS `r if(SBP_p_b < 0.05){"**does**"}else{"does **not**"}` provide significant improvement in model fit (p = `r pretty_pval(SBP_p_b)`).

```{r, echo=FALSE}

<<model-checks>>

```

### Model checks:

**Proportional hazards assumption**: Visual inspection of the Schoenfeld residuals gave no evidence of PHA violation.

**Multicollinearity**: 
VIFs across all covariates `r if(maxvif<10){"were"}else{"were not"}` below 10. The highest VIF was `r maxvif`, from level *`r prettyvif[2]`* of *`r pretty_func(prettyvif[1])`*. 
The highest correlation between any pair of variables in the model was `r max(corr_matrix)`, between *`r maxrow`* and *`r maxcol`*.

## Cox regression of the time until stroke event (`r nrow(data[data$TEU_MACE_Stroke==1,])` events)

Stroke event defined as diagnosis of stroke (any kind) or stroke prevention procedure in HES data, or stroke recorded as primary cause of death (censoring at first MACE event applied).

```{r Cox model stroke, echo=FALSE}

status <- "TEU_MACE_Stroke"

<<cox-output>>

```

```{r, echo=FALSE}

<<SBP_pval>>

```

### Overall p-value of SBP PRS

* Model A: Based on likelihood ratio test, inclusion of SBP PRS `r if(SBP_p_a < 0.05){"**does**"}else{"does **not**"}` provide significant improvement in model fit (p = `r pretty_pval(SBP_p_a)`).
* Model B: Based on likelihood ratio test, inclusion of SBP PRS `r if(SBP_p_b < 0.05){"**does**"}else{"does **not**"}` provide significant improvement in model fit (p = `r pretty_pval(SBP_p_b)`).

```{r, echo=FALSE}

<<model-checks>>

```

### Model checks:

**Proportional hazards assumption**: Visual inspection of the Schoenfeld residuals gave no evidence of PHA violation.

**Multicollinearity**: 
VIFs across all covariates `r if(maxvif<10){"were"}else{"were not"}` below 10. The highest VIF was `r maxvif`, from level *`r prettyvif[2]`* of *`r pretty_func(prettyvif[1])`*. 
The highest correlation between any pair of variables in the model was `r max(corr_matrix)`, between *`r maxrow`* and *`r maxcol`*.
  
# Appendix - including SBP PRS as an ordinal variable in regression model A with MACE outcome

Please note all covariates from Model A have been included, but in the interests of saving space I've dropped all rows from the table below the SBP PRS

## Ordered factor

```{r}
data$TEU_SBP_PRS_quintiles_o <- factor(data$TEU_SBP_PRS_quintiles, ordered=TRUE)

varlist <- c("TEU_BaC_AgeCat", "BaC_Sex", "TEU_SBP_PRS_quintiles_o",
          "TEU_BSM_BMIcat", "TEU_Smo_Status", "TEU_Alc_WeeklyCat", "TEU_Pha_METsover1200",
          "TEU_FaH_CVD", "Prosp_comorb_numcat", "TEU_VeI_numHTNmedscat", "TEU_LDL_Quintiles",
          "TEU_TownsendDepInd_Quint", "TEU_HouseholdIncome", "TEU_Emp_category", "TEU_Edu_ISCED", "TEU_Rec_Country",
          "GeP_PC_1", "GeP_PC_2", "GeP_PC_3", "GeP_PC_4"
          )

formula <- as.formula(paste0("Surv(TEU_MACE_time_yrs, TEU_MACE_status) ~ ", paste(varlist, collapse="+")))
rmodel <- coxph(formula, data=data)

routput <- printcoxresults(df=data, varlist=varlist, modeloutput=rmodel,
                            pretty_names=pretty_names, onecol=FALSE, IDcol=TRUE)

kable(routput%>%select(-IDcol)%>%slice_head(n=10))

```

Note that when we include SBP PRS quintiles as an ordinal variable (ordered factor in R) we get linear, quadratic, cubic and quartic terms in R.

Since there are 5 possible categories of SBP PRS quintile, a polynomial of degree 4 is used to replace it in the regression model. We can see that the linear term is statistically significant, but the higher order terms are not - this suggests that the PRS quintiles do have a linear relationship with the MACE outcome. However, we cannot just use the p-value of the linear term to describe the overall significance of the variable, because the higher order terms are present in the model.

## Numeric $\in [1, 2, 3, 4, 5]$ 

An alternative approach is to convert the quintile categories to numeric type, so Q1 will be the integer 1 and Q5 the integer 5, etc. Although we are now modelling this as a continuous variable, we have lost information from the original PRS score, with all scores being collapsed into these five integer values by quintile.

```{r}
data$TEU_SBP_PRS_quintiles_l <- as.numeric(data$TEU_SBP_PRS_quintiles)

varlist <- c("TEU_BaC_AgeCat", "BaC_Sex", "TEU_SBP_PRS_quintiles_l",
          "TEU_BSM_BMIcat", "TEU_Smo_Status", "TEU_Alc_WeeklyCat", "TEU_Pha_METsover1200",
          "TEU_FaH_CVD", "Prosp_comorb_numcat", "TEU_VeI_numHTNmedscat", "TEU_LDL_Quintiles",
          "TEU_TownsendDepInd_Quint", "TEU_HouseholdIncome", "TEU_Emp_category", "TEU_Edu_ISCED", "TEU_Rec_Country",
          "GeP_PC_1", "GeP_PC_2", "GeP_PC_3", "GeP_PC_4"
          )

formula <- as.formula(paste0("Surv(TEU_MACE_time_yrs, TEU_MACE_status) ~ ", paste(varlist, collapse="+")))
rmodel <- coxph(formula, data=data)

routput <- printcoxresults(df=data, varlist=varlist, modeloutput=rmodel,
                            pretty_names=pretty_names, onecol=FALSE, IDcol=TRUE)

kable(routput%>%select(-IDcol)%>%slice_head(n=6))

```

We see a statistically significant HR of `r routput$HR[routput$IDcol=="TEU_SBP_PRS_quintiles_l"]` per quintile of PRS (p = `r routput$p[routput$IDcol=="TEU_SBP_PRS_quintiles_l"]`).




