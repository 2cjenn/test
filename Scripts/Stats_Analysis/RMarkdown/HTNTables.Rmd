---
title: "Prevalence and correlates of hypertension control among almost 100,000 middle-aged adults receiving treatment for hypertension in the UK: Tables and Figures"
author: "Jennifer Collister"
date: "`r format(Sys.time(), '%d %B %Y')`"
subtitle: "Commit hash: `r system('git rev-parse HEAD', intern=TRUE)`"
output: 
  word_document:
      reference_docx: "K:/TEU/TEU Guides/TEU_DocStyle_Rmd_2020.dotx"
      fig_width: 7
---

```{r setup, include=FALSE}

library(kableExtra)
library(knitr)
library(yaml)
library(here)

# Specify the markdown format for knitr tables, otherwise they're not compatible with kableExtra
options(knitr.kable.NA='', knitr.table.format = "markdown")
options(kableExtra.auto_format = FALSE)
# Set the root directory to the project directory (otherwise knitr works in the directory of the Rmd file by default)
knitr::opts_knit$set(root.dir = here::here())
knitr::opts_chunk$set(include=TRUE, echo = FALSE)

# Load the project config file for filepaths etc
config = yaml.load_file(here::here("config.yml"))

source(here::here(config$functions))

#-------------------------------------------------------------------------------------------------------------------
# Load the data 

data <- readRDS(file=here::here(file.path(config$data$analysed, "HTN_trtCVD.rds")))


# Comorbidities of interest
comorbs <- readRDS(here::here(file.path(config$data$derived, "VI_HTNcomorb.rds")))
colnames(comorbs) <- c("ID", paste0("VI_", colnames(comorbs)[-1]))
print(colnames(comorbs)[-1])
comorbs_raw <- c("VI_CVD", "VI_diabetes", "VI_afib_or_aflutter", "VI_asthma_or_COPD", "VI_migraine", "VI_epilepsy",
                 "VI_anxiety_or_stress", "VI_depression_or_bipolar", "VI_Osteoarthritis", "VI_Other_joint_disorder")
comorbs_string <- paste0(comorbs_raw, "_")

#-------------------------------------------------------------------------------------------------------------------
# Pretty variable names

pretty_names <- list(age = "age, years",
                     agegrp = "age group, years",
                     gender = "gender",
                     ethnicity = "ethnicity",
                     eth_group = "ethnic group",
                     genWhiteBrit = "genetically categorised as White British",
                     BMIcat = "BMI (categorical)",
                     Smo_Status = "smoking status",
                     weekly_alcunits = "alcohol units reported per week",
                     weekly_alccat = "alcohol units per week (categorical)",
                     PhA_METsWkAllAct = "weekly physical activity, MET minutes",
                     METs_over1200 = "weekly physical activity",
                     townsend_quint = "Townsend Deprivation Index, quintiles",
                     income = "household Income, GBP",
                     employment = "occupation type",
                     employcat = "occupation category",
                     ISCED = "highest level of education (ISCED)",
                     BirthCountryIncomeLevel = "country of birth, by income level",
                     countryResidence = "UK country of residence",
                     BowelCancerScreening = "ever screened for bowel cancer",
                     HTNdx_duration = "reported duration of hypertension, years",
                     HTNdx_durcat = "repoted duration of hypertension",
                     antiHTNmedsno = "number of antihypertensive medications",
                     FamilyHist_CVD_ = "family history of CVD",
                     comorbNumber_ = "no. of comorbidities",
                     VI_afib_or_aflutter_ = "arrhythmia (afib/flutter)",
                     VI_anxiety_or_stress_ = "anxiety",
                     VI_asthma_or_COPD_ = "asthma or COPD",
                     VI_depression_or_bipolar_ = "depression",
                     VI_diabetes_ = "diabetes",
                     VI_epilepsy_ = "epilepsy",
                     VI_CVD_ = "cardiovascular disease",
                     VI_migraine_ = "migraines",
                     VI_substance_use_ = "substance use",
                     VI_Osteoarthritis_ = "osteoarthritis",
                     VI_Other_joint_disorder_ = "other joint disorder",
                     PRS = "polygenic risk score",
                     PRS_quint = "polygenic risk score, quintiles"
                     )

#-------------------------------------------------------------------------------------------------------------------
# Setup

figure <- 1
table <- 1
suppfig <- 1
footnote_no <- 1

# Administrative censoring date
ACdate <- as.Date("01/03/2020", "%d/%m/%Y")

```

# Aim

To examine the effect of hypertension control on CVD events/outcomes, among treated hypertensives: is hypertension control associated with lower probability of CVD, following adjustment for multiple factors?

# Figure `r figure`. Flowchart illustrating selection of analytic dataset (n = `r nrow(data)`).
`r figure <- figure + 1`
![Missing BP data was fewer than 2 BP measurements, or missing answers to the prior diagnosis and treatment questions. Hypertension was defined as self-report of hypertensive medication use, or self-report of a prior diagnosis of hypertension, or mean BP >= 140 /90 mmHg at baseline assessment. Awareness was defined as self-report of a prior diagnosis of hypertension among those who were hypertensive. Treatment was defined as self-report of hypertensive medication among those who were aware. Control was defined as mean BP < 140/90 mmHg at baseline assessment, among those who were treated.](Figures/ExclFlowchartTree.png){height=700px}

# Table `r table`. Table describing total follow up time and events, and those with missing follow up data. (n=`r nrow(data)`).
`r table <- table + 1`

```{r}

# Time to HES diagnosis of CVD
data$CVDevent_time <- difftime(data$CVD_date, data$recdate, units="days") %>% as.numeric
data$CVDevent_time[data$CVDevent_time<0] <- NA # Don't count times for prevalent events
# Time to death with primary cause CVD
data$CVDdeath_time[data$CVDdeath_primary==TRUE] <- difftime(data$deathdate[data$CVDdeath_primary==TRUE], 
                                                            data$recdate[data$CVDdeath_primary==TRUE], units="days") %>%
  as.numeric
# Loss to follow up time
data$lfu_time <- difftime(data$lfudate, data$recdate, units="days") %>% as.numeric
# Administrative censoring time
data$ac_time <- difftime(ACdate, data$recdate, units="days") %>% as.numeric


data$stime <- apply(data[,c("CVDevent_time", "CVDdeath_time", "lfu_time", "ac_time")],
                    1, FUN=min, na.rm=TRUE)
data$status <- (data$stime==data$CVDevent_time & !is.na(data$CVDevent_time))  | 
  (data$stime==data$CVDdeath_time & !is.na(data$CVDdeath_time))

data$stime <- as.numeric(data$stime) / 365.25

```

```{r}
# data$stimecat <- cut(data$stime,breaks=seq(0,14,by=1))
# tab <- table(data$stimecat, data$status)

varlist <- c("agegrp","gender", "eth_group",
          "townsend_quint", "income", "employcat", "ISCED", "BirthCountryIncomeLevel", "countryResidence",
          "BMIcat", "Smo_Status", "weekly_alccat", "METs_over1200",
          "antiHTNmedsno",  "FamilyHist_CVD_",
          "BowelCancerScreening",
          "comorbNumber_")


followup_row <- function(df, prettyvar, level){
  medianfu <- pretty_dp(median(df$stime),2)
  events <- sum(df$status)
  n <- nrow(df)
  return(c(n, medianfu, events))
}

pct_ctrl <- c("**All participants**", followup_row(data))
for(var in varlist){
  prettyvar <- prettyfunc(var, pnames=pretty_names, upper=TRUE, bold=TRUE)
  pct_ctrl <- rbind(pct_ctrl, c(prettyvar, rep("", 3)))
  for(level in levels(data[[var]])){
    df <- data[data[var]==level,]
    pct_ctrl <- rbind(pct_ctrl, c(level, followup_row(df)))
  }
}
colnames(pct_ctrl) <- c("Variable", "n", "Median follow-up time, years", "Number of CVD events")
rownames(pct_ctrl) <- NULL

kable(pct_ctrl)

```


