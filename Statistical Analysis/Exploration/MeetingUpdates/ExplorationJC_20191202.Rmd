---
title: "02/12/2019 - 06/12/2019"
author: "Jennifer Collister"
date: "02/12/2019"
output: html_document

references:
- id: DeMers2019
  title: Physiology, Mean Arterial Pressure
  author:
  - family: DeMers
    given: Daniel
  - family: Wachs
    given: Dalliah
  container-title: StatPearls [Internet]
  URL: 'https://www.ncbi.nlm.nih.gov/books/NBK538226/'
  publisher: Stat Pearls Publishing
  issued:
    year: 2019
    month: 2
- id: Millar1999
  title: Pulse pressure as a risk factor for cardiovascular events in the MRC Mild Hypertension Trial
  author:
  - family: Millar
    given: Alasdair
  - family: Lever
    given: Anthony
  - family: Burke
    given: Valerie
  container-title: Journal of Hypertension
  URL: 'https://journals.lww.com/jhypertension/Fulltext/1999/17080/Pulse_pressure_as_a_risk_factor_for_cardiovascular.4.aspx'
  volume: 17
  issue: 8
  page: 1065-1072
  type: article-journal
  issued:
    year: 1999
    month: 8
# Reference format example:
# - id: fenner2012a
#   title: One-click science marketing
#   author:
#   - family: Fenner
#     given: Martin
#   container-title: Nature Materials
#   volume: 11
#   URL: 'http://dx.doi.org/10.1038/nmat3283'
#   DOI: 10.1038/nmat3283
#   issue: 4
#   publisher: Nature Publishing Group
#   page: 261-263
#   type: article-journal
#   issued:
#     year: 2012
#     month: 3
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(RSQLite)
library(methods)
library(survival)
library(knitr)
library(pander)
library(Publish)


rm(list=(ls()[ls()!="bd"]))

conn <- dbConnect(RSQLite::SQLite(), "K:/TEU/APOE on Dementia/Data Management/UKB.db")

stroke <- dbGetQuery(conn, "SELECT * FROM SURV_BP_STROKE")
stroke$S_STAT <- factor(stroke$S_STAT, levels=c("NORMAL", "HIGH", "VERY HIGH"))
stroke$D_STAT <- factor(stroke$D_STAT, levels=c("NORMAL", "HIGH", "VERY HIGH"))
stroke$S_STATo <- factor(stroke$S_STATo, levels=c("NORMAL", "HIGH", "VERY HIGH"), ordered=TRUE)
stroke$D_STATo <- factor(stroke$D_STATo, levels=c("NORMAL", "HIGH", "VERY HIGH"), ordered=TRUE)

survobj <- Surv(stroke$time, stroke$stroke)
haemobj <- Surv(stroke$htime, stroke$haem)
ischobj <- Surv(stroke$itime, stroke$isch)


pretty_surv <- function(coxr, caption="") {
  thing <- summary(coxr)
  kable(thing$coefficients, caption=caption)
}

```


```{r data, include=TRUE, echo=FALSE}
stroke$prevhyp <- stroke$HBP|stroke$hxhyp

stroke$assesshyp <- stroke$SBP>140 & stroke$DBP>90

stroke$HBPmeds <- stroke$HBPmeds==1

```

```{r hypertensivestatus, include=FALSE}
stroke$hypstat <- ""
stroke$hypstat[stroke$SBP<=120 & stroke$DBP<=80] <- "Normotensive"
stroke$hypstat[(stroke$SBP>120 & stroke$SBP<=140) | (stroke$DBP>80 & stroke$DBP<=90)] <- "Pre-Hypertensive"
stroke$hypstat[stroke$SBP>140 | stroke$DBP>90] <- "Hypertensive"
stroke$hypstat <- factor(stroke$hypstat, levels=c("Normotensive", "Pre-Hypertensive", "Hypertensive"))

table(stroke$hypstat, dnn=c("Hypertensive at baseline assessment"))
pretty_surv(coxph(survobj ~ hypstat + age, data=stroke))
```

## Hypertension diagnoses and blood pressure medication

Individuals were excluded if:

* They had previously had a stroke reported in touchscreen questionnaire/verbal interview/HES data
* Complete blood pressure data was not available

### Categorising individuals by their hypertension diagnosis and management status

We have three variables under consideration here:

* whether the participant has a diagnosis of hypertension
* whether the participant is on medication for hypertension
* whether the participant was hypertensive at their baseline assessment.

The diagnosis of hypertension could come from either the touchscreen questionnaire or the verbal interview with a trained nurse. Currently, the record of hypertensive medication is binary and comes from the question in the touchscreen questionnaire; the more detailed medication list from the verbal interview is available for subsequent refinements.

If a patient has reported that they are taking blood pressure medication, then we consider them to have had a diagnosis of hypertension, whether they explicitly reported one or not.

The threshold for classification of hypertension at baseline assessment was a blood pressure above 140/90mmHg. For the purposes of this categorisation, this is a dichotomous variable indicating whether they presented with hypertension, and does not distinguish between normotensive and pre-hypertensive individuals.

```{r tabulate, include=TRUE, echo=FALSE}
table(stroke$prevhyp, dnn=c("Previous diagnosis of hypertension"))
table(stroke$HBPmeds, dnn=c("Taking medication for hypertension"))
table(stroke$assesshyp, dnn=c("Hypertensive at baseline assessment"))

# Isolated systolic hypertension
stroke$isyshyp <- stroke$SBP>140 & stroke$DBP <= 90
# table(stroke$isyshyp, dnn=c("Isolated systolic hypertension at baseline assessment"))

```

From these we construct categories for the patients, according to the following criteria (note that there are two combinations categorised as "Untreated hypertensive"):

```{r table, echo=FALSE, message=FALSE, results='asis'}
tabl <- "
Category | Prevalent hypertension diagnosis | Hypertension medication | Hypertensive at baseline assessment|
------------------|:---------:|:---------:|:---------:|
Not hypertensive | No | No | No |
Untreated hypertensive | No | No | Yes|
Untreated hypertensive | Yes | No | Yes |
Successfully treated hypertensive | Yes | Yes | No |
Unsuccessfully treated hypertensive | Yes | Yes | Yes |
"
cat(tabl)
```

```{r hypstat, include=TRUE, echo=FALSE}

stroke$category <- ""
stroke$category[(stroke$prevhyp==0 & stroke$HBPmeds==0 & stroke$assesshyp==FALSE)] <- "Not hypertensive"
stroke$category[(stroke$prevhyp==0 & stroke$HBPmeds==0 & stroke$assesshyp==TRUE)] <- "Untreated hypertensive"
stroke$category[(stroke$prevhyp==1 & stroke$HBPmeds==0)] <- "Untreated hypertensive"
stroke$category[(stroke$HBPmeds==1 & stroke$assesshyp==FALSE)] <- "Successfully treated hypertensive"
stroke$category[(stroke$HBPmeds==1 & stroke$assesshyp==TRUE)] <- "Unsuccessfully treated hypertensive"
stroke$category <- factor(stroke$category, levels=c("Not hypertensive", "Untreated hypertensive", "Successfully treated hypertensive", "Unsuccessfully treated hypertensive"))
# 
# stroke$category <- ""
# stroke$category[(stroke$prevhyp==0 & stroke$HBPmeds==0 & stroke$hypstat=="Normotensive")] <- "Normotensive"
# stroke$category[(stroke$prevhyp==0 & stroke$HBPmeds==0 & stroke$hypstat=="Pre-Hypertensive")] <- "Pre-Hypertensive"
# stroke$category[(stroke$prevhyp==0 & stroke$HBPmeds==0 & stroke$hypstat!="Normotensive")] <- "Untreated hypertensive"
# stroke$category[(stroke$prevhyp==1 & stroke$HBPmeds==0 & stroke$hypstat!="Normotensive")] <- "Untreated hypertensive"
# stroke$category[(stroke$prevhyp==1 & stroke$HBPmeds==0 & stroke$hypstat!="Hypertensive")] <- "Successfully managed hypertensive"
# stroke$category[(stroke$HBPmeds==1 & stroke$hypstat!="Hypertensive")] <- "Successfully treated hypertensive"
# stroke$category[(stroke$HBPmeds==1 & stroke$hypstat=="Hypertensive")] <- "Unsuccessfully treated hypertensive"
# stroke$category <- factor(stroke$hypStat)

table(stroke$category, dnn=c("Number of individuals in each composite category"))
```

Running a Cox regression with this composite hypertension category as a covariate, and adjusting for age, we see that the stroke rate among hypertensive individuals who are not adequately controlling their blood pressure despite being on medication is more than double the rate among non-hypertensive individuals (the baseline category).
```{r coxregress, include=TRUE, echo=TRUE}
regress <- coxph(survobj ~ category + age, data=stroke)
pretty_surv(regress, caption="Cox regression of composite category and age against time to first stroke of any sort")
```

For completion, the regression with interaction that we discussed in the meeting is also included!
```{r coxregress2, include=TRUE, echo=TRUE}
regressInteract <- coxph(survobj ~ category * age, data=stroke)
pretty_surv(regressInteract, caption="Cox regression of composite category and age against time to first stroke of any sort")
```

Interestingly it seems that the stroke rate is higher (1.947/1.695=1.149, i.e. almost 15% higher) among succesfully treated hypertensives than among untreated hypertensives. This is unexpected, and indeed there are many trials for blood pressure lowering medications that would disagree!

One explanation could be that this is caused by diluting the group of untreated hypertensives with those who appeared hypertensive at baseline assessment but may have just been experiencing "white coat hypertension" or general stress from the assessment process. However, if we put those individuals in a separate group of "Hypertensive at assessment" and repeat the regression we see that, while those who were hypertensive at assessment without a prior diagnosis of hypertension do have a lower stroke rate than individuals with an untreated diagnosis, both rates are still lower than the individuals with successfully treated hypertension.

```{r hypstat2, include=TRUE, echo=FALSE}
stroke$category2 <- ""
stroke$category2[(stroke$prevhyp==0 & stroke$HBPmeds==0 & stroke$assesshyp==FALSE)] <- "Not hypertensive"
stroke$category2[(stroke$prevhyp==0 & stroke$HBPmeds==0 & stroke$assesshyp==TRUE)] <- "Hypertensive at assessment"
stroke$category2[(stroke$prevhyp==1 & stroke$HBPmeds==0)] <- "Untreated hypertensive"
stroke$category2[(stroke$HBPmeds==1 & stroke$assesshyp==FALSE)] <- "Successfully treated hypertensive"
stroke$category2[(stroke$HBPmeds==1 & stroke$assesshyp==TRUE)] <- "Unsuccessfully treated hypertensive"
stroke$category2 <- factor(stroke$category2, levels=c("Not hypertensive", "Hypertensive at assessment", "Untreated hypertensive", "Successfully treated hypertensive", "Unsuccessfully treated hypertensive"))

# table(stroke$category2, dnn=c("Number of individuals in each composite category"))

pretty_surv(coxph(survobj ~ age + category2, data=stroke), caption="Cox regression of composite category and age, splitting the untreated hypertensives into those with a prior diagnosis and those who did not but were hypertensive at assessment")
# pretty_surv(coxph(haemobj~ hypStat2 + age, data=stroke), caption="Haemorrhagic strokes")
# pretty_surv(coxph(ischobj~ hypStat2 + age, data=stroke), caption="Ischaemic strokes")
```

There are a couple of other possibilities - perhaps the individuals receiving medication have had hypertension for longer or more severely, and sustained more damage to their blood vessels. The individuals with "untreated hypertension" may have only recently been diagnosed, or have mild hypertension that is being controlled by other methods such as diet and weight loss.

Alternatively, perhaps for treatment to be successful and reduce the risk of stroke, it doesn't just mean reducing blood pressure from the hypertensive to the pre-hypertensive range, but actually requires blood pressures to return to normotensive levels. Here the individuals with a diagnosis of hypertension who have been taking blood pressure medication have been categorised as "Partially treated hypertensive" if their BP was pre-hypertensive at assessment, and "Successfully treated hypertensive" if they were normotensive at assesment.

```{r hypstat3, include=TRUE, echo=FALSE}
stroke$category3 <- ""
stroke$category3[(stroke$prevhyp==0 & stroke$HBPmeds==0 & stroke$assesshyp==FALSE)] <- "Not hypertensive"
stroke$category3[(stroke$prevhyp==0 & stroke$HBPmeds==0 & stroke$assesshyp==TRUE)] <- "Untreated hypertensive"
stroke$category3[(stroke$prevhyp==1 & stroke$HBPmeds==0)] <- "Untreated hypertensive"
stroke$category3[(stroke$HBPmeds==1 & stroke$hypstat=="Normotensive")] <- "Successfully treated hypertensive"
stroke$category3[(stroke$HBPmeds==1 & stroke$hypstat=="Pre-Hypertensive")] <- "Partially treated hypertensive"
stroke$category3[(stroke$HBPmeds==1 & stroke$assesshyp==TRUE)] <- "Unsuccessfully treated hypertensive"
stroke$category3 <- factor(stroke$category3, levels=c("Not hypertensive", "Untreated hypertensive", "Successfully treated hypertensive", "Partially treated hypertensive", "Unsuccessfully treated hypertensive"))

# table(stroke$category3, dnn=c("Number of individuals in each composite category"))

pretty_surv(coxph(survobj ~ age + category3, data=stroke), caption="Cox regression of composite category and age, splitting the successfully treated hypertensives into those whose blood pressure was normotensive at assessment and those for which it was pre-hypertensive.")
```

It actually seems that a greater reduction in BP is associated with a higher rate of stroke rate. Weird.

One final exploration: perhaps the stroke rate varies by type of stroke. Here we'll look at strokes that have been categorised as haemorrhagic or ischaemic, not the unspecified strokes.

```{r stroketype, include=TRUE, echo=FALSE}
pretty_surv(coxph(haemobj ~ age + category, data=stroke), caption="Cox regression of composite category and age, where the outcome is time to haemorrhagic stroke")
pretty_surv(coxph(ischobj ~ age + category, data=stroke), caption="Cox regression of composite category and age, where the outcome is time to ischaemic stroke")
```



### Considering alternative blood pressure variables: the Pulse Pressure (PP) and Mean Arterial Pressure (MAP).

Pulse pressure is defined as the difference between the systolic and diastolic blood pressures, $PP = SBP - DBP$.

Mean arterial pressure (or mean blood pressure) is defined as the average pressure in the arteries during one cardiac cycle [@DeMers2019]. It can be estimated as $MAP = \frac{SBP}{3} + 2\frac{DBP}{3}$.

Pulse pressure can be used as a predictor of cardiovascular events, and mean blood pressure has previously been found to be a strong predictor of stroke [@Millar1999].

```{r pulsePressure, include=TRUE, echo=FALSE}
stroke$SBP10 <- stroke$SBP/10
stroke$DBP10 <- stroke$DBP/10
stroke$pulsepress <- (stroke$SBP - stroke$DBP)
stroke$pulsepress10 <- stroke$pulsepress/10
stroke$meanpress <- ((stroke$SBP/3) + (2*stroke$DBP/3))
stroke$meanpress10 <- stroke$meanpress/10
# plot(stroke$age, stroke$pulsepress)
print("Correlation between systolic and diastolic blood pressure")
print(cor(stroke$SBP, stroke$DBP))
for(var in c("SBP", "DBP")) {
  print(paste0("Correlation between pulse pressure and ", var))
  print(cor(stroke$pulsepress, stroke[[var]]))
}
for(var in c("SBP", "DBP")) {
  print(paste0("Correlation between mean arterial pressure and ", var))
  print(cor(stroke$meanpress, stroke[[var]]))
}
print("Correlation between mean arterial pressure and pulse pressure")
print(cor(stroke$meanpress, stroke$pulsepress))
```
From the way in which the mean arterial pressure is estimated, it is not surprising that it is highly correlated with both the systolic and diastolic blood pressures.

The pulse pressure is more interesting, as it is highly correlated with systolic blood pressure but much less with diastolic.

```{r pulsePressPlot, include=TRUE, echo=FALSE, out.width='40%'}
plot(stroke$SBP, stroke$pulsepress, main="Pulse pressure against Systolic BP")
plot(stroke$DBP, stroke$pulsepress, main="Pulse pressure against Diastolic BP")
```

```{r pulsePressRegress, include=TRUE, echo=FALSE}

print("Cox regression of systolic blood pressure and age against all stroke")
publish(coxph(survobj~ SBP10 + age, data=stroke), units=list("SBP10"="10mmHg", "age"="years"))
print("Cox regression of diastolic blood pressure and age against all stroke")
publish(coxph(survobj~ DBP10 + age, data=stroke), units=list("DBP10"="10mmHg", "age"="years"))
print("Cox regression of pulse pressure and age against all stroke")
publish(coxph(survobj~ pulsepress10 + age, data=stroke), units=list("pulsepress10"="10mmHg", "age"="years"))
print("Cox regression of mean arterial pressure and age against all stroke")
publish(coxph(survobj~ meanpress10 + age, data=stroke), units=list("meanpress10"="10mmHg", "age"="years"))
print("Cox regression of pulse pressure, mean arterial pressure and age against all stroke")
publish(coxph(survobj~ pulsepress10 + meanpress10 + age, data=stroke), units=list("pulsepress10"="10mmHg", "meanpress10"="10mmHg", "age"="years"))
#

```

# References

