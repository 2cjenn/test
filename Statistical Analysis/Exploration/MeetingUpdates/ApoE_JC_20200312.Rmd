---
title: "Checking if gender modifies the effect of BP control on stroke"
author: "Jennifer Collister"
date: "12/03/2020"
output: 
  word_document:
      reference_docx: "K:/TEU/APOE on Dementia/RMarkdownStyle.docx"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(kableExtra)
library(knitr)
library(survival)
library(survminer)
library(lmtest)
library(DiagrammeR)
library(DiagrammeRsvg)
library(magrittr)
library(svglite)
library(rsvg)
library(png)

source("K:/TEU/APOE on Dementia/Statistical Analysis/JCfunctions.R")

data <- readRDS(file="K:\\TEU\\APOE on Dementia\\Data Management\\R_Dataframes_TLA\\38358\\Organised\\Hypertension\\APOE\\apoe_excl.rds")

data <- data[data$age>=60,]

stroke <- readRDS("K:\\TEU\\APOE on Dementia\\Data Management\\R_Dataframes_TLA\\38358\\Organised\\stroke.rds")
data <- merge(data, stroke, by="ID", all.x=TRUE)

```

```{r stroke_surv, include=TRUE, echo=FALSE}

# Individuals with stroke as a cause of death should be included as having stroke
data$event2date <- data$stroke_date
data$event2date[data$strdeath==TRUE] <- pmin(data$stroke_date[data$strdeath==TRUE], data$deathdate[data$strdeath==TRUE], na.rm=TRUE)

# Time to HES-recorded diagnosis of stroke
data$strtime <- as.numeric(difftime(data$event2date, data$recdate, unit='days'))
data$strtime[data$strtime<0] <- NA

# For the survival analysis, we want the time until the first of these end points
data$time_to_stroke <- pmin(data$strtime, data$deathtime, data$lfutime, data$actime, na.rm=TRUE)
data$time_to_stroke_yrs <- data$time_to_stroke/365.25
# The status is whether they received a dementia diagnosis by the end point
data$stroke_status <- (!is.na(data$strtime) & data$strtime == data$time_to_stroke)

```

# Whole population breakdown by gender

Here we use the same population as in the dementia analysis to enable a direct comparison, namely individuals age [60,70), excluding those with prevalent dementia or incomplete BP data  (n=`r nrow(data)`).

```{r genderbreakdown, include=TRUE}
gender <- c("Female", "Male")
dflist <- c(list("Whole population"=data), 
            lapply(gender, function(x) data[data$gender==x,])
            )
names(dflist) <- c("Whole population", paste0("UKB ", gender, "\npopulation"))
filenames <- list("Wholepop", "Female", "Male")
names(filenames) <- names(dflist)

grlist <- list()
for(dfname in names(dflist)){
  df <- dflist[[dfname]]
  nlist <- list(wholepop=nrow(df))
  pctlist <- list()
  for(variable in c("evidenceHTN", "aware", "treated", "controlled")){
    var <- paste0(variable, "_")
    tab <- table(df[[var]])
    pct <- round(100*prop.table(tab),1)
    nlist[[variable]] <- tab
    pctlist[[variable]] <- pct
  }
  export_svg(DiagrammeR::grViz("K:\\TEU\\APOE on Dementia\\Statistical Analysis\\Exploration\\MeetingUpdates\\HTNtree.gv")) %>% charToRaw %>% rsvg %>% png::writePNG(paste0(filenames[[dfname]],'.png'))
}

```

![Females](K:/TEU/APOE on Dementia/Statistical Analysis/Exploration/MeetingUpdates/Female.png)

![Males](K:/TEU/APOE on Dementia/Statistical Analysis/Exploration/MeetingUpdates/Male.png)

# Restrict to those receiving treatment (n = `r nrow(data[data$treated==TRUE & !is.na(data$treated),])`)

We have restricted the population to those receiving treatment in order to investigate the effect of control, which is not relevant to those who are not treated.

```{r strokeincidence, include=TRUE, echo=FALSE}
# For this analysis, we want to consider individuals receiving treatment for hypertension
data <- data[data$treated==TRUE & !is.na(data$treated),]

tab1 <- addmargins(table(data$controlled_, data$gender))
tab2 <- addmargins(table(data$controlled_[data$stroke_status==TRUE], data$gender[data$stroke_status==TRUE]))
  
tabpct <- round(100*tab2/tab1,2)
  
prettytab <- tab2
for(i in c(1:dim(tab1)[1])){
  for(j in c(1:dim(tab1)[2])){
    prettytab[i,j] <- paste0(tab2[i,j], "/", tab1[i,j], " (", tabpct[i,j], "%)")
  }
}
kable(prettytab, caption=paste0("Among the treated population the number of stroke cases out of total individuals in each category is:"))

```

From a crude table of stroke cases categorised by gender and control status, we see a higher prevalence of stroke among men than among women, as we would expect from previous knowledge.

Although we are again seeing the faint suggestion of an additive interaction between gender and control it is much less pronounced than when dementia was the outcome:

* Among females, the risk difference between "uncontrolled" and "controlled" is `r tabpct[1,1]` - `r tabpct[2,1]` = `r tabpct[1,1]- tabpct[2,1]`
* Among males, the risk difference between "uncontrolled" and "controlled" is `r tabpct[1,2]` - `r tabpct[2,2]` = `r tabpct[1,2]- tabpct[2,2]`

This gives `r tabpct[1,2]- tabpct[2,2]` - `r tabpct[1,1]- tabpct[2,1]` = `r (tabpct[1,2]- tabpct[2,2]) - (tabpct[1,1]- tabpct[2,1])` < 0 which is evidence of a negative additive interaction.

Similarly, if we calculate the risk ratios to consider the possibility of a multiplicative interaction:

* Among females, the risk ratio between "uncontrolled" and "controlled" is `r tabpct[1,1]` / `r tabpct[2,1]` = `r tabpct[1,1]/ tabpct[2,1]`
* Among males, the risk ratio between "uncontrolled" and "controlled" is `r tabpct[1,2]` / `r tabpct[2,2]` = `r tabpct[1,2]/ tabpct[2,2]`

This gives `r tabpct[1,2] / tabpct[2,2]` - `r tabpct[1,1] / tabpct[2,1]` = `r (tabpct[1,2] / tabpct[2,2]) / (tabpct[1,1] / tabpct[2,1])` < 1 which is evidence of a negative multiplicative interaction.

To formally investigate this, we use a Cox model, and add the interaction term between gender and control.

# Cox regression of gender and control, controlling for age and e4 carrier status

```{r genderHR, include=TRUE, echo=FALSE}

model1 <- coxph(Surv(time_to_stroke, stroke_status) ~ age + e4carrier_ + gender + controlled_, 
                data=data)
kable(printcoxresults(model1), 
      caption=paste0("Cox regression of age, e4 carrier status, gender and control status against time to stroke among participants who are taking BP medication, n=", model1$n))

```


```{r interaction, include=TRUE, echo=FALSE}
model2 <- coxph(Surv(time_to_stroke, stroke_status) ~ age + e4carrier_ + gender * controlled_, 
                data=data)
kable(printcoxresults(model2), 
      caption=paste0("Cox regression of age, e4 carrier status, gender and control status against time to stroke among participants who are taking BP medication, with interaction term between gender and control, n=", model2$n))

```

As we suspected, there is not a statistically significant multiplicative interaction between gender and control in this model.

# Likelihood ratio test

Since these models are nested, we can use the likelihood ratio to see whether the addition of the interaction term improves the model fit.

```{r lrtest, include=TRUE, echo=FALSE}
lr <- lrtest(model2, model1)
pval <- lr$`Pr(>Chisq)`[2]
lr

```

In this case, the p-value of `r pval` is not statistically significant. 