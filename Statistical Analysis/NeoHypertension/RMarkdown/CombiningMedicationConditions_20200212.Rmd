---
title: "Hypertension Medication Exploration"
author: "Jennifer Collister"
date: "07/02/2020"
output: 
  word_document:
      reference_docx: "K:/TEU/APOE on Dementia/RMarkdownStyle.docx"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(kableExtra)
library(knitr)

source("K:/TEU/APOE on Dementia/Statistical Analysis/JCfunctions.R")

```

```{r loaddata, include=FALSE}
data <- readRDS(file="K:\\TEU\\APOE on Dementia\\Data Management\\R_Dataframes_TLA\\38358\\Organised\\apoe_excl.rds")
# data <- data[data$age >= 50 & data$age < 70,]

# Create a couple of factor variables
data$selfrephyp <- data$prevHBP==TRUE | data$VIhyp==TRUE
data$control <- !(data$SBP>=140 | data$DBP>=90)

# Center age on the minimum
data$c_age <- data$age - 50

# Make the key dichotomous variables into factors to improve readability of outputs
data$selfrephyp <- factor(as.numeric(data$selfrephyp), levels=c(0,1), labels=c("Did not report hypertension", "Self-reported hypertensive"))
data$prevHBP <- factor(as.numeric(data$prevHBP), levels=c(0,1), labels=c("Did not report hypertension", "Self-reported hypertensive in touchscreen questionnaire"))
data$VIhyp <- factor(as.numeric(data$VIhyp), levels=c(0,1), labels=c("Did not report hypertension", "Self-reported hypertensive in verbal interview"))
data$measuredhyp <- factor(as.numeric(data$measuredhyp), levels=c(0,1), labels=c("Not hypertensive at baseline", "Measured hypertensive at baseline"))
data$HBPmeds <- factor(as.numeric(data$HBPmeds), levels=c(0,1), labels=c("Did not report BP medication", "Self-reported BP medication"))
data$control <- factor(as.numeric(data$control), levels=c(0,1), labels=c("Inadequately controlled", "Successfully controlled"))

# table(data$selfrephyp, useNA='ifany')
# table(data$HBPmeds[data$selfrephyp=="Self-reported hypertensive"], useNA='ifany')
# table(data$control[data$selfrephyp=="Self-reported hypertensive" & data$HBPmeds=="Self-reported BP medication"], useNA='ifany')
# table(data$measuredhyp[data$selfrephyp=="Did not report a diagnosis"], useNA='ifany')
```

There are 502,520 individuals in UKB, of whom 363,983 are recorded as taking at least one medication during the verbal interview. The others have NA, which probably means that they are not taking any medication, but could in some cases mean that they were not asked about it - I don't think we have any way of knowing for certain. There are 112,372 individuals taking medications which we have classified as potential anti-hypertensives.

In the data-set we're using for the APOE analysis, we consider only individuals in the age range of [50,70) with white ethnicity, data on measured blood pressure at baseline, and no previous history of dementia. After these exclusions there are 442,767 individuals in our data set, 322,033 of whom are recorded as taking at least one medication, and 98,121 of these are taking medications we have classified as anti-hypertensives.


```{r VImedsData, include=TRUE, echo=FALSE}

# VImeds <- readRDS(file="K:\\TEU\\APOE on Dementia\\Data Management\\R_Dataframes_TLA\\38358\\Organised\\VIhypmeds.rds")
load("K:\\TEU\\APOE on Dementia\\Data Management\\R_Dataframes_TLA\\38358\\Organised\\VIhypmeds.RData")

sums <- colSums(VImeds[,hypclasslist], na.rm=TRUE)
kable((sums), caption="Number of individuals taking each of the main drug classes (individuals can be taking drugs from multiple classes)")
# sum(rowSums(VImeds[,-c(1)], na.rm=TRUE)==0)

```

Defining our hypertensive medication categories,

* Step 1/2: Taking one or more of ACEi, ARB, CCB WITHOUT a thiazide-like diuretic
* Step 3: Taking Step 1/2 drug(s) AND a thiazide-like diuretic
* Step 4: Taking a Step 3 combination of drugs AND an AB, BB or other diuretic
* Step 5 - Resistant hypertension: Taking a Step 4 combination of drugs AND a specialist drug
* Thiazide only: Taking ONLY a thiazide-like diuretic
* BB only: Taking ONLY a BB
* Step 4 without thiazide: Taking one or more of ACEi, ARB, CCB AND an AB, BB or Spironolactone WITHOUT thiazide
* Thiazide + AB/BB/Spiro: Taking a thiazide-like diuretic AND an AA, BB or Spironolactone WITHOUT ACEi/ARB or CCB
* All other non-standard combinations: for example, taking a specialist drug without the full Step 4 combination of drugs

Note: This amalgamates changing NICE guidelines from various years.


```{r Groups, include=TRUE, echo=FALSE}

# Line 1 drugs: Ace Inhibitors (ACEI), Angiotensin II receptor blockers (ARBs) and Calcium Channel Blockers (CCB)
VImeds$line1 <- rowSums(VImeds[,c("ACEI", "ARBs", "CCB")], na.rm=TRUE)>0
# Line 2 drugs: Beta blocker (BB), Alpha blocker (AB) or Spironolactone
VImeds$line2 <- rowSums(VImeds[,c("AB", "BB", "Potassium-sparing diuretic")], na.rm=TRUE)>0
VImeds$onlyone <- rowSums(VImeds[,hypclasslist], na.rm=TRUE)==1

# * Step 1/2: Taking one or more of ACEi, ARB, CCB WITHOUT a thiazide-like diuretic
# * Step 3: Taking Step 1/2 drug(s) AND a thiazide-like diuretic
# * Step 4: Taking a Step 3 combination of drugs AND an AB, BB or Spironolactone
# * Thiazide only: Taking ONLY a thiazide-like diuretic
# * BB only: Taking ONLY a BB
# * Step 4 without thiazide: Taking one or more of ACEi, ARB, CCB AND an AB, BB or Spironolactone WITHOUT thiazide
# * Thiazide + AB/BB/Spiro: Taking a thiazide-like diuretic AND an AA, BB or Spironolactone WITHOUT ACEi/ARB or CCB
# * All other non-standard combinations: Taking at least one medication categorised as potentially anti-hypertensive but doesn't fit into any of above groups (i.e. an AB, Spironolactone, Potassium-sparing diuretic, Vasodilator, or Other)

# VImeds$grp1 <- VImeds$line1 & is.na(VImeds[["Thiazide"]]) & !VImeds$line2
# VImeds$grp2 <- VImeds$line1 & !is.na(VImeds[["Thiazide"]]) & !VImeds$line2
# VImeds$grp3 <- VImeds$line1 & !is.na(VImeds[["Thiazide"]]) & VImeds$line2
# VImeds$grp4 <- !VImeds$line1 & !is.na(VImeds[["Thiazide"]]) & !VImeds$line2
# VImeds$grp5 <- !VImeds$line1 & is.na(VImeds[["Thiazide"]]) & !is.na(VImeds[["BB"]])
# VImeds$grp6 <- VImeds$line1 & is.na(VImeds[["Thiazide"]]) & VImeds$line2
# VImeds$grp7 <- !VImeds$line1 & !is.na(VImeds[["Thiazide"]]) & VImeds$line2

# VImeds$hypgrp <- ifelse(VImeds$grp1==TRUE, "Step 1/2", ifelse(VImeds$grp2==TRUE, "Step 3", ifelse(VImeds$grp3==TRUE, "Step 4", ifelse(VImeds$grp4==TRUE, "Thiazide only", ifelse(VImeds$grp5==TRUE, "BB only", ifelse(VImeds$grp6==TRUE, "Step 4 without thiazide", ifelse(VImeds$grp7==TRUE, "Thiazide + AB/BB/Spiro", VImeds$hypmeds)))))))

VImeds$step12 <- VImeds$line1 & is.na(VImeds[["Thiazide"]]) & !VImeds$line2 & is.na(VImeds[["Other"]])
VImeds$step3 <- VImeds$line1 & !is.na(VImeds[["Thiazide"]]) & !VImeds$line2 & is.na(VImeds[["Other"]])
VImeds$step4 <- VImeds$line1 & !is.na(VImeds[["Thiazide"]]) & VImeds$line2 & is.na(VImeds[["Other"]])
VImeds$step5 <- VImeds$line1 & !is.na(VImeds[["Thiazide"]]) & VImeds$line2 & !is.na(VImeds[["Other"]])
VImeds$thiaonly <- !is.na(VImeds[["Thiazide"]]) & VImeds$onlyone
VImeds$BBonly <- !is.na(VImeds[["BB"]]) & VImeds$onlyone
VImeds$weird1 <- VImeds$line1 & is.na(VImeds[["Thiazide"]]) & VImeds$line2 & is.na(VImeds[["Other"]])
VImeds$weird2 <- !VImeds$line1 & !is.na(VImeds[["Thiazide"]]) & VImeds$line2 & is.na(VImeds[["Other"]])

# Group 2: 1st, 2nd or 3rd line drugs plus Spironolactone or Alpha Blocker (AB)


VImeds$hypgrp <- ifelse(VImeds$step12==TRUE, "Step 1/2", ifelse(VImeds$step3==TRUE, "Step 3", ifelse(VImeds$step4==TRUE, "Step 4", ifelse(VImeds$step5==TRUE, "Step 5", ifelse(VImeds$thiaonly==TRUE, "Thiazide only", ifelse(VImeds$BBonly==TRUE, "BB only", ifelse(VImeds$weird1==TRUE, "Step 4 without thiazide", ifelse(VImeds$weird2==TRUE, "Step 4 without Step 1/2 drugs", VImeds$hypmeds))))))))


medsdata <- merge(data[,c("ID", "Sex", "measuredhyp", "selfrephyp", "HBPmeds", "medication", "VIhyp", "prevHBP")], 
                  VImeds,#[,c("ID", "grp1", "grp2", "grp1T", "grp2T", "hypgrp", "hypmeds")], 
                  by="ID", all.x=TRUE)
medsdata$hypmeds[is.na(medsdata$hypmeds)] <- "Not taking any medication"
medsdata$hypgrp[is.na(medsdata$hypgrp)] <- "Not taking any medication"
medsdata$hypgrp[medsdata$hypgrp=="Taking potential BP medication"] <- "Other non-standard combination of potential BP medication"
medsdata$hypgrp <- factor(medsdata$hypgrp, levels=c("Step 1/2", "Step 3", "Step 4", "Step 5", "Thiazide only", "BB only", "Step 4 without thiazide", "Step 4 without Step 1/2 drugs", "Other non-standard combination of potential BP medication", "Taking non-BP medication", "Not taking any medication"))

saveRDS(medsdata, file="K:\\TEU\\APOE on Dementia\\Data Management\\R_Dataframes_TLA\\38358\\Organised\\Neo\\ClassifiedHypMedGroups.rds")

```

```{r tabulate, include=TRUE, echo=FALSE}

kable(propped(table(medsdata$hypmeds,medsdata$HBPmeds, useNA='ifany'), margin=2), caption="Self-reported medication vs roughly categorised medication - before refining whether individuals taking potentially anti-hypertensive medication are likely to be taking them for BP control or other reasons")

kable(propped(table(medsdata$hypmeds,medsdata$selfrephyp, useNA='ifany'), margin=2), caption="Self-reported hypertensive diagnosis vs roughly categorised medication - before refining whether individuals taking potentially anti-hypertensive medication are likely to be taking them for BP control or other reasons")

# kable(propped(table(medsdata$hypgrp, medsdata$HBPmeds, useNA='ifany'), margin=2), caption="Tabulation to check agreement between reported BP medication and actual meds taken, within the whole population")

kable(propped(table(medsdata$hypgrp[medsdata$hypmeds=="Taking potential BP medication"], medsdata$HBPmeds[medsdata$hypmeds=="Taking potential BP medication"], useNA='ifany'), margin=2), caption="Tabulation to check agreement between reported BP medication and actual meds taken, within participants who are taking potential BP medication")
```

Consider the individuals who did not report a diagnosis of hypertension, but are taking medications that we consider to be potential BP meds.

```{r nohypbutmed, include=TRUE, echo=FALSE}

sums <- colSums(medsdata[medsdata$selfrephyp=="Did not report hypertension",hypclasslist], na.rm=TRUE)
kable((sums), caption="Individuals who did NOT report a diagnosis of hypertension but are taking each of the main hypertensive drug classes (Total n = 10,115, individuals can be taking drugs from multiple classes)")

kable(propped(table(medsdata$hypgrp[medsdata$selfrephyp=="Did not report hypertension" & !is.na(medsdata$selfrephyp) & medsdata$hypmeds=="Taking potential BP medication"], medsdata$HBPmeds[medsdata$selfrephyp=="Did not report hypertension" & !is.na(medsdata$selfrephyp) & medsdata$hypmeds=="Taking potential BP medication"], useNA='ifany'), margin=2), caption="Tabulation to check agreement between reported BP medication and actual meds taken, within participants who did NOT report a diagnosis of hypertension but are taking potential BP medication")

```


For each of these groups, we can consider the proportion of individuals who self-reported a diagnosis of hypertension or blood pressure medications in the touchscreen questionnaire

```{r othertables, include=TRUE, echo=FALSE}
kable(propped(table(medsdata$hypgrp, medsdata$prevHBP, useNA='ifany'),margin=1),caption="Medication group vs hypertension diagnosis reported in touchscreen questionnaire")

kable(propped(table(medsdata$hypgrp, medsdata$HBPmeds, useNA='ifany'),margin=1),caption="Medication group vs BP medication status reported in touchscreen questionnaire")

```

Alternatively, looking within each medication group individually, we can crosstab the touchscreen responses to diagnosis of hypertension and blood pressure medications:

```{r bygroup, include=TRUE, echo=FALSE}

group1 <- medsdata[medsdata$hypgrp == "Step 1/2",]
kable(propped(table(group1$HBPmeds, group1$prevHBP, useNA='ifany'),margin=2), caption="Step 1/2: ACEi/ARB or CCB")

group2 <- medsdata[medsdata$hypgrp == "Step 3",]
kable(propped(table(group2$HBPmeds, group2$prevHBP, useNA='ifany'),margin=2), caption="Step 3: [ACEi/ARB or CCB] + Thiazide-like diuretic")

group3 <- medsdata[medsdata$hypgrp == "Step 4",]
kable(propped(table(group3$HBPmeds, group3$prevHBP, useNA='ifany'),margin=2), caption="Step 4: [ACEi/ARB or CCB] + Thiazide-like diuretic + [AB/BB/Other diuretic]")

group4 <- medsdata[medsdata$hypgrp == "Step 5",]
kable(propped(table(group4$HBPmeds, group4$prevHBP, useNA='ifany'),margin=2), caption="Step 5: [ACEi/ARB or CCB] + Thiazide-like diuretic + [AB/BB/Other diuretic] + Specialist drug")

group5 <- medsdata[medsdata$hypgrp == "Thiazide only",]
kable(propped(table(group5$HBPmeds, group5$prevHBP, useNA='ifany'),margin=2), caption="Thiazide only")

group6 <- medsdata[medsdata$hypgrp == "BB only",]
kable(propped(table(group6$HBPmeds, group6$prevHBP, useNA='ifany'),margin=2), caption="BB only")

group7 <- medsdata[medsdata$hypgrp == "Step 4 without thiazide",]
kable(propped(table(group7$HBPmeds, group7$prevHBP, useNA='ifany'),margin=2), caption="[ACEi/ARB or CCB] + [AB/BB/Spironolactone] WITHOUT Thiazide")

group8 <- medsdata[medsdata$hypgrp == "Step 4 without Step 1/2 drugs",]
kable(propped(table(group8$HBPmeds, group8$prevHBP, useNA='ifany'),margin=2), caption="Thiazide + [AB/BB/Spironolactone] WITHOUT [ACEi/ARB or CCB]")

group9 <- medsdata[medsdata$hypgrp == "Other non-standard combination of potential BP medication",]
kable(propped(table(group9$HBPmeds, group9$prevHBP, useNA='ifany'),margin=2), caption="Other non-standard combination of potential BP medication")

```

