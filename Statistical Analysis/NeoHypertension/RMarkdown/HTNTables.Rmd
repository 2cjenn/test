---
title: "Prevalence and correlates of hypertension control among almost 100,000 middle-aged adults receiving treatment for hypertension in the UK"
author: "Jennifer Collister"
date: "12/05/2020"
output: 
  word_document:
      reference_docx: "K:/TEU/APOE on Dementia/RMarkdownStyle.docx"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(kableExtra)
library(knitr)
library(DiagrammeR)
library(DiagrammeRsvg)
library(magrittr)
library(svglite)
library(rsvg)
library(png)
library(DescTools)
library(ggplot2)
library(forcats)
library(gridExtra)

source("K:/TEU/APOE on Dementia/Statistical Analysis/JCfunctions.R")
options(knitr.kable.NA='')

data <- readRDS(file="K:\\TEU\\APOE on Dementia\\Data Management\\R_Dataframes_TLA\\38358\\Organised\\Hypertension\\Neo\\HTN_excl.rds")


# Comorbidities of interest
comorbs <- readRDS("K:\\TEU\\APOE on Dementia\\Data Management\\R_Dataframes_TLA\\38358\\Organised\\Hypertension\\Neo\\VI_HTNcomorb.rds")
colnames(comorbs) <- c("ID", paste0("VI_", colnames(comorbs)[-1]))
print(colnames(comorbs)[-1])
comorbs_raw <- c("VI_afib_or_aflutter", "VI_CVD", "VI_diabetes", "VI_asthma_or_COPD", "VI_migraine", "VI_epilepsy",
                 "VI_anxiety_or_stress", "VI_depression_or_bipolar", "VI_Osteoarthritis", "VI_Other_joint_disorder")
comorbs_string <- paste0(comorbs_raw, "_")

# Principal components
pclist <- paste0("GeP_PC.m",seq(1,10))

#-------------------------------------------------------------------------------------------------------------------
# Datasets:

# For the SES descriptive analyses, we want to consider two subsets: all hypertensives and all treated individuals
hypertensives <- data[data$evidenceHTN==TRUE & !is.na(data$evidenceHTN),]
treated <- data[data$treated==TRUE & !is.na(data$treated),]

# Among the treated, those who did not list any HTN meds in VI are assumed to be taking unlisted meds
treated$antiHTNmedsno <- factor(treated$antiHTNmedsno, levels=c("1", "2", ">=3", "0"),
                                labels=c("1", "2", ">=3",  "Medication list unavailable"))

# For the genetic analyses, we will consider only the genetically caucasian individuals
white <- data[data$genWhiteBrit=="White British",]
white_trt <- treated[treated$genWhiteBrit=="White British",]

pretty_names <- list(agegrp = "Age group",
                     gender = "Gender",
                     ethnicity = "Ethnicity",
                     eth_group = "Ethnic group",
                     genWhiteBrit = "Genetically categorised as White British",
                     BMIcat = "BMI (categorical)",
                     Smo_Status = "Smoking status",
                     weekly_alcunits = "Alcohol units per week",
                     weekly_alccat = "Alcohol units per week (categorical)",
                     PhA_METsWkAllAct = "Weekly physical activity, in METs",
                     METs_over1200 = "Sufficient physical activity",
                     townsend_quint = "Townsend Deprivation Index, quintiles",
                     income = "Household Income, GBP",
                     employment = "Occupation type",
                     employcat = "Occupation category",
                     ISCED = "Highest level of education (ISCED)",
                     BirthCountryIncomeLevel = "Country of birth, by income level",
                     countryResidence = "UK country of residence",
                     BowelCancerScreening = "Ever screened for bowel cancer",
                     HTNdx_durcat = "Duration of hypertension (categorical)",
                     antiHTNmedsno = "Number of antihypertensive medications",
                     FamilyHist_CVD_ = "Family history of CVD",
                     comorbNumber_ = "No. of comorbidities",
                     VI_afib_or_aflutter_ = "Arrhythmia (afib/flutter)",
                     VI_anxiety_or_stress_ = "Anxiety",
                     VI_asthma_or_COPD_ = "Asthma or COPD",
                     VI_depression_or_bipolar_ = "Depression",
                     VI_diabetes_ = "Diabetes",
                     VI_epilepsy_ = "Epilepsy",
                     VI_CVD_ = "Cardiovascular disease",
                     VI_migraine_ = "Migraines",
                     VI_substance_use_ = "Substance use",
                     VI_Osteoarthritis_ = "Osteoarthritis",
                     VI_Other_joint_disorder_ = "Other joint disorder",
                     PRS = "Polygenic risk score",
                     PRS_quint = "Polygenic risk score, quintiles",
                     GeP_PC.m1 = "Principal Component 1",
                     GeP_PC.m2 = "PC 2",
                     GeP_PC.m3 = "PC 3",
                     GeP_PC.m4 = "PC 4",
                     GeP_PC.m5 = "PC 5",
                     GeP_PC.m6 = "PC 6",
                     GeP_PC.m7 = "PC 7",
                     GeP_PC.m8 = "PC 8",
                     GeP_PC.m9 = "PC 9",
                     GeP_PC.m10 = "PC 10"
                     )
prettyfunc <- function(x){
  if(x %in% names(pretty_names)){
     return(pretty_names[[x]])
  } else {
    return(x)
  }
}
```

![Exclusion Flowchart.](K:/TEU/APOE on Dementia/Statistical Analysis/NeoHypertension/RMarkdown/ExclFlowchart.png)



# Figure 2. Prevalence of hypertension, and its awareness, treatment and control among adults aged 40-69 years in the UKB (n = `r nrow(data)`).

```{r fig2, include=TRUE, echo=FALSE, results='asis'}

dflist <- c(list("Whole population"=data, "Females"=data[data$gender=="Female",], "Males"=data[data$gender=="Male",]))
# names(dflist) <- c("Whole population")
filenames <- list("Wholepop", "Females", "Males")
names(filenames) <- names(dflist)

grlist <- list()
for(dfname in names(dflist)){
  df <- dflist[[dfname]]
  nlist <- list(wholepop=nrow(df))
  pctlist <- list()
  for(variable in c("evidenceHTN", "aware", "treated", "controlled")){
    var <- paste0(variable, "_")
    tab <- table(df[[var]])
    pct <- round(100*prop.table(tab),1)
    nlist[[variable]] <- tab
    pctlist[[variable]] <- pct
  }
  export_svg(DiagrammeR::grViz("K:\\TEU\\APOE on Dementia\\Statistical Analysis\\NeoHypertension\\RMarkdown\\HTNtree.gv")) %>% charToRaw %>% rsvg %>% png::writePNG(paste0('K:/TEU/APOE on Dementia/Statistical Analysis/NeoHypertension/RMarkdown/',filenames[[dfname]],'.png'))
}

```
![](K:/TEU/APOE on Dementia/Statistical Analysis/NeoHypertension/RMarkdown/Wholepop.png)

# Table 1: Prevalence of hypertension control among treated hypertensives (n = `r nrow(treated)`), by socioeconomic characteristics and comorbidity type

```{r table1, include=TRUE, echo=FALSE}

desctable2 <- function(df){
  n <- nrow(df)
  median_age <- pretty_dp(median(df$age),1)
  median_SBP <- pretty_dp(median(df$SBP),1)
  median_DBP <- pretty_dp(median(df$DBP),1)
  control <- prop.test(x=nrow(df[df$controlled==TRUE & !is.na(df$controlled),]),
                           n=nrow(df), alternative="two.sided", conf.level=0.95)
  pct_control <- pretty_dp(control$estimate, dp=1, pct=TRUE)
  ci_control <- pretty_confint(control$conf.int[1], control$conf.int[2], dp=1, pct=TRUE)
  
  table <- cbind(n, median_age, paste0(median_SBP,"/",median_DBP), pct_control, ci_control)
  return(table)
}

treated$wholepop <- factor(1, levels=c(1), labels=c("All treated hypertensives"))
varlist=c("wholepop", "agegrp", "gender", "eth_group",
          "townsend_quint", "income", "employcat", "ISCED", "BirthCountryIncomeLevel", "countryResidence",
          "BMIcat", "Smo_Status", "weekly_alccat", "METs_over1200",
          "HTNdx_durcat", "antiHTNmedsno",  "FamilyHist_CVD_", 
          "comorbNumber_",
          "BowelCancerScreening")

tab1 <- c()
for(var in varlist){
  for(level in levels(treated[[var]])){
    newrow <- desctable2(treated[treated[var]==level,])
    tab1 <- rbind(tab1, cbind(level, newrow))
  }
}
for(comorb in comorbs_string){
  newrow <- desctable2(treated[treated[comorb]=="Yes",])
  tab1 <- rbind(tab1, cbind(prettyfunc(comorb), newrow))
}

rownames(tab1) <- c(unlist(sapply(varlist, function(x) c(prettyfunc(x), rep("", (nlevels(treated[[x]])-1))))),
                    "Comorbidities", rep("", length(comorbs_string)-1))

colnames(tab1) <- c("", "n", "Median age", "Median SBP/DBP", "% Controlled", "95% CI Controlled")
kable(tab1)

```

# Table 2. Characteristics of treated hypertensives, by blood pressure control status (n = `r nrow(treated)`).


```{r table2, include=TRUE, echo=FALSE}
varlist=c("age", "agegrp", "gender", "eth_group",
          "townsend_quint", "income", "employcat", "ISCED", "BirthCountryIncomeLevel", "countryResidence",
          "BMIcat", "Smo_Status", "weekly_alcunits", "weekly_alccat", "PhA_METsWkAllAct", "METs_over1200",
          "HTNdx_durcat", "antiHTNmedsno",  "FamilyHist_CVD_", 
          "comorbNumber_", comorbs_string,
          "BowelCancerScreening")

tab_c <- descriptivetable(df=treated[treated$controlled==TRUE,], 
                         varlist=varlist,
                         contavg='median',
                         pretty_names=pretty_names)

tab_u <- descriptivetable(df=treated[treated$controlled==FALSE,], 
                         varlist=varlist,
                         contavg='median',
                         pretty_names=pretty_names)

tab_o <- descriptivetable(df=treated, 
                         varlist=varlist,
                         contavg='median',
                         pretty_names=pretty_names)

uni <- regressiontable(df=treated, outcome="controlled", varlist=varlist, 
                       regresstype="univariable")

tab2 <- cbind(tab_c, tab_u[,3:4], tab_o[,3:4], as.matrix(uni)[,4:5])
tab2 <- rbind(colnames(tab2), tab2)
colnames(tab2) <- c("", "", 
    paste0("Controlled, n=", nrow(treated[treated$controlled==TRUE,])), "", 
    paste0("Uncontrolled, n=", nrow(treated[treated$controlled==FALSE,])), "",
    paste0("Overall, n=", nrow(treated)), "", "", ""
    )

kable(tab2)

```

# Table 3: Multivariable logistic regression identifying factors associated with hypertension control (BP < 140/90 mmHg), among UK adults on antihypertensive treatment (n=`r nrow(treated)`)

<div custom-style="Todo">Reminder: Manually re-order BMI categories</div>

```{r table3, include=TRUE, echo=FALSE}

varlist=c("agegrp", "gender", "eth_group",
          "townsend_quint", "income", "employcat", "ISCED", "BirthCountryIncomeLevel", "countryResidence",
          "BMIcat", "Smo_Status", "weekly_alccat", "METs_over1200",
          "antiHTNmedsno",  "FamilyHist_CVD_",
          "comorbNumber_",
           "BowelCancerScreening")

n <- data.frame(descriptivetable(df=treated, 
                         varlist=varlist,
                         contavg='median',
                         pretty_names=pretty_names),
                stringsAsFactors = FALSE)

adj <- regressiontable(df=treated, outcome="controlled", varlist=varlist, 
                       regresstype="adjusted", adjvarlist=c("agegrp", "gender"))
multi <- regressiontable(df=treated, outcome="controlled", varlist=varlist, 
                         regresstype="multivariable")
tab3 <- merge(adj, multi, by=c("IDcol", "Coefficient", "Level"), sort=FALSE)
# Add n column
tab3$n <- n$n

# Hide "unanswered"/"unknown"/"do not know" categories
tab3 <- tab3[-which(tab3$Level %in% c("Unknown", "Unanswered", "Do not know", "Prefer not to answer")),]
rownames(tab3) <- NULL

tab3 <- tab3[,c("Coefficient", "Level", "n", "OR.x", "95% CI.x", "p.x", "OR.y", "95% CI.y", "p.y")]
tab3 <- rbind(c("Coefficient", "Level", "n", "OR", "95% CI", "p", "OR", "95% CI", "p"),
              tab3)
colnames(tab3) <- c("","","", "Age- and sex-adjusted", "", "", "Fully adjusted", "", "")


tab3[,1] <- sapply(tab3[,1], prettyfunc)
kable(tab3, caption="Logistic regressions of various factors against hypertension control status, odds ratios are for successful BP control. Note: Number of individuals in levels of a factor may not add up to total n because 'Do not know' and 'Prefer not to answer' categories have been removed from results table")

```

# Table 4: Multivariable logistic regression coefficients for individual comorbidities

```{r table4, include=TRUE, echo=FALSE}

varlist=c("agegrp", "gender", "eth_group",
          "townsend_quint", "income", "employcat", "ISCED", "BirthCountryIncomeLevel", "countryResidence",
          "BMIcat", "Smo_Status", "weekly_alccat", "METs_over1200",
          "antiHTNmedsno",  "FamilyHist_CVD_",
          comorbs_string,
          "BowelCancerScreening")
prettylist <- sapply(varlist, prettyfunc)

n <- data.frame(descriptivetable(df=treated, 
                         varlist=varlist,
                         contavg='median',
                         pretty_names=pretty_names),
                stringsAsFactors = FALSE)

adj <- regressiontable(df=treated, outcome="controlled", varlist=varlist, 
                       regresstype="adjusted", adjvarlist=c("agegrp", "gender"))
multi <- regressiontable(df=treated, outcome="controlled", varlist=varlist, 
                         regresstype="multivariable")

tab4 <- merge(adj, multi, by=c("IDcol", "Coefficient", "Level"), sort=FALSE)
# Add n to the table
tab4$n <- n$n

# Keep only the individual comorbidity rows
tab4 <- tab4[tab4$IDcol %in% c(paste0(comorbs_string, "Yes"), paste0(comorbs_string,"No")),]
rownames(tab4) <- NULL

tab4 <- tab4[,c("Coefficient", "Level", "n", "OR.x", "95% CI.x", "p.x", "OR.y", "95% CI.y", "p.y")]
tab4 <- rbind(c("Coefficient", "Level", "n", "OR", "95% CI", "p", "OR", "95% CI", "p"),
              tab4)
colnames(tab4) <- c("","","", "Age- and sex-adjusted", "", "", "Fully adjusted", "", "")

tab4[,1] <- sapply(tab4[,1], prettyfunc)
kable(tab4, caption=paste0("Logistic regressions of individual comorbidities against hypertension control status, odds ratios are for successful BP control. The fully adjusted model contains the following variables: ", paste(prettylist, collapse=", "), ". Note that these are all the covariates from Table 3 except for number of comorbidities. The OR for all other covariates remained similar to those in Table 3 when adding these individual comorbidities."))

```

# Supplementary Figure 3?

```{r fig3, include=TRUE, echo=FALSE}

# Create a factor variable for the BP categories we want to colourcode
treated$plot_color <- dplyr::case_when(
  treated$SBP >= 140 & treated$DBP < 90 ~ "Uncontrolled - High SBP",
  treated$SBP < 140 & treated$DBP >= 90 ~ "Uncontrolled - High DBP",
  treated$SBP >= 140 & treated$DBP >= 90 ~ "Uncontrolled - Both high",
  treated$SBP < 140 & treated$DBP < 90 ~ "BP successfully controlled"
)
treated$plot_color <- factor(treated$plot_color, levels=c("BP successfully controlled", "Uncontrolled - High DBP", "Uncontrolled - High SBP", "Uncontrolled - Both high"))

# Scatterplot showing distribution of SBP and DBP values among participants
ggplot(data = treated, aes(DBP, SBP, color = plot_color)) +
  geom_point(size=1) +
  labs(x="DBP, mmHg", y="SBP, mmHg", 
       title="Scatterplot of blood pressure among\ntreated participants",
       color="BP control category") +
  geom_vline(xintercept = 90, linetype="dotted") +
  geom_hline(yintercept = 140, linetype="dotted") +
  scale_color_manual(values = c("BP successfully controlled" = "green",
                               "Uncontrolled - High DBP" = "yellow", 
                                "Uncontrolled - High SBP" = "orange",
                                "Uncontrolled - Both high" = "red"))


# Stacked barplot to show proportion in each category
counts <- table(treated$plot_color, treated$controlled_)
count_df <- data.frame(counts)
colnames(count_df) <- c("colour", "status", "count")
ggplot(data=count_df, aes(x=status, y=count, fill=colour)) +
  geom_bar(stat="identity") +
  labs(x="BP control status", y="Number of treated participants", 
       title="Stacked bar plot to show proportion of treated\nparticipants in each BP control category",
       fill="BP control category") +
  scale_fill_manual(values = c("BP successfully controlled" = "green",
                               "Uncontrolled - High DBP" = "yellow", 
                                "Uncontrolled - High SBP" = "orange",
                                "Uncontrolled - Both high" = "red"))

```

# Another possible supplementary figure, designed to complement Table 1 - dataset is treated participants (n = `r nrow(treated)`)

Boxplots of SBP and DBP in each group of each covariate.
Boxplots have a box spanning the interquartile range (25th-75th percentiles) with a line at the median (50th percentile) and whiskers from 1st to 99th percentiles. Min and max are shown as points.

In this version, the mean has also been marked with a point to allow us to verify that there are no cases where it differs consequentially from the median.


```{r suppfig, include=TRUE, echo=FALSE, results='asis', fig.height=3, fig.width=7}
 
# Want to change the whisker definition to show 1st to 99th percentiles
#https://stackoverflow.com/questions/4765482/changing-whisker-definition-in-geom-boxplot

# define the summary function - box plot over IQR with whiskers up to 1% and 99%
f <- function(x) {
  r <- quantile(x, probs = c(0.01, 0.25, 0.5, 0.75, 0.99))
  names(r) <- c("ymin", "lower", "middle", "upper", "ymax")
  r
}

# Use the outlier functionality to show the min and max values    
# Don't show all values outside 1%-99% because dataset so large that those 2% are still lots!
o <- function(x) {
  subset(x, x == min(x) | x == max(x))
}

# Also show mean
m <- function(x){
  mean(x)
}

get_legend<-function(myggplot){
  tmp <- ggplot_gtable(ggplot_build(myggplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
}

# For each variable in this list
varlist=c("agegrp", "gender", "eth_group",
          "townsend_quint", "income", "employcat", "ISCED", "BirthCountryIncomeLevel", "countryResidence",
          "BMIcat", "Smo_Status", "weekly_alccat", "METs_over1200",
          "HTNdx_durcat", "antiHTNmedsno",  "FamilyHist_CVD_", 
          "comorbNumber_",
          "BowelCancerScreening")


# Plot it for SBP and DBP
for(var in varlist){
  treated[paste0(var, "_rev")] <- fct_rev(treated[[var]])
  
  sbplot <- ggplot(treated, aes_string(x=paste0(var, "_rev"), y="SBP", color=var)) + 
    stat_summary(fun.data=f, geom="boxplot") + 
    stat_summary(fun.y = o, geom="point") +
    stat_summary(fun.y = m, geom="point") +
    labs(x=prettyfunc(var), y="SBP, mmHg", color=prettyfunc(var)) +
    theme(axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          legend.title = element_text(size=8),
          legend.text = element_text(size=7)) +
    coord_flip()
  
  legend <- get_legend(myggplot=sbplot)
  
  sbplot <- sbplot + theme(legend.position="none")
  
  dbplot <- ggplot(treated, aes_string(x=paste0(var, "_rev"), y="DBP", color=var)) + 
    stat_summary(fun.data=f, geom="boxplot") + 
    stat_summary(fun.y = o, geom="point") +
    stat_summary(fun.y = m, geom="point") +
    labs(x="", y="DBP, mmHg") +
    theme(axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          legend.position="none") +
    coord_flip()

  grid.arrange(sbplot, dbplot, legend, ncol=3, widths=c(2.3,2.3,2.3))
}

```



