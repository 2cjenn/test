---
title: "Prevalence and correlates of hypertension control among almost 100,000 middle-aged adults receiving treatment for hypertension in the UK"
author: "Jennifer Collister"
date: "13/05/2020"
output: 
  word_document:
      reference_docx: "K:/TEU/APOE on Dementia/RMarkdownStyle.docx"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(kableExtra)
library(knitr)
library(DiagrammeR)
library(DiagrammeRsvg)
library(magrittr)
library(svglite)
library(rsvg)
library(png)
library(DescTools)
library(ggplot2)
library(forcats)
library(gridExtra)
library(scales)
library(plyr)
library(dplyr)
library(reshape2)

source("K:/TEU/APOE on Dementia/Statistical Analysis/JCfunctions.R")
options(knitr.kable.NA='')

data <- readRDS(file="K:\\TEU\\APOE on Dementia\\Data Management\\R_Dataframes_TLA\\38358\\Organised\\Hypertension\\Neo\\HTN_excl.rds")


# Comorbidities of interest
comorbs <- readRDS("K:\\TEU\\APOE on Dementia\\Data Management\\R_Dataframes_TLA\\38358\\Organised\\Hypertension\\Neo\\VI_HTNcomorb.rds")
colnames(comorbs) <- c("ID", paste0("VI_", colnames(comorbs)[-1]))
print(colnames(comorbs)[-1])
comorbs_raw <- c("VI_afib_or_aflutter", "VI_CVD", "VI_diabetes", "VI_asthma_or_COPD", "VI_migraine", "VI_epilepsy",
                 "VI_anxiety_or_stress", "VI_depression_or_bipolar", "VI_Osteoarthritis", "VI_Other_joint_disorder")
comorbs_string <- paste0(comorbs_raw, "_")

# Principal components
pclist <- paste0("GeP_PC.m",seq(1,10))

#-------------------------------------------------------------------------------------------------------------------
# Datasets:

# For the SES descriptive analyses, we want to consider two subsets: all hypertensives and all treated individuals
hypertensives <- data[data$evidenceHTN==TRUE & !is.na(data$evidenceHTN),]
treated <- data[data$treated==TRUE & !is.na(data$treated),]

# Among the treated, those who did not list any HTN meds in VI are assumed to be taking unlisted meds
treated$antiHTNmedsno <- factor(treated$antiHTNmedsno, levels=c("1", "2", ">=3", "0"),
                                labels=c("1", "2", ">=3",  "Medication list unavailable"))

# For the genetic analyses, we will consider only the genetically caucasian individuals
white <- data[data$genWhiteBrit=="White British",]
white_trt <- treated[treated$genWhiteBrit=="White British",]

pretty_names <- list(agegrp = "Age group",
                     gender = "Gender",
                     ethnicity = "Ethnicity",
                     eth_group = "Ethnic group",
                     genWhiteBrit = "Genetically categorised as White British",
                     BMIcat = "BMI (categorical)",
                     Smo_Status = "Smoking status",
                     weekly_alcunits = "Alcohol units per week",
                     weekly_alccat = "Alcohol units per week (categorical)",
                     PhA_METsWkAllAct = "Weekly physical activity, in METs",
                     METs_over1200 = "Sufficient physical activity",
                     townsend_quint = "Townsend Deprivation Index, quintiles",
                     income = "Household Income, GBP",
                     employment = "Occupation type",
                     employcat = "Occupation category",
                     ISCED = "Highest level of education (ISCED)",
                     BirthCountryIncomeLevel = "Country of birth, by income level",
                     countryResidence = "UK country of residence",
                     BowelCancerScreening = "Ever screened for bowel cancer",
                     HTNdx_durcat = "Duration of hypertension (categorical)",
                     antiHTNmedsno = "Number of antihypertensive medications",
                     FamilyHist_CVD_ = "Family history of CVD",
                     comorbNumber_ = "No. of comorbidities",
                     VI_afib_or_aflutter_ = "Arrhythmia (afib/flutter)",
                     VI_anxiety_or_stress_ = "Anxiety",
                     VI_asthma_or_COPD_ = "Asthma or COPD",
                     VI_depression_or_bipolar_ = "Depression",
                     VI_diabetes_ = "Diabetes",
                     VI_epilepsy_ = "Epilepsy",
                     VI_CVD_ = "Cardiovascular disease",
                     VI_migraine_ = "Migraines",
                     VI_substance_use_ = "Substance use",
                     VI_Osteoarthritis_ = "Osteoarthritis",
                     VI_Other_joint_disorder_ = "Other joint disorder",
                     PRS = "Polygenic risk score",
                     PRS_quint = "Polygenic risk score, quintiles",
                     GeP_PC.m1 = "Principal Component 1",
                     GeP_PC.m2 = "PC 2",
                     GeP_PC.m3 = "PC 3",
                     GeP_PC.m4 = "PC 4",
                     GeP_PC.m5 = "PC 5",
                     GeP_PC.m6 = "PC 6",
                     GeP_PC.m7 = "PC 7",
                     GeP_PC.m8 = "PC 8",
                     GeP_PC.m9 = "PC 9",
                     GeP_PC.m10 = "PC 10"
                     )
prettyfunc <- function(x){
  if(x %in% names(pretty_names)){
     return(pretty_names[[x]])
  } else {
    return(x)
  }
}
```

![Exclusion Flowchart.](K:/TEU/APOE on Dementia/Statistical Analysis/NeoHypertension/RMarkdown/ExclFlowchart.png)



# Figure 2. Prevalence of hypertension, and its awareness, treatment and control among adults aged 40-69 years in the UKB (n = `r nrow(data)`).

```{r fig2, include=TRUE, echo=FALSE, results='asis'}

dflist <- c(list("Whole population"=data, "Females"=data[data$gender=="Female",], "Males"=data[data$gender=="Male",]))
# names(dflist) <- c("Whole population")
filenames <- list("Wholepop", "Females", "Males")
names(filenames) <- names(dflist)

grlist <- list()
for(dfname in names(dflist)){
  df <- dflist[[dfname]]
  nlist <- list(wholepop=nrow(df))
  pctlist <- list()
  for(variable in c("evidenceHTN", "aware", "treated", "controlled")){
    var <- paste0(variable, "_")
    tab <- table(df[[var]])
    pct <- round(100*prop.table(tab),1)
    nlist[[variable]] <- tab
    pctlist[[variable]] <- pct
  }
  export_svg(DiagrammeR::grViz("K:\\TEU\\APOE on Dementia\\Statistical Analysis\\NeoHypertension\\RMarkdown\\HTNtree.gv")) %>% charToRaw %>% rsvg %>% png::writePNG(paste0('K:/TEU/APOE on Dementia/Statistical Analysis/NeoHypertension/RMarkdown/',filenames[[dfname]],'.png'))
}

```
![](K:/TEU/APOE on Dementia/Statistical Analysis/NeoHypertension/RMarkdown/Wholepop.png)

# Table 1: Prevalence of hypertension control among treated hypertensives (n = `r nrow(treated)`), by socioeconomic characteristics and comorbidity type

```{r table1, include=TRUE, echo=FALSE}

desctable2 <- function(df){
  n <- nrow(df)
  median_age <- pretty_dp(median(df$age),1)
  median_SBP <- pretty_dp(median(df$SBP),1)
  median_DBP <- pretty_dp(median(df$DBP),1)
  control <- prop.test(x=nrow(df[df$controlled==TRUE & !is.na(df$controlled),]),
                           n=nrow(df), alternative="two.sided", conf.level=0.95)
  pct_control <- pretty_dp(control$estimate, dp=1, pct=TRUE)
  ci_control <- pretty_confint(control$conf.int[1], control$conf.int[2], dp=1, pct=TRUE)
  
  table <- cbind(n, median_age, paste0(median_SBP,"/",median_DBP), pct_control, ci_control)
  return(table)
}

treated$wholepop <- factor(1, levels=c(1), labels=c("All treated hypertensives"))
varlist=c("wholepop", "agegrp", "gender", "eth_group",
          "townsend_quint", "income", "employcat", "ISCED", "BirthCountryIncomeLevel", "countryResidence",
          "BMIcat", "Smo_Status", "weekly_alccat", "METs_over1200",
          "HTNdx_durcat", "antiHTNmedsno",  "FamilyHist_CVD_", 
          "comorbNumber_",
          "BowelCancerScreening")

tab1 <- c()
for(var in varlist){
  for(level in levels(treated[[var]])){
    newrow <- desctable2(treated[treated[var]==level,])
    tab1 <- rbind(tab1, cbind(level, newrow))
  }
}
for(comorb in comorbs_string){
  newrow <- desctable2(treated[treated[comorb]=="Yes",])
  tab1 <- rbind(tab1, cbind(prettyfunc(comorb), newrow))
}

rownames(tab1) <- c(unlist(sapply(varlist, function(x) c(prettyfunc(x), rep("", (nlevels(treated[[x]])-1))))),
                    "Comorbidities", rep("", length(comorbs_string)-1))

colnames(tab1) <- c("", "n", "Median age", "Median SBP/DBP", "% Controlled", "95% CI Controlled")
kable(tab1)

```

# Table 2. Characteristics of treated hypertensives, by blood pressure control status (n = `r nrow(treated)`).


```{r table2, include=TRUE, echo=FALSE}
varlist=c("age", "agegrp", "gender", "eth_group",
          "townsend_quint", "income", "employcat", "ISCED", "BirthCountryIncomeLevel", "countryResidence",
          "BMIcat", "Smo_Status", "weekly_alcunits", "weekly_alccat", "PhA_METsWkAllAct", "METs_over1200",
          "HTNdx_durcat", "antiHTNmedsno",  "FamilyHist_CVD_", 
          "comorbNumber_", comorbs_string,
          "BowelCancerScreening")

tab_c <- descriptivetable(df=treated[treated$controlled==TRUE,], 
                         varlist=varlist,
                         contavg='median',
                         pretty_names=pretty_names)

tab_u <- descriptivetable(df=treated[treated$controlled==FALSE,], 
                         varlist=varlist,
                         contavg='median',
                         pretty_names=pretty_names)

tab_o <- descriptivetable(df=treated, 
                         varlist=varlist,
                         contavg='median',
                         pretty_names=pretty_names)

uni <- regressiontable(df=treated, outcome="controlled", varlist=varlist, 
                       regresstype="univariable")

tab2 <- cbind(tab_c, tab_u[,3:4], tab_o[,3:4], as.matrix(uni)[,4:5])
tab2 <- rbind(colnames(tab2), tab2)
colnames(tab2) <- c("", "", 
    paste0("Controlled, n=", nrow(treated[treated$controlled==TRUE,])), "", 
    paste0("Uncontrolled, n=", nrow(treated[treated$controlled==FALSE,])), "",
    paste0("Overall, n=", nrow(treated)), "", "", ""
    )

kable(tab2)

```

# Table 3: Multivariable logistic regression identifying factors associated with hypertension control (BP < 140/90 mmHg), among UK adults on antihypertensive treatment (n=`r nrow(treated)`)

<div custom-style="Todo">Reminder: Manually re-order BMI categories</div>

```{r table3, include=TRUE, echo=FALSE}

varlist=c("agegrp", "gender", "eth_group",
          "townsend_quint", "income", "employcat", "ISCED", "BirthCountryIncomeLevel", "countryResidence",
          "BMIcat", "Smo_Status", "weekly_alccat", "METs_over1200",
          "antiHTNmedsno",  "FamilyHist_CVD_",
          "comorbNumber_",
           "BowelCancerScreening")

n <- data.frame(descriptivetable(df=treated, 
                         varlist=varlist,
                         contavg='median',
                         pretty_names=pretty_names),
                stringsAsFactors = FALSE)

adj <- regressiontable(df=treated, outcome="controlled", varlist=varlist, 
                       regresstype="adjusted", adjvarlist=c("agegrp", "gender"))
multi <- regressiontable(df=treated, outcome="controlled", varlist=varlist, 
                         regresstype="multivariable")
tab3 <- merge(adj, multi, by=c("IDcol", "Coefficient", "Level"), sort=FALSE)
# Add n column
tab3$n <- n$n

# Hide "unanswered"/"unknown"/"do not know" categories
tab3 <- tab3[-which(tab3$Level %in% c("Unknown", "Unanswered", "Do not know", "Prefer not to answer")),]
rownames(tab3) <- NULL

tab3 <- tab3[,c("Coefficient", "Level", "n", "OR.x", "95% CI.x", "p.x", "OR.y", "95% CI.y", "p.y")]
tab3 <- rbind(c("Coefficient", "Level", "n", "OR", "95% CI", "p", "OR", "95% CI", "p"),
              tab3)
colnames(tab3) <- c("","","", "Age- and sex-adjusted", "", "", "Fully adjusted", "", "")


tab3[,1] <- sapply(tab3[,1], prettyfunc)
kable(tab3, caption="Logistic regressions of various factors against hypertension control status, odds ratios are for successful BP control. Note: Number of individuals in levels of a factor may not add up to total n because 'Do not know' and 'Prefer not to answer' categories have been removed from results table")

```

# Table 4: Multivariable logistic regression coefficients for individual comorbidities

```{r table4, include=TRUE, echo=FALSE}

varlist=c("agegrp", "gender", "eth_group",
          "townsend_quint", "income", "employcat", "ISCED", "BirthCountryIncomeLevel", "countryResidence",
          "BMIcat", "Smo_Status", "weekly_alccat", "METs_over1200",
          "antiHTNmedsno",  "FamilyHist_CVD_",
          comorbs_string,
          "BowelCancerScreening")
prettylist <- sapply(varlist, prettyfunc)

n <- data.frame(descriptivetable(df=treated, 
                         varlist=varlist,
                         contavg='median',
                         pretty_names=pretty_names),
                stringsAsFactors = FALSE)

adj <- regressiontable(df=treated, outcome="controlled", varlist=varlist, 
                       regresstype="adjusted", adjvarlist=c("agegrp", "gender"))
multi <- regressiontable(df=treated, outcome="controlled", varlist=varlist, 
                         regresstype="multivariable")

tab4 <- merge(adj, multi, by=c("IDcol", "Coefficient", "Level"), sort=FALSE)
# Add n to the table
tab4$n <- n$n

# Keep only the individual comorbidity rows
tab4 <- tab4[tab4$IDcol %in% c(paste0(comorbs_string, "Yes"), paste0(comorbs_string,"No")),]
rownames(tab4) <- NULL

tab4 <- tab4[,c("Coefficient", "Level", "n", "OR.x", "95% CI.x", "p.x", "OR.y", "95% CI.y", "p.y")]
tab4 <- rbind(c("Coefficient", "Level", "n", "OR", "95% CI", "p", "OR", "95% CI", "p"),
              tab4)
colnames(tab4) <- c("","","", "Age- and sex-adjusted", "", "", "Fully adjusted", "", "")

tab4[,1] <- sapply(tab4[,1], prettyfunc)
kable(tab4, caption=paste0("Logistic regressions of individual comorbidities against hypertension control status, odds ratios are for successful BP control. The fully adjusted model contains the following variables: ", paste(prettylist, collapse=", "), ". Note that these are all the covariates from Table 3 except for number of comorbidities. The OR for all other covariates remained similar to those in Table 3 when adding these individual comorbidities."))

```

