---
title: "HTNtabulation"
author: "Jennifer Collister"
date: "25/02/2020"
output: 
  word_document:
      reference_docx: "K:/TEU/APOE on Dementia/RMarkdownLandscape.docx"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(kableExtra)
library(knitr)
library(DiagrammeR)
library(DiagrammeRsvg)
library(magrittr)
library(svglite)
library(rsvg)
library(png)

source("K:/TEU/APOE on Dementia/Statistical Analysis/JCfunctions.R")
options(knitr.kable.NA='')

data <- readRDS(file="K:\\TEU\\APOE on Dementia\\Data Management\\R_Dataframes_TLA\\38358\\Organised\\Hypertension\\Neo\\HTN_excl.rds")

hypertensives <- data[data$evidenceHTN==TRUE & !is.na(data$evidenceHTN),]
treated <- data[data$treated==TRUE & !is.na(data$treated),]
```

# Note on data completeness

```{r data_completeness, include=TRUE, echo=FALSE}

varlist <- c("c_age", "gender", "BMIcat", "Smo_Status", "GroupB", "GroupC", "HTNdx_duration", "hypmedsno", "townsend_depind", "income", "ISCED", "employment", "BirthCountryIncomeLevel", "BowelCancerScreening")

count_missing <- c()
for(var in varlist){
  count_missing <- c(count_missing, nrow(treated[is.na(treated[[var]]),]))
}
count_missing <- cbind(varlist, count_missing)
kable(count_missing)
```

# Table 2. Univariable and multivariable logistic regression identifying factors associated with hypertension control, among UK adults on antihypertensive treatment, n = `r nrow(treated)`.

Note that I haven't yet got the n's in, for the adjusted cases this is not trivial to automate, but I'm working on it!
This is why I have provided the data completeness table above.

In the fully adjusted model, 41597 participants have been deleted due to missingness (mostly in the hypertension duration and income variables, as unfortunately their missingness doesn't overlap very much).


```{r logisticregression, include=TRUE, echo=FALSE}
source("K:/TEU/APOE on Dementia/Statistical Analysis/JCfunctions.R")

varlist <- c("c_age", "gender", "BMIcat", "Smo_Status", "GroupB", "GroupC", "HTNdx_duration", "hypmedsno", "townsend_depind", "income", "ISCED", "employment", "BirthCountryIncomeLevel", "BowelCancerScreening")

preparecoefflist <- function(df, varname){
  if(is.factor(df[[varname]])){
        levels <- levels(df[[varname]])
        variable <- c(varname,rep(NA, length(levels)-1))
        coeffname <- paste0(varname,levels)
      } else {
        levels <- NA
        variable <- varname
        coeffname <- varname
      }
      return(data.frame(coeffname, variable, levels, stringsAsFactors=FALSE))
}

regressiontable <- function(df, varlist, regresstype){
  coefflist <- list()
  # Prepare the list of coefficients - variables and levels for factors or blanks for continuous
  for(var in varlist){
      coefflist[[var]] <- preparecoefflist(df=df, varname=var)
  }
  
  if(regresstype=="univariable"){
    modellist <- list()
    for(var in varlist){
      coeffnames <- coefflist[[var]]
      
      # Prepare the formula and pass it to the model
      formula <- paste0("controlled ~ ", var)
      model <- glm(formula, data=df, family="binomial")
      
      # Add the pretty-formatted outputs to the list
      modellist[[var]] <- printlogresults(model, coeffnames)
    }
    # Vertically concatenate all the pretty outputs into one output table
    outdf <- do.call(rbind, modellist)
    
  } else if (regresstype=="adjusted"){
    modellist <- list()
    adjvarlist <- c("c_age", "gender")
  
    # Run the regressions for age and gender separately to go on top of the table
    for(adjvar in adjvarlist){
      coeffnames <- preparecoefflist(df=df, varname=adjvar)
      
      formula <- paste0("controlled ~ ", paste(adjvarlist, collapse="+"))
      model <- glm(formula, data=df, family="binomial")
      
      # Add the pretty-formatted outputs to the list
      modellist[[adjvar]] <- printlogresults(model, coeffnames)
    }
        
    # Putting age or gender in the regression twice would confuse it, so make sure they're not in the varlist
    varlist <- varlist[!varlist %in% adjvarlist]
    
    for(var in varlist){
      coeffnames <- coefflist[[var]]
      
      # Prepare the formula and pass it to the model
      formula <- paste0("controlled ~ ", paste(adjvarlist, collapse="+"), "+", var)
      model <- glm(formula, data=df, family="binomial")
      
      # Add the pretty-formatted outputs to the list
      modellist[[var]] <- printlogresults(model, coeffnames)
    }
    outdf <- do.call(rbind, modellist)
    
  } else if (regresstype=="multivariable"){
    coeffnames <- do.call(rbind, coefflist)
    formula <- paste0("controlled ~ ", paste(varlist, collapse=" + "))
    model <- glm(formula, data=df, family="binomial")
    outdf <- printlogresults(model, coeffnames)
  }
  
  rownames(outdf) <- NULL
  return(outdf)
}

uni <- regressiontable(df=treated, varlist=varlist, regresstype="univariable")
adj <- regressiontable(df=treated, varlist=varlist, regresstype="adjusted")
multi <- regressiontable(df=treated, varlist=varlist, regresstype="multivariable")
tab2 <- merge(merge(uni, adj, by=c("Coefficient", "Level"), sort=FALSE),
              multi, by=c("Coefficient", "Level"), sort=FALSE)
kable(tab2)


```















