---
title: "BPexploration"
author: "Jennifer Collister"
date: "20/05/2020"
output: 
  word_document:
      reference_docx: "K:/TEU/APOE on Dementia/RMarkdownStyle.docx"
---

```{r setup, include=FALSE}

library(kableExtra)
library(knitr)
library(tidyr)
library(reshape2)
library(dplyr)
library(ggplot2)
library(DiagrammeR)
library(DiagrammeRsvg)
library(magrittr)
library(svglite)
library(rsvg)
library(png)
library(car)


source("K:/TEU/APOE on Dementia/Statistical Analysis/JCfunctions.R")

options(knitr.kable.NA='')

options("scipen"=100, "digits"=4)

#--------------------------------------------------------------------------------------------------------------
# Read in the raw data

bp <- readRDS("K:\\TEU\\APOE on Dementia\\Data Management\\R_Dataframes_TLA\\38358\\Organised\\bp.rds")

bp <- bp[bp$nSBP == 2 & bp$nDBP == 2,]

#--------------------------------------------------------------------------------------------------------------
# Read in the analysis data

data <- readRDS(file="K:\\TEU\\APOE on Dementia\\Data Management\\R_Dataframes_TLA\\38358\\Organised\\Hypertension\\Neo\\HTN_excl.rds")

treated <- readRDS(file="K:\\TEU\\APOE on Dementia\\Data Management\\R_Dataframes_TLA\\38358\\Organised\\Hypertension\\Neo\\HTN_trt.rds")

htn <- data[data$evidenceHTN==TRUE & !is.na(data$evidenceHTN),]

# Need Townsend quintiles to be calculated within treated population only
# Convert Townsend deprivation index to quintiles (and a factor)
quintiles <- quantile(htn$townsend_depind, probs=seq(0, 1, 0.2), na.rm=TRUE)
htn$townsend_quint <- dplyr::case_when(
  htn$townsend_depind <= quintiles[2] ~ "Q1: Least deprived",
  htn$townsend_depind > quintiles[2] & htn$townsend_depind <= quintiles[3] ~ "Q2",
  htn$townsend_depind > quintiles[3] & htn$townsend_depind <= quintiles[4] ~ "Q3",
  htn$townsend_depind > quintiles[4] & htn$townsend_depind <= quintiles[5] ~ "Q4",
  htn$townsend_depind > quintiles[5] & htn$townsend_depind <= quintiles[6] ~ "Q5: Most deprived",
  TRUE ~ "Unanswered"
)
htn$townsend_quint <- factor(htn$townsend_quint, 
                              levels=c("Q1: Least deprived", "Q2", "Q3", "Q4", "Q5: Most deprived", "Unanswered"))

#-------------------------------------------------------------------------------------------------------------------
# Pretty variable names

pretty_names <- list(age = "age, years",
                     agegrp = "age group, years",
                     gender = "gender",
                     ethnicity = "ethnicity",
                     eth_group = "ethnic group",
                     genWhiteBrit = "genetically categorised as White British",
                     BMIcat = "BMI (categorical)",
                     Smo_Status = "smoking status",
                     weekly_alcunits = "alcohol units reported per week",
                     weekly_alccat = "alcohol units per week (categorical)",
                     PhA_METsWkAllAct = "weekly physical activity, MET minutes",
                     METs_over1200 = "weekly physical activity",
                     townsend_quint = "Townsend Deprivation Index, quintiles",
                     income = "household Income, GBP",
                     employment = "occupation type",
                     employcat = "occupation category",
                     ISCED = "highest level of education (ISCED)",
                     BirthCountryIncomeLevel = "country of birth, by income level",
                     countryResidence = "UK country of residence",
                     BowelCancerScreening = "ever screened for bowel cancer",
                     HTNdx_durcat = "duration of hypertension",
                     antiHTNmedsno = "number of antihypertensive medications",
                     FamilyHist_CVD_ = "family history of CVD",
                     comorbNumber_ = "no. of comorbidities",
                     VI_afib_or_aflutter_ = "arrhythmia (afib/flutter)",
                     VI_anxiety_or_stress_ = "anxiety",
                     VI_asthma_or_COPD_ = "asthma or COPD",
                     VI_depression_or_bipolar_ = "depression",
                     VI_diabetes_ = "diabetes",
                     VI_epilepsy_ = "epilepsy",
                     VI_CVD_ = "cardiovascular disease",
                     VI_migraine_ = "migraines",
                     VI_substance_use_ = "substance use",
                     VI_Osteoarthritis_ = "osteoarthritis",
                     VI_Other_joint_disorder_ = "other joint disorder",
                     PRS = "polygenic risk score",
                     PRS_quint = "polygenic risk score, quintiles"
                     )

```


# Exploring difference between first and second BP measurements

## Descriptive info

```{r desc, include=TRUE, echo=FALSE}

tab <- c()
for(var in c("SBP.0", "SBP.1", "DBP.0", "DBP.1")){
  minbp <- min(bp[[var]])
  maxbp <- max(bp[[var]])
  meanbp <- pretty_dp(mean(bp[[var]]),1)
  medianbp <- median(bp[[var]])
  tab <- rbind(tab, cbind(minbp, maxbp, meanbp, medianbp))
  
}
colnames(tab) <- c("Min", "Max", "Mean", "Median")
rownames(tab) <- c("First SBP", "Second SBP", "First DBP", "Second DBP")

kable(tab)


```

```{r blandaltman, include=TRUE, echo=FALSE}
# # These take quite a while to run because so many data points - commented out unless required
# ggplot(data=bp, aes(x=SBP, y=SBPdiff)) + geom_point() +
#   geom_hline(yintercept=0, color="red") +
#   geom_vline(xintercept=140, color="green") +
#   ggtitle("Bland-Altman plot of mean vs difference in SBP measurements") +
#   labs(x="Mean SBP", y="2nd - 1st SBP")
# 
# ggplot(data=bp, aes(x=DBP, y=DBPdiff)) + geom_point() +
#   geom_hline(yintercept=0, color="red") +
#   geom_vline(xintercept=90, color="green") +
#   ggtitle("Bland-Altman plot of mean vs difference in DBP measurements") +
#   labs(x="Mean DBP", y="2nd - 1st DBP")
# 
# ggplot(data=bp, aes(x=SBP, y=100*SBPdiff/SBP.0)) + geom_point() +
#   geom_hline(yintercept=0, color="red") +
#   geom_vline(xintercept=140, color="green") +
#   ggtitle("Bland-Altman plot of mean vs % difference in SBP measurements") +
#   labs(x="Mean SBP", y="% Difference 100*(2nd - 1st)/1st SBP")
# 
# ggplot(data=bp, aes(x=DBP, y=100*SBPdiff/SBP.0)) + geom_point() +
#   geom_hline(yintercept=0, color="red") +
#   geom_vline(xintercept=140, color="green") +
#   ggtitle("Bland-Altman plot of mean vs % difference in DBP measurements") +
#   labs(x="Mean DBP", y="% Difference 100*(2nd - 1st)/1st DBP")

```


# Considering our collider

## Regressions for hypertension treatment among all participants with evidence of hypertension (n = `r nrow(htn)`), OR for treated

```{r regress_aware, include=TRUE, echo=FALSE}


varlist=c("agegrp", "gender", "eth_group",
          "townsend_quint", "income", "employcat", "ISCED", "BirthCountryIncomeLevel", "countryResidence",
          "BMIcat", "Smo_Status", "weekly_alccat", "METs_over1200",
          "antiHTNmedsno",  "FamilyHist_CVD_",
          "BowelCancerScreening",
          "comorbNumber_")

n <- data.frame(descriptivetable(df=htn, 
                         varlist=varlist,
                         contavg='median',
                         pretty_names=pretty_names),
                stringsAsFactors = FALSE)
uni <- regressiontable(df=htn, outcome="treated_", varlist=varlist, 
                       regresstype="univariable")
adj <- regressiontable(df=htn, outcome="treated_", varlist=varlist, 
                       regresstype="adjusted", adjvarlist=c("agegrp", "gender"))
multi <- regressiontable(df=htn, outcome="treated_", varlist=varlist, 
                         regresstype="multivariable")

tab3 <- merge(uni, merge(adj, multi, by=c("IDcol", "Coefficient", "Level"), sort=FALSE, all.x=TRUE), 
              by=c("IDcol", "Coefficient", "Level"), sort=FALSE)
# Add n column
tab3 <- cbind(n[,1:3], tab3[,4:12])

# Hide "unanswered"/"unknown"/"do not know" categories
tab3 <- tab3[-which(tab3$Level %in% c("Unknown", "Unanswered", "Do not know", "Prefer not to answer")),]
rownames(tab3) <- NULL

tab3 <- rbind(c("Coefficient", "Level", "n", "OR", "95% CI", "p", "OR", "95% CI", "p", "OR", "95% CI", "p"),
              as.matrix(tab3))
colnames(tab3) <- c("","","", 
                    "Univariable", "", "",
                    "Age- and sex-adjusted", "", "", 
                    "Multivariable- adjusted", "", "")

kable(tab3)

```

# Consider BP levels in Scotland/Wales vs England

## Age-standardised mean BP

```{r BPscotwales, include=TRUE, echo=FALSE}

# First check the means
means <- aggregate(data[,c("SBP", "DBP")], list(data$countryResidence), mean)

# Then the medians, because the BP data is skewed
medians <- aggregate(data[,c("SBP", "DBP")], list(data$countryResidence), median)

# Define categorical age groups
data$agestd <- cut(data$age, seq(40, 70,  by=1), right=FALSE)

# Number of individuals in each age group
agepop <- table(data$agestd)
ageprop <- prop.table(agepop)


dflist <- list("UKB"=data, 
                "England"=data[data$countryResidence=="England",],
                "Scotland"=data[data$countryResidence=="Scotland",],
                "Wales"=data[data$countryResidence=="Wales",])
adjmean <- c()
adjmedian <- c()

for (dfname in names(dflist)) {
  df <- dflist[[dfname]]
  
  # Mean ages
  ageMeans <- aggregate(df[,c("SBP", "DBP")], list(df$agestd), mean)
  ageMedians <- aggregate(df[,c("SBP", "DBP")], list(df$agestd), median)
  adjmean <- rbind(adjmean, colSums(ageprop * ageMeans[,2:3]))
  adjmedian <- rbind(adjmedian, colSums(ageprop * ageMedians[,2:3]))
}

colnames(adjmean) <- c("Age-Adjusted SBP", "Age-adjusted DBP")
means <- cbind(means, adjmean[2:4,])
kable(means, caption="Mean BP by country")

colnames(adjmedian) <- c("Age-Adjusted SBP", "Age-adjusted DBP")
medians <- cbind(medians, adjmedian[2:4,])
kable(medians, caption="Median BP by country")

```


## Age-standardised HTN category prevalence and mean BP in each country of UKB

```{r incidencerates, include=TRUE, echo=FALSE, results='asis'}
# Define categorical age groups
data$agestd <- cut(data$age, seq(40, 70,  by=1), right=FALSE)

# Number of individuals in each age group
agepop <- table(data$agestd)
ageprop <- prop.table(agepop)


dflist <- list("UKB"=data, 
                "England"=data[data$countryResidence=="England",],
                "Scotland"=data[data$countryResidence=="Scotland",],
                "Wales"=data[data$countryResidence=="Wales",])
adjmean <- c()
adjmedian <- c()

for (dfname in names(dflist)) {
  df <- dflist[[dfname]]
  
  # Crude prevalence per age group in the whole population
  # Number of individuals in each age group by dementia status
  age_RAW <- table(df$agestd)
  age_HTN <- table(df$agestd[df$evidenceHTN==TRUE & !is.na(df$evidenceHTN)])
  age_AWR <- table(df$agestd[df$aware==TRUE & !is.na(df$aware)])
  age_TRT <- table(df$agestd[df$treated==TRUE & !is.na(df$treated)])
  age_CTRL <- table(df$agestd[df$controlled==TRUE & !is.na(df$controlled)])
  
  # Divide dementia cases by person-years in each age group
  HTNprev <- 100 * (age_HTN/age_RAW)
  AWRprev <- 100 * (age_AWR/age_HTN)
  TRTprev <- 100 * (age_TRT/age_AWR)
  CTRLprev <- 100 * (age_CTRL/age_TRT)
  
  HTNcrude <- 100 * sum(age_HTN)/sum(age_RAW)
  AWRcrude <- 100 * sum(age_AWR)/sum(age_HTN)
  TRTcrude <- 100 * sum(age_TRT)/sum(age_AWR)
  CTRLcrude <- 100 * sum(age_CTRL)/sum(age_TRT)
  
  HTNadj <- sum(ageprop * HTNprev)
  AWRadj <- sum(ageprop * AWRprev)
  TRTadj <- sum(ageprop * TRTprev)
  CTRLadj <- sum(ageprop * CTRLprev)

  # Incorporate HTN prevalence tree into flowchart

  nlist <- list("wholepop"=sum(age_RAW), 
                "evidenceHTN"=table(df$evidenceHTN), "aware"=table(df$aware), 
                "treated"=table(df$treated), "controlled"=table(df$controlled))
  pctlist <- list("evidenceHTN"=pretty_dp(c(100-HTNcrude, HTNcrude),1), "aware"=pretty_dp(c(100-AWRcrude, AWRcrude),1), 
                  "treated"=pretty_dp(c(100-TRTcrude, TRTcrude),1), "controlled"=pretty_dp(c(100-CTRLcrude, CTRLcrude),1))
  adjlist <- list("evidenceHTN"=pretty_dp(c(100-HTNadj, HTNadj),1), "aware"=pretty_dp(c(100-AWRadj, AWRadj),1),
                  "treated"=pretty_dp(c(100-TRTadj, TRTadj),1), "controlled"=pretty_dp(c(100-CTRLadj, CTRLadj),1))


  # Create exclusion flowchart
  export_svg(DiagrammeR::grViz("K:/TEU/TEU_Members/Jennifer_Collister/ukb_hypertension/Statistical Analysis/NeoHypertension/RMarkdown/HTNtreeadj.gv")
             ) %>% charToRaw %>% rsvg %>% png::writePNG(paste0("K:/TEU/APOE on Dementia/Statistical Analysis/NeoHypertension/RMarkdown/HTNTreeAdj", dfname, ".png"))
}

```

![UKB](K:/TEU/APOE on Dementia/Statistical Analysis/NeoHypertension/RMarkdown/HTNTreeAdjUKB.png){height=680px}
![England](K:/TEU/APOE on Dementia/Statistical Analysis/NeoHypertension/RMarkdown/HTNTreeAdjEngland.png){height=680px}
![Scotland](K:/TEU/APOE on Dementia/Statistical Analysis/NeoHypertension/RMarkdown/HTNTreeAdjScotland.png){height=680px}
![Wales](K:/TEU/APOE on Dementia/Statistical Analysis/NeoHypertension/RMarkdown/HTNTreeAdjWales.png){height=680px}


```{r vif, include=FALSE, echo=FALSE}
comorbs_raw <- c("VI_CVD", "VI_diabetes", "VI_afib_or_aflutter", "VI_asthma_or_COPD", "VI_migraine", "VI_epilepsy",
                 "VI_anxiety_or_stress", "VI_depression_or_bipolar", "VI_Osteoarthritis", "VI_Other_joint_disorder")
comorbs_string <- paste0(comorbs_raw, "_")

varlist=c("agegrp", "gender", "eth_group",
          "townsend_quint", "income", "employcat", "ISCED", "BirthCountryIncomeLevel", "countryResidence",
          "BMIcat", "Smo_Status", "weekly_alccat", "METs_over1200",
          "antiHTNmedsno",  "FamilyHist_CVD_",
          comorbs_string,
          "BowelCancerScreening")

formula <- paste0("controlled", " ~ ", paste(varlist, collapse=" + "))
model <- glm(formula, data=treated, family="binomial")
vif(model)

```
