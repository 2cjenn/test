---
title: "BPexploration"
author: "Jennifer Collister"
date: "20/05/2020"
output: 
  word_document:
      reference_docx: "K:/TEU/APOE on Dementia/RMarkdownStyle.docx"
---

```{r setup, include=FALSE}

library(kableExtra)
library(knitr)
library(tidyr)
library(reshape2)
library(dplyr)
library(ggplot2)
library(DiagrammeR)
library(DiagrammeRsvg)
library(magrittr)
library(svglite)
library(rsvg)
library(png)


source("K:/TEU/APOE on Dementia/Statistical Analysis/JCfunctions.R")

options(knitr.kable.NA='')

options("scipen"=100, "digits"=4)

#--------------------------------------------------------------------------------------------------------------
# Read in the raw data

bp <- readRDS("K:\\TEU\\APOE on Dementia\\Data Management\\R_Dataframes_TLA\\38358\\BlP_base.rds")

bp <- bp[bp$nSBP == 2 & bp$nDBP == 2,]

#--------------------------------------------------------------------------------------------------------------
# Read in the analysis data

data <- readRDS(file="K:\\TEU\\APOE on Dementia\\Data Management\\R_Dataframes_TLA\\38358\\Organised\\Hypertension\\Neo\\HTN_excl.rds")

treated <- readRDS(file="K:\\TEU\\APOE on Dementia\\Data Management\\R_Dataframes_TLA\\38358\\Organised\\Hypertension\\Neo\\HTN_trt.rds")

htn <- data[data$evidenceHTN==TRUE & !is.na(data$evidenceHTN),]

# Need Townsend quintiles to be calculated within treated population only
# Convert Townsend deprivation index to quintiles (and a factor)
quintiles <- quantile(htn$townsend_depind, probs=seq(0, 1, 0.2), na.rm=TRUE)
htn$townsend_quint <- dplyr::case_when(
  htn$townsend_depind <= quintiles[2] ~ "Q1: Least deprived",
  htn$townsend_depind > quintiles[2] & htn$townsend_depind <= quintiles[3] ~ "Q2",
  htn$townsend_depind > quintiles[3] & htn$townsend_depind <= quintiles[4] ~ "Q3",
  htn$townsend_depind > quintiles[4] & htn$townsend_depind <= quintiles[5] ~ "Q4",
  htn$townsend_depind > quintiles[5] & htn$townsend_depind <= quintiles[6] ~ "Q5: Most deprived",
  TRUE ~ "Unanswered"
)
htn$townsend_quint <- factor(htn$townsend_quint, 
                              levels=c("Q1: Least deprived", "Q2", "Q3", "Q4", "Q5: Most deprived", "Unanswered"))

#-------------------------------------------------------------------------------------------------------------------
# Pretty variable names

pretty_names <- list(age = "age, years",
                     agegrp = "age group, years",
                     gender = "gender",
                     ethnicity = "ethnicity",
                     eth_group = "ethnic group",
                     genWhiteBrit = "genetically categorised as White British",
                     BMIcat = "BMI (categorical)",
                     Smo_Status = "smoking status",
                     weekly_alcunits = "alcohol units reported per week",
                     weekly_alccat = "alcohol units per week (categorical)",
                     PhA_METsWkAllAct = "weekly physical activity, MET minutes",
                     METs_over1200 = "weekly physical activity",
                     townsend_quint = "Townsend Deprivation Index, quintiles",
                     income = "household Income, GBP",
                     employment = "occupation type",
                     employcat = "occupation category",
                     ISCED = "highest level of education (ISCED)",
                     BirthCountryIncomeLevel = "country of birth, by income level",
                     countryResidence = "UK country of residence",
                     BowelCancerScreening = "ever screened for bowel cancer",
                     HTNdx_durcat = "duration of hypertension",
                     antiHTNmedsno = "number of antihypertensive medications",
                     FamilyHist_CVD_ = "family history of CVD",
                     comorbNumber_ = "no. of comorbidities",
                     VI_afib_or_aflutter_ = "arrhythmia (afib/flutter)",
                     VI_anxiety_or_stress_ = "anxiety",
                     VI_asthma_or_COPD_ = "asthma or COPD",
                     VI_depression_or_bipolar_ = "depression",
                     VI_diabetes_ = "diabetes",
                     VI_epilepsy_ = "epilepsy",
                     VI_CVD_ = "cardiovascular disease",
                     VI_migraine_ = "migraines",
                     VI_substance_use_ = "substance use",
                     VI_Osteoarthritis_ = "osteoarthritis",
                     VI_Other_joint_disorder_ = "other joint disorder",
                     PRS = "polygenic risk score",
                     PRS_quint = "polygenic risk score, quintiles"
                     )

```


# Exploring difference between first and second BP measurements

## Descriptive info

```{r desc, include=TRUE, echo=FALSE}

tab <- c()
for(var in c("SBP.0", "SBP.1", "DBP.0", "DBP.1")){
  min <- min(bp[[var]])
  max <- max(bp[[var]])
  mean <- pretty_dp(mean(bp[[var]]),1)
  median <- median(bp[[var]])
  tab <- rbind(tab, cbind(min, max, mean, median))
  
}
colnames(tab) <- c("Min", "Max", "Mean", "Median")
rownames(tab) <- c("First SBP", "Second SBP", "First DBP", "Second DBP")

kable(tab)


```

```{r blandaltman, include=TRUE, echo=FALSE}

ggplot(data=bp, aes(x=SBP, y=SBPdiff)) + geom_point() +
  geom_hline(yintercept=0, color="red") +
  geom_vline(xintercept=140, color="green") +
  ggtitle("Bland-Altman plot of mean vs difference in SBP measurements") +
  labs(x="Mean SBP", y="2nd - 1st SBP")

ggplot(data=bp, aes(x=DBP, y=DBPdiff)) + geom_point() +
  geom_hline(yintercept=0, color="red") +
  geom_vline(xintercept=90, color="green") +
  ggtitle("Bland-Altman plot of mean vs difference in DBP measurements") +
  labs(x="Mean DBP", y="2nd - 1st DBP")

ggplot(data=bp, aes(x=SBP, y=100*SBPdiff/SBP.0)) + geom_point() +
  geom_hline(yintercept=0, color="red") +
  geom_vline(xintercept=140, color="green") +
  ggtitle("Bland-Altman plot of mean vs % difference in SBP measurements") +
  labs(x="Mean SBP", y="% Difference 100*(2nd - 1st)/1st SBP")

```

# Consider BP levels in Scotland/Wales vs England

## Age- and sex-adjusted mean BP

```{r BPscotwales, include=TRUE, echo=TRUE}

# First check the means
aggregate(data[,c("SBP", "DBP")], list(data$countryResidence), mean)

# Then the medians, because the BP data is skewed
aggregate(data[,c("SBP", "DBP")], list(data$countryResidence), median)

ggplot(data=data, aes(x=countryResidence, y=SBP)) + geom_boxplot()
ggplot(data=data, aes(x=countryResidence, y=DBP)) + geom_boxplot()
```

## And prevalence

```{r fig2, include=TRUE, echo=FALSE, results='asis', }

dflist <- c(list("UKB"=data, "England"=data[data$countryResidence=="England",], "Scotland"=data[data$countryResidence=="Scotland",], "Wales"=data[data$countryResidence=="Wales",]))
# names(dflist) <- c("Whole population")
filenames <- list("Wholepop", "England", "Scotland", "Wales")
names(filenames) <- names(dflist)

grlist <- list()
for(dfname in names(dflist)){
  df <- dflist[[dfname]]
  nlist <- list(wholepop=nrow(df))
  pctlist <- list()
  for(variable in c("evidenceHTN", "aware", "treated", "controlled")){
    var <- paste0(variable, "_")
    tab <- table(df[[var]])
    pct <- round(100*prop.table(tab),1)
    nlist[[variable]] <- tab
    pctlist[[variable]] <- pct
  }
  export_svg(DiagrammeR::grViz("K:\\TEU\\APOE on Dementia\\Statistical Analysis\\NeoHypertension\\RMarkdown\\HTNtree.gv")) %>% charToRaw %>% rsvg %>% png::writePNG(paste0('K:/TEU/APOE on Dementia/Statistical Analysis/NeoHypertension/RMarkdown/',filenames[[dfname]],'.png'))
}

```


![England](K:/TEU/APOE on Dementia/Statistical Analysis/NeoHypertension/RMarkdown/England.png){height=680px}
![Scotland](K:/TEU/APOE on Dementia/Statistical Analysis/NeoHypertension/RMarkdown/Scotland.png){height=680px}
![Wales](K:/TEU/APOE on Dementia/Statistical Analysis/NeoHypertension/RMarkdown/Wales.png){height=680px}



# Considering our collider

## Regressions for hypertension treatment among all participants with evidence of hypertension (n = `r nrow(htn)`), OR for treated

```{r regress_aware, include=TRUE, echo=FALSE}


varlist=c("agegrp", "gender", "eth_group",
          "townsend_quint", "income", "employcat", "ISCED", "BirthCountryIncomeLevel", "countryResidence",
          "BMIcat", "Smo_Status", "weekly_alccat", "METs_over1200",
          "antiHTNmedsno",  "FamilyHist_CVD_",
          "BowelCancerScreening",
          "comorbNumber_")

n <- data.frame(descriptivetable(df=htn, 
                         varlist=varlist,
                         contavg='median',
                         pretty_names=pretty_names),
                stringsAsFactors = FALSE)
uni <- regressiontable(df=htn, outcome="treated_", varlist=varlist, 
                       regresstype="univariable")
adj <- regressiontable(df=htn, outcome="treated_", varlist=varlist, 
                       regresstype="adjusted", adjvarlist=c("agegrp", "gender"))
multi <- regressiontable(df=htn, outcome="treated_", varlist=varlist, 
                         regresstype="multivariable")

tab3 <- merge(uni, merge(adj, multi, by=c("IDcol", "Coefficient", "Level"), sort=FALSE, all.x=TRUE), 
              by=c("IDcol", "Coefficient", "Level"), sort=FALSE)
# Add n column
tab3 <- cbind(n[,1:3], tab3[,4:12])

# Hide "unanswered"/"unknown"/"do not know" categories
tab3 <- tab3[-which(tab3$Level %in% c("Unknown", "Unanswered", "Do not know", "Prefer not to answer")),]
rownames(tab3) <- NULL

tab3 <- rbind(c("Coefficient", "Level", "n", "OR", "95% CI", "p", "OR", "95% CI", "p", "OR", "95% CI", "p"),
              as.matrix(tab3))
colnames(tab3) <- c("","","", 
                    "Univariable", "", "",
                    "Age- and sex-adjusted", "", "", 
                    "Multivariable- adjusted", "", "")

kable(tab3)

```
