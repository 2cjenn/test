---
title: "Prevalence and correlates of hypertension control among 250,000 middle-aged adults in the UK"
author: "Jennifer Collister"
date: "23/04/2020"
output: 
  word_document:
      reference_docx: "K:/TEU/APOE on Dementia/RMarkdownStyle.docx"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(kableExtra)
library(knitr)
library(DiagrammeR)
library(DiagrammeRsvg)
library(magrittr)
library(svglite)
library(rsvg)
library(png)

source("K:/TEU/APOE on Dementia/Statistical Analysis/JCfunctions.R")
options(knitr.kable.NA='')

data <- readRDS(file="K:\\TEU\\APOE on Dementia\\Data Management\\R_Dataframes_TLA\\38358\\Organised\\Hypertension\\Neo\\HTN_excl.rds")


# Comorbidities of interest
comorbs <- readRDS("K:\\TEU\\APOE on Dementia\\Data Management\\R_Dataframes_TLA\\38358\\Organised\\Hypertension\\Neo\\VI_HTNcomorb.rds")
colnames(comorbs) <- c("ID", paste0("VI_", colnames(comorbs)[-1]))
print(colnames(comorbs)[-1])
comorbs_raw <- c("VI_afib_or_aflutter", "VI_CVD", "VI_diabetes", "VI_asthma_or_COPD", "VI_migraine", "VI_epilepsy",
                 "VI_anxiety_or_stress", "VI_depression_or_bipolar")
comorbs_string <- paste0(comorbs_raw, "_")

# In this analysis, we want to consider two subsets: all hypertensives and all treated individuals
hypertensives <- data[data$evidenceHTN==TRUE & !is.na(data$evidenceHTN),]
treated <- data[data$treated==TRUE & !is.na(data$treated),]

# Among the treated, those who did not list any HTN meds in VI are assumed to be taking unlisted meds
treated$antiHTNmedsno <- factor(treated$antiHTNmedsno, levels=c("1", "2", ">=3", "0"),
                                labels=c("1", "2", ">=3",  "Medication list unavailable"))

pretty_names <- list(agegrp = "Age group",
                     gender = "Gender",
                     ethnicity = "Ethnicity",
                     genWhiteBrit = "Genetically categorised as White British",
                     BMIcat = "BMI (categorical)",
                     Smo_Status = "Smoking status",
                     weekly_alcunits = "Alcohol units per week",
                     weekly_alccat = "Alcohol units per week (categorical)",
                     PhA_METsWkAllAct = "Weekly physical activity, in METs",
                     METs_over600 = "Sufficient physical activity",
                     townsend_quint = "Townsend Deprivation Index, quintiles",
                     income = "Household Income, GBP",
                     employment = "Occupation type",
                     employcat = "Occupation category",
                     ISCED = "Highest level of education (ISCED)",
                     BirthCountryIncomeLevel = "Country of birth, by income level",
                     countryResidence = "UK country of residence",
                     BowelCancerScreening = "Ever screened for bowel cancer",
                     HTNdx_durcat = "Duration of hypertension (categorical)",
                     antiHTNmedsno = "Number of antihypertensive medications",
                     FamilyHist_CVD_ = "Family history of CVD",
                     comorbNumber_ = "No. of comorbidities",
                     VI_afib_or_aflutter_ = "Arrhythmia (afib/flutter)",
                     VI_anxiety_or_stress_ = "Anxiety",
                     VI_asthma_or_COPD_ = "Asthma or COPD",
                     VI_depression_or_bipolar_ = "Depression",
                     VI_diabetes_ = "Diabetes",
                     VI_epilepsy_ = "Epilepsy",
                     VI_CVD_ = "Cardiovascular disease",
                     VI_migraine_ = "Migraines",
                     VI_substance_use_ = "Substance use"
                     )
prettyfunc <- function(x){
  if(x %in% names(pretty_names)){
     return(pretty_names[[x]])
  } else {
    return(x)
  }
}

eth <- treated[,c("Eth_Ethnicity", "GeP_ethnic", "ethnicity", "genWhiteBrit")]
eth$Eth_Ethnicity <- as.numeric(unclass(eth$Eth_Ethnicity))
eth$GeP_ethnic <- as.numeric(unclass(eth$GeP_ethnic))
eth$GeP_ethnic[is.na(eth$GeP_ethnic)] <- 2
eth$ethnicity <- as.numeric(unclass(eth$ethnicity))
eth$genWhiteBrit <- as.numeric(unclass(eth$genWhiteBrit))

res <- cor(eth, method = "spearman", use = "complete.obs")
res
corrplot(res, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)
```

![Exclusion Flowchart.](K:/TEU/APOE on Dementia/Statistical Analysis/NeoHypertension/RMarkdown/ExclFlowchart.png)

# Table 1. Characteristics of treated hypertensives, by blood pressure control status (n = `r nrow(treated)`).

<div custom-style="Note">Note: Old (many) and new (condensed) employment categories both in descriptive table for first inspection, old categories will be removed if we're happy with new ones. Condensed categories are in regression models.</div>

```{r table1, include=TRUE, echo=FALSE}
varlist=c("age", "agegrp", "gender", "genWhiteBrit", "ethnicity",
          "townsend_quint", "income", "employment", "employcat", "ISCED", 
          "BirthCountryIncomeLevel", "countryResidence",
          "BMIcat", "Smo_Status", "weekly_alcunits", "weekly_alccat", "PhA_METsWkAllAct", "METs_over600",
          "HTNdx_durcat", "antiHTNmedsno",  "FamilyHist_CVD_", 
          "comorbNumber_", comorbs_string,
          "BowelCancerScreening")

tab_c <- descriptivetable(df=treated[treated$controlled==TRUE,], 
                         varlist=varlist,
                         contavg='median',
                         pretty_names=pretty_names)

tab_u <- descriptivetable(df=treated[treated$controlled==FALSE,], 
                         varlist=varlist,
                         contavg='median',
                         pretty_names=pretty_names)

uni <- regressiontable(df=treated, outcome="controlled", varlist=varlist, 
                       regresstype="univariable")

tab1 <- cbind(tab_c, tab_u[,3:4], as.matrix(uni)[,4:5])
tab1 <- rbind(colnames(tab1), tab1)
colnames(tab1) <- c("", "", 
    paste0("Controlled, n=", nrow(treated[treated$controlled==TRUE,])), "", 
    paste0("Uncontrolled, n=", nrow(treated[treated$controlled==FALSE,])), "",
    paste0("Overall, n=", nrow(treated)), ""
    )
# tab1[,1] <- sapply(tab1[,1], prettyfunc)
kable(tab1)

```

# Figure 2. Prevalence of hypertension, and its awareness, treatment and control among adults aged 40-69 years in the UKB (n = `r nrow(data)`).

```{r fig2, include=FALSE, echo=FALSE, results='asis'}

dflist <- c(list("Whole population"=data))
names(dflist) <- c("Whole population")
filenames <- list("Wholepop")
names(filenames) <- names(dflist)

grlist <- list()
for(dfname in names(dflist)){
  df <- dflist[[dfname]]
  nlist <- list(wholepop=nrow(df))
  pctlist <- list()
  for(variable in c("evidenceHTN", "aware", "treated", "controlled")){
    var <- paste0(variable, "_")
    tab <- table(df[[var]])
    pct <- round(100*prop.table(tab),1)
    nlist[[variable]] <- tab
    pctlist[[variable]] <- pct
  }
  export_svg(DiagrammeR::grViz("K:\\TEU\\APOE on Dementia\\Statistical Analysis\\NeoHypertension\\RMarkdown\\HTNtree.gv")) %>% charToRaw %>% rsvg %>% png::writePNG(paste0(filenames[[dfname]],'.png'))
}

```
![Whole population.](K:/TEU/APOE on Dementia/Statistical Analysis/NeoHypertension/RMarkdown/Wholepop.png)

# Table 2: Prevalence of hypertension awareness, treatment and control among hypertensives, by socioeconomic characteristics and comorbidity type

```{r table2}

dflist <- c(list("Among all hypertensives"=hypertensives),
            lapply(levels(hypertensives$agegrp), function(x) hypertensives[hypertensives$agegrp==x,]),
            lapply(levels(hypertensives$ethnicity), function(x) hypertensives[hypertensives$ethnicity==x,]),
            list("None"=hypertensives[hypertensives$comorbNone==TRUE,]), 
            lapply(comorbs_raw, function(x) hypertensives[hypertensives[[x]]==1,])
            )
tab2 <- c()
for(df in dflist){
  n <- nrow(df)
  mean_age <- round(mean(df$age),1)
  mean_SBP <- round(mean(df$SBP),1)
  mean_DBP <- round(mean(df$DBP),1)
  pct_aware <- round(100*nrow(df[df$aware==TRUE & !is.na(df$aware),])/nrow(df),1)
  pct_treat <- round(100*nrow(df[df$treated==TRUE & !is.na(df$treated),])/nrow(df[df$aware==TRUE & !is.na(df$aware),]),1)
  pct_control <- round(100*nrow(df[df$controlled==TRUE & !is.na(df$controlled),])/nrow(df[df$treated==TRUE & !is.na(df$treated),]),1)
  total_pct_control <- round(100*nrow(df[df$controlled==TRUE & !is.na(df$controlled),])/nrow(df),1)
  tab2 <- rbind(tab2,(cbind(n, mean_age, paste0(mean_SBP,"/",mean_DBP), 
                            pct_aware, pct_treat, pct_control, total_pct_control)))
}

tab2 <- cbind(c("All hypertensives", levels(hypertensives$agegrp), levels(hypertensives$ethnicity),
                    "None", sapply(comorbs_string, prettyfunc)),
              tab2)
rownames(tab2) <- c("", "Age groups", "", "", "Ethnic groups", "", "", "",
                    "Comorbidities", "", "", "", "", "",  "", "","")
colnames(tab2) <- c("", "n", "Mean age", "Mean SBP/DBP", "% Aware", "% Treated", "% Controlled", "Total % Controlled")
kable(tab2)

```

# Table 3: Multivariable logistic regression identifying factors associated with hypertension control (BP < 140/90 mmHg), among UK adults on antihypertensive treatment (n=`r nrow(treated)`)

<div custom-style="Todo">To-do: Quadratic age is strongly significant, need to check out residuals</div>

<div custom-style="Todo">To-do: Remove "unknown"/"unanswered" - from regression or from results table?</div>

# Self-reported ethnicity ONLY

##	Model C (number of comorbidities): Model A minus: arrhythmia, diabetes, asthma or COPD, migraines, epilepsy, anxiety, depression  (i.e. minus individual comorbidities except CVD)

```{r table3C, include=TRUE, echo=FALSE}

varlist=c("agegrp", "gender", "ethnicity",
          "townsend_quint", "income", "ISCED", "employcat", "BirthCountryIncomeLevel", "countryResidence",
          "BMIcat", "Smo_Status", "weekly_alccat", "METs_over600",
          "antiHTNmedsno",  "FamilyHist_CVD_",
          "comorbNumber_", "VI_CVD_",
           "BowelCancerScreening")

adj <- regressiontable(df=treated, outcome="controlled", varlist=varlist, 
                       regresstype="adjusted", adjvarlist=c("agegrp", "gender"))
multi <- regressiontable(df=treated, outcome="controlled", varlist=varlist, 
                         regresstype="multivariable")
tab3 <- merge(adj, multi, by=c("IDcol", "Coefficient", "Level"), sort=FALSE)
tab3 <- tab3[,-which(names(tab3)=="IDcol")]
tab3 <- rbind(c("Coefficient", "Level", "OR", "95% CI", "p", "OR", "95% CI", "p"),
              tab3)
colnames(tab3) <- c("","", "Age- and sex-adjusted", "", "", "Fully adjusted", "", "")
tab3[,1] <- sapply(tab3[,1], prettyfunc)
kable(tab3, caption="Logistic regressions of various factors against hypertension control status, odds ratios are for successful BP control.")

```

##	Model D (individual comorbidities): Model A minus number of comorbidities. 

```{r table3D, include=TRUE, echo=FALSE}

varlist=c("agegrp", "gender", "ethnicity",
          "townsend_quint", "income", "ISCED", "employcat", "BirthCountryIncomeLevel", "countryResidence",
          "BMIcat", "Smo_Status", "weekly_alccat", "METs_over600",
          "antiHTNmedsno",  "FamilyHist_CVD_",
          comorbs_string,
           "BowelCancerScreening")

adj <- regressiontable(df=treated, outcome="controlled", varlist=varlist, 
                       regresstype="adjusted", adjvarlist=c("agegrp", "gender"))
multi <- regressiontable(df=treated, outcome="controlled", varlist=varlist, 
                         regresstype="multivariable")
tab3 <- merge(adj, multi, by=c("IDcol", "Coefficient", "Level"), sort=FALSE)
tab3 <- tab3[,-which(names(tab3)=="IDcol")]
tab3 <- rbind(c("Coefficient", "Level", "OR", "95% CI", "p", "OR", "95% CI", "p"),
              tab3)
colnames(tab3) <- c("","", "Age- and sex-adjusted", "", "", "Fully adjusted", "", "")
tab3[,1] <- sapply(tab3[,1], prettyfunc)
kable(tab3, caption="Logistic regressions of various factors against hypertension control status, odds ratios are for successful BP control.")

```

# Self-reported ethnicity AND genetic ethnicity

##	Model C (number of comorbidities): Model A minus: arrhythmia, diabetes, asthma or COPD, migraines, epilepsy, anxiety, depression  (i.e. minus individual comorbidities except CVD)

```{r table3Cb, include=TRUE, echo=FALSE}

varlist=c("agegrp", "gender", "genWhiteBrit", "ethnicity",
          "townsend_quint", "income", "ISCED", "employcat", "BirthCountryIncomeLevel", "countryResidence",
          "BMIcat", "Smo_Status", "weekly_alccat", "METs_over600",
          "antiHTNmedsno",  "FamilyHist_CVD_",
          "comorbNumber_", "VI_CVD_",
           "BowelCancerScreening")

adj <- regressiontable(df=treated, outcome="controlled", varlist=varlist, 
                       regresstype="adjusted", adjvarlist=c("agegrp", "gender"))
multi <- regressiontable(df=treated, outcome="controlled", varlist=varlist, 
                         regresstype="multivariable")
tab3 <- merge(adj, multi, by=c("IDcol", "Coefficient", "Level"), sort=FALSE)
tab3 <- tab3[,-which(names(tab3)=="IDcol")]
tab3 <- rbind(c("Coefficient", "Level", "OR", "95% CI", "p", "OR", "95% CI", "p"),
              tab3)
colnames(tab3) <- c("","", "Age- and sex-adjusted", "", "", "Fully adjusted", "", "")
tab3[,1] <- sapply(tab3[,1], prettyfunc)
kable(tab3, caption="Logistic regressions of various factors against hypertension control status, odds ratios are for successful BP control.")

```

##	Model D (individual comorbidities): Model A minus number of comorbidities. 

```{r table3Db, include=TRUE, echo=FALSE}

varlist=c("agegrp", "gender", "genWhiteBrit", "ethnicity",
          "townsend_quint", "income", "ISCED", "employcat", "BirthCountryIncomeLevel", "countryResidence",
          "BMIcat", "Smo_Status", "weekly_alccat", "METs_over600",
          "antiHTNmedsno",  "FamilyHist_CVD_",
          comorbs_string,
           "BowelCancerScreening")

adj <- regressiontable(df=treated, outcome="controlled", varlist=varlist, 
                       regresstype="adjusted", adjvarlist=c("agegrp", "gender"))
multi <- regressiontable(df=treated, outcome="controlled", varlist=varlist, 
                         regresstype="multivariable")
tab3 <- merge(adj, multi, by=c("IDcol", "Coefficient", "Level"), sort=FALSE)
tab3 <- tab3[,-which(names(tab3)=="IDcol")]
tab3 <- rbind(c("Coefficient", "Level", "OR", "95% CI", "p", "OR", "95% CI", "p"),
              tab3)
colnames(tab3) <- c("","", "Age- and sex-adjusted", "", "", "Fully adjusted", "", "")
tab3[,1] <- sapply(tab3[,1], prettyfunc)
kable(tab3, caption="Logistic regressions of various factors against hypertension control status, odds ratios are for successful BP control.")

```
