---
title: "HTNtabulation"
author: "Jennifer Collister"
date: "25/02/2020"
output: 
  word_document:
      reference_docx: "K:/TEU/TEU Guides/TEU_DocStyle_Rmd_2020.dotx"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(kableExtra)
library(knitr)
library(DiagrammeR)
library(DiagrammeRsvg)
library(magrittr)
library(svglite)
library(rsvg)
library(png)

source("K:/TEU/APOE on Dementia/Statistical Analysis/JCfunctions.R")
options(knitr.kable.NA='')

data <- readRDS(file="K:\\TEU\\APOE on Dementia\\Data Management\\R_Dataframes_TLA\\38358\\Organised\\Hypertension\\Neo\\HTN_excl.rds")

# Lots of missing data for HTN diagnosis duration and income
# 
data$HTNdx_duration[is.na(data$HTNdx_duration)] <- median(data$HTNdx_duration, na.rm=TRUE)
levels(data$income) <- c(levels(data$income), "No answer")
data$income[is.na(data$income)] <- "No answer"

hypertensives <- data[data$evidenceHTN==TRUE & !is.na(data$evidenceHTN),]
treated <- data[data$treated==TRUE & !is.na(data$treated),]
```

# Note on data completeness

```{r data_completeness, include=FALSE, echo=FALSE}

varlist <- c("c_age", "gender", "BMIcat", "Smo_Status", "GroupB", "GroupC", "HTNdx_duration", "hypmedsno", "townsend_depind", "income", "ISCED", "employment", "BirthCountryIncomeLevel", "BowelCancerScreening")

count_missing <- c()
for(var in varlist){
  count_missing <- c(count_missing, nrow(treated[is.na(treated[[var]]),]))
}
count_missing <- cbind(varlist, count_missing)
kable(count_missing)
```

Here I've quickly created a "No answer" category for income, and used the median hypertension duration (it's very skewed, most diagnoses are comparatively recent) as a filler value.
Note concerns about quality of hypertension duration data - this could be recorded either as an estimated age of diagnosis or year of diagnosis by the nurse in the verbal interview. Values that indicated diagnosis before birth were automatically truncated to D.o.B - and while that approach may have made sense for some conditions, it doesn't seem adequate for hypertension, as it is unlikely that individuals were being diagnosed with hypertension in childhood (in this population of 40-69yr olds, ~300 stated a diagnosis of hypertension more than 50 years ago)


```{r logisticregression, include=TRUE, echo=FALSE}
source("K:/TEU/APOE on Dementia/Statistical Analysis/JCfunctions.R")

varlist <- c("c_age", "gender", "BMIcat", "Smo_Status", "GroupB", "GroupC", "HTNdx_duration", "hypmedsno", "townsend_depind", "income", "ISCED", "employment", "BirthCountryIncomeLevel", "BowelCancerScreening")

preparecoefflist <- function(df, varname){
  if(is.factor(df[[varname]])){
        levels <- levels(df[[varname]])
        variable <- c(varname,rep(NA, length(levels)-1))
        coeffname <- paste0(varname,levels)
      } else {
        levels <- NA
        variable <- varname
        coeffname <- varname
      }
      return(data.frame(coeffname, variable, levels, stringsAsFactors=FALSE))
}

regressiontable <- function(df, varlist, regresstype){
  coefflist <- list()
  # Prepare the list of coefficients - variables and levels for factors or blanks for continuous
  for(var in varlist){
      coefflist[[var]] <- preparecoefflist(df=df, varname=var)
  }
  
  if(regresstype=="univariable"){
    modellist <- list()
    for(var in varlist){
      coeffnames <- coefflist[[var]]
      
      # Prepare the formula and pass it to the model
      formula <- paste0("controlled ~ ", var)
      model <- glm(formula, data=df, family="binomial")
      
      # Add the pretty-formatted outputs to the list
      modellist[[var]] <- printlogresults(model, coeffnames)
    }
    # Vertically concatenate all the pretty outputs into one output table
    outdf <- do.call(rbind, modellist)
    
  } else if (regresstype=="adjusted"){
    modellist <- list()
    adjvarlist <- c("c_age", "gender")
  
    # Run the regressions for age and gender separately to go on top of the table
    for(adjvar in adjvarlist){
      coeffnames <- preparecoefflist(df=df, varname=adjvar)
      
      formula <- paste0("controlled ~ ", paste(adjvarlist, collapse="+"))
      model <- glm(formula, data=df, family="binomial")
      
      # Add the pretty-formatted outputs to the list
      modellist[[adjvar]] <- printlogresults(model, coeffnames)
    }
        
    # Putting age or gender in the regression twice would confuse it, so make sure they're not in the varlist
    varlist <- varlist[!varlist %in% adjvarlist]
    
    for(var in varlist){
      coeffnames <- coefflist[[var]]
      
      # Prepare the formula and pass it to the model
      formula <- paste0("controlled ~ ", paste(adjvarlist, collapse="+"), "+", var)
      model <- glm(formula, data=df, family="binomial")
      
      # Add the pretty-formatted outputs to the list
      modellist[[var]] <- printlogresults(model, coeffnames)
    }
    outdf <- do.call(rbind, modellist)
    
  } else if (regresstype=="multivariable"){
    coeffnames <- do.call(rbind, coefflist)
    formula <- paste0("controlled ~ ", paste(varlist, collapse=" + "))
    model <- glm(formula, data=df, family="binomial")
    outdf <- printlogresults(model, coeffnames)
  }
  
  rownames(outdf) <- NULL
  return(outdf)
}

uni <- regressiontable(df=treated, varlist=varlist, regresstype="univariable")
adj <- regressiontable(df=treated, varlist=varlist, regresstype="adjusted")
multi <- regressiontable(df=treated, varlist=varlist, regresstype="multivariable")
tab2 <- merge(merge(uni, adj, by=c("Coefficient", "Level"), sort=FALSE),
              multi, by=c("Coefficient", "Level"), sort=FALSE)
kable(tab2)


```















