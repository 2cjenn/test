---
title: "BP PRS Analysis"
author: "Jennifer Collister"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  word_document:
      reference_docx: "K:/TEU/TEU Guides/TEU_DocStyle_Rmd_2020.dotx"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include=TRUE, echo=FALSE)

library(kableExtra)
library(knitr)
library(yaml)
library(here)

# Specify the markdown format for knitr tables, otherwise they're not compatible with kableExtra
options(knitr.kable.NA='', knitr.table.format = "markdown")
options(kableExtra.auto_format = FALSE)
# Set the root directory to the project directory (otherwise knitr works in the directory of the Rmd file by default)
knitr::opts_knit$set(root.dir = here::here())

# Load the project config file for filepaths etc
config = yaml.load_file(here::here("./config.yml"))

source("K:/TEU/APOE on Dementia/Statistical_Analysis/JCfunctions.R")

# Load data
data <- readRDS(file=paste0(config$analysisdata$htn, "HTN_excl.rds"))
data <- data[data$treated==TRUE & !is.na(data$treated),]

S_quintiles <- quantile(data$PRS_SBP, probs=seq(0, 1, 0.2), na.rm=TRUE)
data$PRS_SBP_quint <- dplyr::case_when(
  data$PRS_SBP <= S_quintiles[2] ~ "Q1: Lowest score",
  data$PRS_SBP > S_quintiles[2] & data$PRS_SBP <= S_quintiles[3] ~ "Q2",
  data$PRS_SBP > S_quintiles[3] & data$PRS_SBP <= S_quintiles[4] ~ "Q3",
  data$PRS_SBP > S_quintiles[4] & data$PRS_SBP <= S_quintiles[5] ~ "Q4",
  data$PRS_SBP > S_quintiles[5] & data$PRS_SBP <= S_quintiles[6] ~ "Q5: Highest score",
  TRUE ~ "Unanswered"
)
data$PRS_SBP_quint <- factor(data$PRS_SBP_quint,
                              levels=c("Q1: Lowest score", "Q2", "Q3", "Q4", "Q5: Highest score"))
data$PRS_SBP_quint_ <- factor(data$PRS_SBP_quint,
                              levels=c("Q3", "Q1: Lowest score", "Q2", "Q4", "Q5: Highest score"),
                              labels=c("Q3 (ref)", "Q1: Lowest score", "Q2", "Q4", "Q5: Highest score"))

D_quintiles <- quantile(data$PRS_DBP, probs=seq(0, 1, 0.2), na.rm=TRUE)
data$PRS_DBP_quint <- dplyr::case_when(
  data$PRS_DBP <= D_quintiles[2] ~ "Q1: Lowest score",
  data$PRS_DBP > D_quintiles[2] & data$PRS_DBP <= D_quintiles[3] ~ "Q2",
  data$PRS_DBP > D_quintiles[3] & data$PRS_DBP <= D_quintiles[4] ~ "Q3",
  data$PRS_DBP > D_quintiles[4] & data$PRS_DBP <= D_quintiles[5] ~ "Q4",
  data$PRS_DBP > D_quintiles[5] & data$PRS_DBP <= D_quintiles[6] ~ "Q5: Highest score",
  TRUE ~ "Unanswered"
)
data$PRS_DBP_quint <- factor(data$PRS_DBP_quint,
                             levels=c("Q1: Lowest score", "Q2", "Q3", "Q4", "Q5: Highest score"))
data$PRS_DBP_quint_ <- factor(data$PRS_DBP_quint,
                              levels=c("Q3", "Q1: Lowest score", "Q2", "Q4", "Q5: Highest score"),
                             labels=c("Q3 (ref)", "Q1: Lowest score", "Q2", "Q4", "Q5: Highest score"))

data <- data[!is.na(data$PRS_DBP_quint) & !is.na(data$PRS_SBP_quint),]
treated <- data

# Comorbidities of interest
comorbs <- readRDS("K:\\TEU\\APOE on Dementia\\Data_Management\\Data\\HTN\\VI_HTNcomorb.rds")
colnames(comorbs) <- c("ID", paste0("VI_", colnames(comorbs)[-1]))
print(colnames(comorbs)[-1])
comorbs_raw <- c("VI_CVD", "VI_diabetes", "VI_afib_or_aflutter", "VI_asthma_or_COPD", "VI_migraine", "VI_epilepsy",
                 "VI_anxiety_or_stress", "VI_depression_or_bipolar", "VI_Osteoarthritis", "VI_Other_joint_disorder")
comorbs_string <- paste0(comorbs_raw, "_")

#-------------------------------------------------------------------------------------------------------------------
# Pretty variable names

pretty_names <- list(age = "age, years",
                     agegrp = "age group, years",
                     gender = "gender",
                     ethnicity = "ethnicity",
                     eth_group = "ethnic group",
                     genWhiteBrit = "genetically categorised as White British",
                     BMIcat = "BMI (categorical)",
                     Smo_Status = "smoking status",
                     weekly_alcunits = "alcohol units reported per week",
                     weekly_alccat = "alcohol units per week (categorical)",
                     PhA_METsWkAllAct = "weekly physical activity, MET minutes",
                     METs_over1200 = "weekly physical activity",
                     townsend_quint = "Townsend Deprivation Index, quintiles",
                     income = "household Income, GBP",
                     employment = "occupation type",
                     employcat = "occupation category",
                     ISCED = "highest level of education (ISCED)",
                     BirthCountryIncomeLevel = "country of birth, by income level",
                     countryResidence = "UK country of residence",
                     BowelCancerScreening = "ever screened for bowel cancer",
                     HTNdx_duration = "reported duration of hypertension, years",
                     HTNdx_durcat = "repoted duration of hypertension",
                     antiHTNmedsno = "number of antihypertensive medications",
                     FamilyHist_CVD_ = "family history of CVD",
                     comorbNumber_ = "no. of comorbidities",
                     VI_afib_or_aflutter_ = "arrhythmia (afib/flutter)",
                     VI_anxiety_or_stress_ = "anxiety",
                     VI_asthma_or_COPD_ = "asthma or COPD",
                     VI_depression_or_bipolar_ = "depression",
                     VI_diabetes_ = "diabetes",
                     VI_epilepsy_ = "epilepsy",
                     VI_CVD_ = "cardiovascular disease",
                     VI_migraine_ = "migraines",
                     VI_substance_use_ = "substance use",
                     VI_Osteoarthritis_ = "osteoarthritis",
                     VI_Other_joint_disorder_ = "other joint disorder",
                     PRS = "polygenic risk score",
                     PRS_quint = "polygenic risk score, quintiles",
                     PRS_SBP_quint_ = "SBP PRS score, quintiles",
                     PRS_DBP_quint_ = "DBP PRS score, quintiles"
                     )

#-------------------------------------------------------------------------------------------------------------------
# Setup

figure <- 1
table <- 1
suppfig <- 1
footnote_no <- 1

```

# Confirm the overall PRS on the whole data set match what Jemma’s group get – at least to the first decimal place.  If not, explore why.

On our simplest case comparison our results matched those of Jemma's team to (at least) 2dp.

This comparison was:

* All individuals with genetic data available
* Individuals who had withdrawn from UKB were excluded
* No exclusions for genetic data outliers/sex discordance/ethnicity were made
* Total n = 487296
* The PRS scores have not been adjusted or standardised in any way
* No SNPs have been excluded due to ambiguity/HWE etc
* Total of 884 SNPs for SBP and 885 SNPs for DBP

This very preliminary PRS has been calculated for all individuals.

The exclusion criteria for Neo's HTN study have now been applied, resulting in a dataset of `r nrow(data)` individuals, of whom `r nrow(treated)` are considered "treated hypertensives".

Quintiles for each PRS score were calculated within the treated hypertensive population.

**The following analyses are conducted on this population of `r nrow(treated)` "treated hypertensives".**

# Table 1 analysis.  Construct a Table 1a.  Horizontal Quintiles 1, 3, 5 of SBP PRS.  Table 1b: Same for DBP PRS.  Vertical risk factors: As for Table 1 in HTNTables_JC20200624.doc.    If there are non-trivial differences by age and/or sex will need to standardize the other risk factors (unlikely to be needed).

## Table 1a. Baseline characteristics by quintile of SBP PRS

```{r}

varlist=c("agegrp", "gender", "eth_group",
          "income", "employcat", "ISCED", "countryResidence",
          "BMIcat", "Smo_Status",
          "HTNdx_duration", "antiHTNmedsno",
          "comorbNumber_")
  
categories <- c("Q1: Lowest score", "Q3", "Q5: Highest score")
catvar = "PRS_SBP_quint"

desctabmulti <- function(data, catvar, categories, varlist, pretty_names){
  colnames <- c()
  tab <- descriptivetable(df=data[data[[catvar]]==categories[1],], 
                             varlist=varlist,
                             contavg='median',
                             pretty_names=pretty_names)
  colnames <- c(colnames, paste0(categories[1], ", n=", nrow(data[data[[catvar]]==categories[1],])))
  for(cat in categories[-1]){
    tabq <- descriptivetable(df=data[data[[catvar]]==cat,], 
                             varlist=varlist,
                             contavg='median',
                             pretty_names=pretty_names)
    tab <- cbind(tab, tabq[,-(1:2)])
    colnames <- c(colnames, paste0(cat, ", n=", nrow(data[data[[catvar]]==cat,])))
  }
  tab <- rbind(colnames(tab), tab)
  colnames(tab) <- c(NA, NA, c(rbind(colnames, rep(NA, length(categories)))))
  return(tab)
}

tab <- desctabmulti(data=treated, catvar="PRS_SBP_quint", 
                    categories=categories, varlist=varlist, pretty_names=pretty_names)
kable(tab)

```

## Table 1b. Baseline characteristics by quintile of DBP PRS

```{r}

tab <- desctabmulti(data=treated, catvar="PRS_DBP_quint", 
                    categories=categories, varlist=varlist, pretty_names=pretty_names)
kable(tab)

```



# Table 2 analysis.  Add the SBP PRS and DBP PRS individually, and together (i.e. 3 multivariate analyses).

## Table 2a: With SBP PRS. Identifying factors associated with hypertension control, among middle-aged UK adults on anti-hypertensive treatment with genetic data available (n=`r nrow(data)`)

```{r table2_SBP, include=TRUE, echo=FALSE}

varlist=c("agegrp", "gender", "eth_group", "PRS_SBP_quint_",
          "townsend_quint", "income", "employcat", "ISCED", "BirthCountryIncomeLevel", "countryResidence",
          "BMIcat", "Smo_Status", "weekly_alccat", "METs_over1200",
          "antiHTNmedsno",  "FamilyHist_CVD_",
          "BowelCancerScreening",
          "comorbNumber_")

footnote_list <- c("townsend_quint", "employcat", "ISCED", "BirthCountryIncomeLevel", "countryResidence", "BMIcat", "METs_over1200", "comorbNumber_")
footnote_no <- 3

desctable2 <- function(df, var){
  n <- nrow(df)
  control <- prop.test(x=nrow(df[df[[var]]==TRUE & !is.na(df[[var]]),]),
                           n=nrow(df), alternative="two.sided", conf.level=0.95)
  pct_control <- pretty_dp(control$estimate, dp=1, pct=TRUE)
  
  table <- cbind(n, pct_control)
  return(table)
}

n <- data.frame(descriptivetable(df=treated, 
                         varlist=varlist,
                         contavg='median',
                         pretty_names=pretty_names,
                         footnote_list=footnote_list),
                stringsAsFactors = FALSE)

pct_ctrl <- c()
for(var in varlist){
  for(level in levels(treated[[var]])){
    newrow <- desctable2(treated[treated[var]==level,], var="controlled")
    pct_ctrl <- rbind(pct_ctrl, cbind(level, newrow))
  }
}

adj <- regressiontable(df=treated, outcome="controlled", varlist=varlist, 
                       regresstype="adjusted", adjvarlist=c("agegrp", "gender"))
multi <- regressiontable(df=treated, outcome="controlled", varlist=varlist, 
                         regresstype="multivariable")

tab3 <- merge(adj, multi, by=c("IDcol", "Coefficient", "Level"), sort=FALSE)
# Add n column
tab3 <- cbind(n[,1:3], pct_ctrl[,3], tab3[,4:9])

# Hide "unanswered"/"unknown"/"do not know" categories
tab3 <- tab3[-which(tab3$Level %in% c("Unknown", "Unanswered", "Do not know", "Prefer not to answer")),]
rownames(tab3) <- NULL

tab3 <- rbind(c("Coefficient", "Level", "n^1^", "% Controlled^2^", "OR", "95% CI", "p", "OR", "95% CI", "p"),
              as.matrix(tab3))
colnames(tab3) <- c("","","","", 
                    "Age- and sex-adjusted", "", "", 
                    "Multivariable- adjusted", "", "")

# Output the resulting table
add_footnote(kable(tab3), label=c("Number of individuals in levels of a categorical variable may not add up to total n because 'Do not know' and 'Prefer not to answer' categories have been removed from results table",
                                  "Hypertension control is defined as mean systolic BP >= 140 mmHg or mean diastolic BP >= 90 mmHg at baseline assessment, among treated hypertensives.",
                                  "The Townsend index is a measure of material deprivation calculated at the level of census output areas.", 
                                  "Occupation categories have been condensed from those recorded in UKB. Professional and Administrative: Managers and Senior Officials, Professional Occupations, Associate Professional and Technical Occupations, Administrative and Secretarial Occupations. Skilled trades: Skilled Trades Occupations. Services: Personal Service Occupations, Sales and Customer Service Occupations. Manual and Industrial: Process, Plant and Machine Operatives, Elementary Occupations. Other employment: free text entry that was not coded by UKB.", 
                                  "Self-reported highest education achieved was mapped to the International Standard Classification of Education (ISCED) categories",
                                  "Self-reported country of birth was mapped to the World Bank Analytical Classifications for calendar year 2010.",
                                  "The assessment centre the participant attended was used as a proxy for country of residence",
                                  "BMI has been categorised as: Underweight < 18.5 kg/m^2^; Normal 18.5 - 24.9 kg/m^2^; Overweight 25.0 - 29.9 kg/m^2^; Obese >= 30.0 kg/m^2^.", 
                                  "The total Metabolic Equivalent Task (MET) minutes per week is based on self-reported frequency and duration of walking, moderate and vigorous activity, and was then dichotomized based on WHO physical activity guideline thresholds.",
                                  paste0("The number of comorbidities considered to be of interest - ", paste(sapply(comorbs_string, prettyfunc,  pnames=pretty_names, upper=FALSE), collapse=", "), ".")
                                  ), notation="number")

```

## Table 2b: With DBP PRS. Identifying factors associated with hypertension control, among middle-aged UK adults on anti-hypertensive treatment with genetic data available (n=`r nrow(data)`)

```{r table2_DBP, include=TRUE, echo=FALSE}

varlist=c("agegrp", "gender", "eth_group", "PRS_DBP_quint_",
          "townsend_quint", "income", "employcat", "ISCED", "BirthCountryIncomeLevel", "countryResidence",
          "BMIcat", "Smo_Status", "weekly_alccat", "METs_over1200",
          "antiHTNmedsno",  "FamilyHist_CVD_",
          "BowelCancerScreening",
          "comorbNumber_")

footnote_list <- c("townsend_quint", "employcat", "ISCED", "BirthCountryIncomeLevel", "countryResidence", "BMIcat", "METs_over1200", "comorbNumber_")
footnote_no <- 3

desctable2 <- function(df){
  n <- nrow(df)
  control <- prop.test(x=nrow(df[df$controlled==TRUE & !is.na(df$controlled),]),
                           n=nrow(df), alternative="two.sided", conf.level=0.95)
  pct_control <- pretty_dp(control$estimate, dp=1, pct=TRUE)
  
  table <- cbind(n, pct_control)
  return(table)
}

n <- data.frame(descriptivetable(df=treated, 
                         varlist=varlist,
                         contavg='median',
                         pretty_names=pretty_names,
                         footnote_list=footnote_list),
                stringsAsFactors = FALSE)

pct_ctrl <- c()
for(var in varlist){
  for(level in levels(treated[[var]])){
    newrow <- desctable2(treated[treated[var]==level,])
    pct_ctrl <- rbind(pct_ctrl, cbind(level, newrow))
  }
}

adj <- regressiontable(df=treated, outcome="controlled", varlist=varlist, 
                       regresstype="adjusted", adjvarlist=c("agegrp", "gender"))
multi <- regressiontable(df=treated, outcome="controlled", varlist=varlist, 
                         regresstype="multivariable")

tab3 <- merge(adj, multi, by=c("IDcol", "Coefficient", "Level"), sort=FALSE)
# Add n column
tab3 <- cbind(n[,1:3], pct_ctrl[,3], tab3[,4:9])

# Hide "unanswered"/"unknown"/"do not know" categories
tab3 <- tab3[-which(tab3$Level %in% c("Unknown", "Unanswered", "Do not know", "Prefer not to answer")),]
rownames(tab3) <- NULL

tab3 <- rbind(c("Coefficient", "Level", "n^1^", "% Controlled^2^", "OR", "95% CI", "p", "OR", "95% CI", "p"),
              as.matrix(tab3))
colnames(tab3) <- c("","","","", 
                    "Age- and sex-adjusted", "", "", 
                    "Multivariable- adjusted", "", "")

# Output the resulting table
add_footnote(kable(tab3), label=c("Number of individuals in levels of a categorical variable may not add up to total n because 'Do not know' and 'Prefer not to answer' categories have been removed from results table",
                                  "Hypertension control is defined as mean systolic BP >= 140 mmHg or mean diastolic BP >= 90 mmHg at baseline assessment, among treated hypertensives.",
                                  "The Townsend index is a measure of material deprivation calculated at the level of census output areas.", 
                                  "Occupation categories have been condensed from those recorded in UKB. Professional and Administrative: Managers and Senior Officials, Professional Occupations, Associate Professional and Technical Occupations, Administrative and Secretarial Occupations. Skilled trades: Skilled Trades Occupations. Services: Personal Service Occupations, Sales and Customer Service Occupations. Manual and Industrial: Process, Plant and Machine Operatives, Elementary Occupations. Other employment: free text entry that was not coded by UKB.", 
                                  "Self-reported highest education achieved was mapped to the International Standard Classification of Education (ISCED) categories",
                                  "Self-reported country of birth was mapped to the World Bank Analytical Classifications for calendar year 2010.",
                                  "The assessment centre the participant attended was used as a proxy for country of residence",
                                  "BMI has been categorised as: Underweight < 18.5 kg/m^2^; Normal 18.5 - 24.9 kg/m^2^; Overweight 25.0 - 29.9 kg/m^2^; Obese >= 30.0 kg/m^2^.", 
                                  "The total Metabolic Equivalent Task (MET) minutes per week is based on self-reported frequency and duration of walking, moderate and vigorous activity, and was then dichotomized based on WHO physical activity guideline thresholds.",
                                  paste0("The number of comorbidities considered to be of interest - ", paste(sapply(comorbs_string, prettyfunc,  pnames=pretty_names, upper=FALSE), collapse=", "), ".")
                                  ), notation="number")

```

## Table 2c: With both SBP and DBP PRS. Identifying factors associated with hypertension control, among middle-aged UK adults on anti-hypertensive treatment with genetic data available (n=`r nrow(data)`)

```{r table2_SBPDBP, include=TRUE, echo=FALSE}

varlist=c("agegrp", "gender", "eth_group", "PRS_SBP_quint_", "PRS_DBP_quint_",
          "townsend_quint", "income", "employcat", "ISCED", "BirthCountryIncomeLevel", "countryResidence",
          "BMIcat", "Smo_Status", "weekly_alccat", "METs_over1200",
          "antiHTNmedsno",  "FamilyHist_CVD_",
          "BowelCancerScreening",
          "comorbNumber_")

footnote_list <- c("townsend_quint", "employcat", "ISCED", "BirthCountryIncomeLevel", "countryResidence", "BMIcat", "METs_over1200", "comorbNumber_")
footnote_no <- 3

desctable2 <- function(df){
  n <- nrow(df)
  control <- prop.test(x=nrow(df[df$controlled==TRUE & !is.na(df$controlled),]),
                           n=nrow(df), alternative="two.sided", conf.level=0.95)
  pct_control <- pretty_dp(control$estimate, dp=1, pct=TRUE)
  
  table <- cbind(n, pct_control)
  return(table)
}

n <- data.frame(descriptivetable(df=treated, 
                         varlist=varlist,
                         contavg='median',
                         pretty_names=pretty_names,
                         footnote_list=footnote_list),
                stringsAsFactors = FALSE)

pct_ctrl <- c()
for(var in varlist){
  for(level in levels(treated[[var]])){
    newrow <- desctable2(treated[treated[var]==level,])
    pct_ctrl <- rbind(pct_ctrl, cbind(level, newrow))
  }
}

adj <- regressiontable(df=treated, outcome="controlled", varlist=varlist, 
                       regresstype="adjusted", adjvarlist=c("agegrp", "gender"))
multi <- regressiontable(df=treated, outcome="controlled", varlist=varlist, 
                         regresstype="multivariable")

tab3 <- merge(adj, multi, by=c("IDcol", "Coefficient", "Level"), sort=FALSE)
# Add n column
tab3 <- cbind(n[,1:3], pct_ctrl[,3], tab3[,4:9])

# Hide "unanswered"/"unknown"/"do not know" categories
tab3 <- tab3[-which(tab3$Level %in% c("Unknown", "Unanswered", "Do not know", "Prefer not to answer")),]
rownames(tab3) <- NULL

tab3 <- rbind(c("Coefficient", "Level", "n^1^", "% Controlled^2^", "OR", "95% CI", "p", "OR", "95% CI", "p"),
              as.matrix(tab3))
colnames(tab3) <- c("","","","", 
                    "Age- and sex-adjusted", "", "", 
                    "Multivariable- adjusted", "", "")

# Output the resulting table
add_footnote(kable(tab3), label=c("Number of individuals in levels of a categorical variable may not add up to total n because 'Do not know' and 'Prefer not to answer' categories have been removed from results table",
                                  "Hypertension control is defined as mean systolic BP >= 140 mmHg or mean diastolic BP >= 90 mmHg at baseline assessment, among treated hypertensives.",
                                  "The Townsend index is a measure of material deprivation calculated at the level of census output areas.", 
                                  "Occupation categories have been condensed from those recorded in UKB. Professional and Administrative: Managers and Senior Officials, Professional Occupations, Associate Professional and Technical Occupations, Administrative and Secretarial Occupations. Skilled trades: Skilled Trades Occupations. Services: Personal Service Occupations, Sales and Customer Service Occupations. Manual and Industrial: Process, Plant and Machine Operatives, Elementary Occupations. Other employment: free text entry that was not coded by UKB.", 
                                  "Self-reported highest education achieved was mapped to the International Standard Classification of Education (ISCED) categories",
                                  "Self-reported country of birth was mapped to the World Bank Analytical Classifications for calendar year 2010.",
                                  "The assessment centre the participant attended was used as a proxy for country of residence",
                                  "BMI has been categorised as: Underweight < 18.5 kg/m^2^; Normal 18.5 - 24.9 kg/m^2^; Overweight 25.0 - 29.9 kg/m^2^; Obese >= 30.0 kg/m^2^.", 
                                  "The total Metabolic Equivalent Task (MET) minutes per week is based on self-reported frequency and duration of walking, moderate and vigorous activity, and was then dichotomized based on WHO physical activity guideline thresholds.",
                                  paste0("The number of comorbidities considered to be of interest - ", paste(sapply(comorbs_string, prettyfunc,  pnames=pretty_names, upper=FALSE), collapse=", "), ".")
                                  ), notation="number")

```

# Compute observed SBP and DBP by quintile of each PRS (watchout for influence of outliers).  A box and whisker plot would be good.

## Mean and median observed SBP and DBP by quintile of SBP PRS

```{r}

means_Squint <- aggregate(data[,c("SBP", "DBP")], list(data$PRS_SBP_quint), mean)
means_Squint[,c("SBP", "DBP")] <- pretty_dp(means_Squint[,c("SBP", "DBP")], 2)
medians_Squint <- aggregate(data[,c("SBP", "DBP")], list(data$PRS_SBP_quint), median)
medians_Squint[,c("SBP", "DBP")] <- pretty_dp(medians_Squint[,c("SBP", "DBP")], 2)
S_obs <- merge(means_Squint, medians_Squint, by="Group.1", suffixes=c(" Mean", " Median"))
kable(S_obs)

```

## Mean and median observed SBP and DBP by quintile of DBP PRS

```{r}

means_Dquint <- aggregate(data[,c("SBP", "DBP")], list(data$PRS_DBP_quint), mean)
means_Dquint[,c("SBP", "DBP")] <- pretty_dp(means_Dquint[,c("SBP", "DBP")], 2)
medians_Dquint <- aggregate(data[,c("SBP", "DBP")], list(data$PRS_DBP_quint), median)
medians_Dquint[,c("SBP", "DBP")] <- pretty_dp(medians_Dquint[,c("SBP", "DBP")], 2)
D_obs <- merge(means_Dquint, medians_Dquint, by="Group.1", suffixes=c(" Mean", " Median"))
kable(D_obs)

```

## Boxplots

```{r}

boxplot(SBP~PRS_SBP_quint,  data=data, main="SBP by quintile of SBP PRS", 
        xlab="SBP PRS score, quintiles", ylab="Systolic BP at baseline")

boxplot(DBP~PRS_DBP_quint,  data=data, main="DBP by quintile of DBP PRS", 
        xlab="DBP PRS score, quintiles", ylab="Diastolic BP at baseline")

```

## Removing outlying BP values:

Define outliers as those values below Q1 - 1.5 IQR or above Q3 + 1.5 IQR (note here Q = quartile not quintile!)

```{r}

Squartile <- quantile(data$SBP, probs=seq(0, 1, 0.25), na.rm=TRUE)
SIQR <- Squartile[4] - Squartile[2]

Dquartile <- quantile(data$DBP, probs=seq(0, 1, 0.25), na.rm=TRUE)
DIQR <- Dquartile[4] - Dquartile[2]

data_out <- data[(data$SBP>=(Squartile[2]-(1.5*SIQR)) & data$SBP<=(Squartile[4]+(1.5*SIQR))) &
                    (data$DBP>=(Dquartile[2]-(1.5*DIQR)) & data$DBP<=(Dquartile[4]+(1.5*DIQR))),]

```

Exclude individuals from the dataset for whom either their SBP or DBP value is an outlier. There are `r nrow(data_out)` individuals remaining.

Repeat the above tables without outliers:

### Mean and median observed SBP and DBP by quintile of SBP PRS, outliers removed

```{r}

means_Squint <- aggregate(data_out[,c("SBP", "DBP")], list(data_out$PRS_SBP_quint), mean)
means_Squint[,c("SBP", "DBP")] <- pretty_dp(means_Squint[,c("SBP", "DBP")], 2)
medians_Squint <- aggregate(data_out[,c("SBP", "DBP")], list(data_out$PRS_SBP_quint), median)
medians_Squint[,c("SBP", "DBP")] <- pretty_dp(medians_Squint[,c("SBP", "DBP")], 2)
S_obs <- merge(means_Squint, medians_Squint, by="Group.1", suffixes=c(" Mean", " Median"))
kable(S_obs)

```

### Mean and median observed SBP and DBP by quintile of DBP PRS, outliers removed

```{r}

means_Dquint <- aggregate(data_out[,c("SBP", "DBP")], list(data_out$PRS_DBP_quint), mean)
means_Dquint[,c("SBP", "DBP")] <- pretty_dp(means_Dquint[,c("SBP", "DBP")], 2)
medians_Dquint <- aggregate(data_out[,c("SBP", "DBP")], list(data_out$PRS_DBP_quint), median)
medians_Dquint[,c("SBP", "DBP")] <- pretty_dp(medians_Dquint[,c("SBP", "DBP")], 2)
D_obs <- merge(means_Dquint, medians_Dquint, by="Group.1", suffixes=c(" Mean", " Median"))
kable(D_obs)

```