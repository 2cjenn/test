---
title: "Hypertension Medication Exploration"
author: "Jennifer Collister"
date: "07/02/2020"
output: 
  word_document:
      reference_docx: "K:/TEU/TEU Guides/TEU_DocStyle_Rmd_2020.dotx"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(kableExtra)
library(knitr)
library(readxl)

source("K:/TEU/APOE on Dementia/Statistical Analysis/JCfunctions.R")

```

```{r loaddata, include=FALSE}
data <- readRDS(file="K:\\TEU\\APOE on Dementia\\Data Management\\R_Dataframes_TLA\\38358\\Organised\\apoe_excl.rds")
# data <- data[data$age >= 50 & data$age < 70,]

# Create a couple of factor variables
data$selfrephyp <- data$prevHBP==TRUE | data$VIhyp==TRUE
data$control <- !(data$SBP>=140 | data$DBP>=90)

# Center age on the minimum
data$c_age <- data$age - 50

# Make the key dichotomous variables into factors to improve readability of outputs
data$selfrephyp <- factor(as.numeric(data$selfrephyp), levels=c(0,1), labels=c("Did not report hypertension", "Self-reported hypertensive"))
data$prevHBP <- factor(as.numeric(data$prevHBP), levels=c(0,1), labels=c("Did not report hypertension", "Self-reported hypertensive in touchscreen questionnaire"))
data$VIhyp <- factor(as.numeric(data$VIhyp), levels=c(0,1), labels=c("Did not report hypertension", "Self-reported hypertensive in verbal interview"))
data$measuredhyp <- factor(as.numeric(data$measuredhyp), levels=c(0,1), labels=c("Not hypertensive at baseline", "Measured hypertensive at baseline"))
data$HBPmeds <- factor(as.numeric(data$HBPmeds), levels=c(0,1), labels=c("Did not report BP medication", "Self-reported BP medication"))
data$control <- factor(as.numeric(data$control), levels=c(0,1), labels=c("Inadequately controlled", "Successfully controlled"))

# table(data$selfrephyp, useNA='ifany')
# table(data$HBPmeds[data$selfrephyp=="Self-reported hypertensive"], useNA='ifany')
# table(data$control[data$selfrephyp=="Self-reported hypertensive" & data$HBPmeds=="Self-reported BP medication"], useNA='ifany')
# table(data$measuredhyp[data$selfrephyp=="Did not report a diagnosis"], useNA='ifany')
```

There are 502,520 individuals in UKB, of whom 363,983 are recorded as taking at least one medication during the verbal interview. The others have NA, which probably means that they are not taking any medication, but could in some cases mean that they were not asked about it - I don't think we have any way of knowing for certain. There are 112,372 individuals taking medications which we have classified as potential anti-hypertensives.

In the data-set we're using for the APOE analysis, we consider only individuals in the age range of [50,70) with white ethnicity, data on measured blood pressure at baseline, and no previous history of dementia. After these exclusions there are 442,767 individuals in our data set, 322,033 of whom are recorded as taking at least one medication, and 98,121 of these are taking medications we have classified as anti-hypertensives.


```{r VImedsData, include=TRUE, echo=FALSE}

VImeds <- readRDS(file="K:\\TEU\\APOE on Dementia\\Data Management\\R_Dataframes_TLA\\38358\\Organised\\VIhypmeds.rds")

sums <- colSums(VImeds[,c("AB", "ACEI", "ARBs", "BB", "CCB", "Potassium-sparing diuretic", "Thiazide", "Vasodilator", "Spironolactone")], na.rm=TRUE)
kable((sums), caption="Number of individuals taking each of the main drug classes (individuals can be taking drugs from multiple classes)")
# sum(rowSums(VImeds[,-c(1)], na.rm=TRUE)==0)

```

Defining our hypertensive medication categories,

* Group 1: Taking one or more of ACEi, ARB, CCB
* Group 2: Taking a Group 1 drug AND an AB, BB or Spironolactone
* Thiazide only: Taking a thiazide-like diuretic WITHOUT any of the Group 1 drugs
* Thiazide + group 2: Taking a thiazide-like diuretic WITHOUT any of the Group 1 drugs, AND an AB, BB or Spironolactone

Note: The thiazide only group could be individuals who were prescribed thiazide-like diuretics as first-line anti-hypertensive medication before clinical practice changed.


```{r Groups, include=TRUE, echo=FALSE}

# Group 1: One or more first, second or third line drugs - plus thiazide-like diuretic
# Ace Inhibitors (ACEI), Angiotensin II receptor blockers (ARBs) and Calcium Channel Blockers (CCB)
VImeds$grp1 <- rowSums(VImeds[,c("ACEI", "ARBs", "CCB")], na.rm=TRUE)>0
VImeds$thiazide <- rowSums(VImeds[,c("Thiazide")], na.rm=TRUE)>0
VImeds$grp1T <- VImeds$thiazide & !VImeds$grp1

# Group 2: 1st, 2nd or 3rd line drugs plus Spironolactone or Alpha Blocker (AB)
VImeds$line2 <- rowSums(VImeds[,c("AB", "BB", "Spironolactone")], na.rm=TRUE)>0
VImeds$grp2 <- rowSums(VImeds[,c("grp1", "line2")], na.rm=TRUE)==2
VImeds$grp2T <- rowSums(VImeds[,c("grp1T", "line2")], na.rm=TRUE)==2

VImeds$hypgrp <- ifelse(VImeds$grp2==TRUE, "Group 2", ifelse(VImeds$grp1==TRUE, "Group 1", ifelse(VImeds$grp2T==TRUE, "Thiazide + group 2", ifelse(VImeds$grp1T==TRUE, "Thiazide only", VImeds$hypmeds))))


medsdata <- merge(data[,c("ID", "measuredhyp", "selfrephyp", "HBPmeds", "medication", "VIhyp", "prevHBP")], 
                  VImeds,#[,c("ID", "grp1", "grp2", "grp1T", "grp2T", "hypgrp", "hypmeds")], 
                  by="ID", all.x=TRUE)
medsdata$hypmeds[is.na(medsdata$hypmeds)] <- "Not taking any medication"
medsdata$hypgrp[is.na(medsdata$hypgrp)] <- "Not taking any medication"
medsdata$hypgrp <- factor(medsdata$hypgrp, levels=c("Group 1", "Group 2", "Thiazide only", "Thiazide + group 2", "Taking potential BP medication", "Taking other medication", "Not taking any medication"))

kable(propped(table(medsdata$hypmeds,medsdata$HBPmeds, useNA='ifany'), margin=2), caption="Approximate tabulation - before refining whether individuals taking potentially anti-hypertensive medication are likely to be taking them for BP control or other reasons")

kable(propped(table(medsdata$hypgrp, medsdata$HBPmeds, useNA='ifany'), margin=2), caption="Tabulation to check agreement between reported BP medication and actual meds taken, among individuals who are taking at least one medication")
```

There are four categories here that seem worth some further exploration:

```{r preliminary, include=TRUE, echo=FALSE}

medsdata$weirdcategories[medsdata$HBPmeds=="Self-reported BP medication" & !is.na(medsdata$HBPmeds) & medsdata$hypgrp=="Taking potential BP medication"] <- "1. Non-standard BP treatment path?"
# table(ObscureBPmeds$AB)
# table(ObscureBPmeds$BB)
# table(ObscureBPmeds$AB, ObscureBPmeds$BB)

medsdata$weirdcategories[medsdata$HBPmeds=="Self-reported BP medication" & !is.na(medsdata$HBPmeds) & medsdata$hypgrp=="Taking other medication"] <- "2. Reported BP meds, taking non-BP meds"

medsdata$weirdcategories[medsdata$HBPmeds=="Self-reported BP medication" & !is.na(medsdata$HBPmeds) & medsdata$hypgrp=="Not taking any medication"] <- "3. Reported BP meds, not taking any meds"

medsdata$weirdcategories[medsdata$HBPmeds=="Did not report BP medication" & !is.na(medsdata$HBPmeds) & medsdata$hypgrp=="Taking potential BP medication"] <- "4. Did not report BP meds but taking BP meds?"


kable(propped(table(medsdata$weirdcategories, medsdata$VIhyp), margin=1), caption="Number of individuals in each of four categories that warrant further investigation, split by whether or not the self-reported a diagnosis of hypertension at verbal interview")

```

```{r NonCancerIllnessCodes, include=TRUE, echo=FALSE}

diagnoses <- readRDS(file="K:\\TEU\\APOE on Dementia\\Data Management\\R_Dataframes_TLA\\38358\\Organised\\Neo\\VIhypIllnesses.rds")


diagnoses <- merge(medsdata[!is.na(medsdata$weirdcategories), c("ID", "weirdcategories")], diagnoses, by="ID", all.x=TRUE)

```


### 1. Self-reported BP medication, taking potentially anti-hypertensive drugs - non-standard hypertension treatment pathway

Of the 6847 individuals who self-reported that they were taking BP medication and were taking some drugs that we categorised as potentially anti-hypertensives but did not conform to one of our expected hypertension treatment pathways, 6843 were taking at least one group 2 drug (an AB, BB and/or spironolactone), without any group 1 drugs or thiazide-like diuretics.

Of the remaining 5, 4 were taking vasodilators and 1 was taking a potassium-sparing diuretic (triamterene).

At verbal interview, 5449 of these individuals were recorded as having a diagnosis of hypertension (1398 were not). Note that our definition of hypertension at verbal interview does not include gestational hypertension.

```{r Cat1_diagnoses, include=TRUE, echo=FALSE}

# length((diagnoses$ID[diagnoses$weirdcategories=="1. Non-standard BP treatment path?"]))

kable(colSums(diagnoses[diagnoses$weirdcategories=="1. Non-standard BP treatment path?",-c(1:2)], na.rm=TRUE), caption="Number of individuals with each of our previously discussed non-cancer illness code categories from verbal interview (individuals can have more than one condition)")
```

### 2. Self-reported BP medication, taking medication that we did not classify as potentially anti-hypertensive

Of the 2908 individuals who self-reported that they were taking BP medication and were taking some form of medication that we did not classify as potentially anti-hypertensive, 2139 were recorded as having a diagnosis of hypertension in the verbal interview (769 were not). 

Would you like me to look into what medications they are taking? (This would mean going back to the list of ~6500 different brand name drugs and trying to look for any patterns among these ~3k individuals, so I want to check you think it would add value before sinking time into it!)

### 3. Self-reported BP medication, not taking any medication

Of the 264 individuals who self-reported that they were taking BP medication but upon verbal interview did not report any medications, 231 were recorded as having a diagnosis of hypertension in the verbal interview (33 were not).

Although it's weird that they self-reported BP meds then self-reported no meds, there's not really any more data with which to investigate this further. Luckily not many people - could be some errors when completing the touchscreen questionnaire?

### 4. Did not self-report BP medication, taking potentially anti-hypertensive drugs

Of the 5056 individuals who did not self-report BP medication but are taking some drugs that we categorised as potentially anti-hypertensive, 599 were recorded as having a diagnosis of hypertension at verbal interview (4457 were not). Note that our definition of hypertension at verbal interview does not include gestational hypertension.

```{r Cat4_diagnoses, include=TRUE, echo=FALSE}
kable(colSums(diagnoses[diagnoses$weirdcategories=="4. Did not report BP meds but taking BP meds?",-c(1:2)], na.rm=TRUE), caption="Number of individuals with each of our previously discussed non-cancer illness code categories from verbal interview (individuals can have more than one condition)")
```