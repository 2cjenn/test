---
title: "APOE - investigating the interaction"
author: "Jennifer Collister"
date: "06/01/2020"
output: html_document

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(survival)
library(survminer)
library(lmtest)
library(kableExtra)
library(knitr)
library(timereg)
library(epitools)
library(popEpi)
source("K:/TEU/APOE on Dementia/Statistical_Analysis/JCfunctions.R")
library(yaml)
library(here)

# Specify the markdown format for knitr tables, otherwise they're not compatible with kableExtra
options(knitr.kable.NA='', knitr.table.format = "markdown")
options(kableExtra.auto_format = FALSE)
# Set the root directory to the project directory (otherwise knitr works in the directory of the Rmd file by default)
knitr::opts_knit$set(root.dir = here::here())

# Load the project config file for filepaths etc
config = yaml.load_file(here::here("./config.yml"))

# Load data
apoe <- readRDS(file=paste0(config$analysisdata$apoe_old, "apoe_surv.rds"))

```

```{r exclusions, include=FALSE}
# Read in the dataset

apoe$e4carrier <- apoe$apoe4>0
apoe$apoe4 <- factor(apoe$apoe4)
apoe$number_of_apoe4_alleles <- apoe$apoe4

apoe$alcdaily <- apoe$Alc_Freq=="Daily or almost daily"
apoe$diab <- apoe$diabetes=="Yes"


## Genetic exclusions

# Exclude individuals with APOE e1 because it's rare and don't know much about it
# Exclude individuals with genotype e2/e4 because they cancel out?
# Also can't be definitively sure if genotype is e1/e3 or e2/e4
apoe <- apoe[apoe$apoe1==0 & !is.na(apoe$apoe1),]

# Exclude individuals with genetic/reported sex mismatch
apoe$Sex <- factor(apoe$Sex, ordered=FALSE)
apoe <- apoe[apoe$Sex == apoe$gender,]


## Other important exclusions

# Exclude individuals with missing BP data
apoe <- apoe[!is.nan(apoe$SBP) & !is.nan(apoe$DBP),]
apoe$definedhypertension <- apoe$SBP >= 140 | apoe$DBP >= 90

# Restrict to self-report "white"
apoe <- apoe[apoe$group=="White",]

# Exclude individuals with prevalent dementia
apoe <- apoe[!apoe$VIdementia,]
apoe <- apoe[is.na(apoe$dement_date) | (apoe$dement_date>apoe$recdate & !is.na(apoe$dement_date)),]


# Exclude individuals with no age data
apoe <- apoe[!is.na(apoe$age),]
# Exclude those outside the 40-70 age range
apoe <- apoe[apoe$age >= 50 & apoe$age < 70,]


```
## Exclusions
* No APOE genetic data
* Genetic/reported sex mismatch
* Incomplete blood pressure data
* Individuals outside the defined UKB age range (40-69) were excluded
  * After discussion, individuals below the age of 50 were excluded as dementia cases at such young ages were considered likely due to other causes and to add noise to the data
* Prevalent dementia
* Non-white ethnicity

## Kaplan-Meier plots by group

In the Kaplan-Meier curves we see that APOE e4 carriers have a higher dementia rate than those with no e4 alleles, and individuals with hypertension have a higher dementia rate than those without.

```{r km, include=TRUE, echo=FALSE}
# Survival analysis: time to dementia
surv <- Surv(apoe$time_to_dementia_yrs, apoe$dementia_status)

ggsurvplot(survfit(surv~e4carrier, data=apoe), data=apoe, ylim=c(0.95,1), risk.table=TRUE, ylab="Proportion without dementia", title="Kaplan-Meier plot of time to dementia diagnosis \nby APOE e4 carrier status", xlab="Time, years", censor=FALSE)

ggsurvplot(survfit(surv~definedhypertension, data=apoe), data=apoe, ylim=c(0.95,1), risk.table=TRUE, ylab="Proportion without dementia", title="Kaplan-Meier plot of time to dementia diagnosis \nby hypertension status", xlab="Time, years", censor=FALSE)
```

## Incidence rates

```{r incidencerates, include=TRUE, echo=FALSE}


# Risk of dementia in each category
case <- table(apoe$definedhypertension[apoe$dementia_status==TRUE], apoe$e4carrier[apoe$dementia_status==TRUE])
pop <- table(apoe$definedhypertension, apoe$e4carrier)
inc <- round(100*case/pop,2)
names(dimnames(inc)) <- c("Hypertension", "APOE e4 carrier")
inc

# Define categorical age groups
apoe$agegrp <- cut(apoe$age, c(50, 55, 60, 65, 70), right=FALSE)
# Number of individuals in each age group
agepop <- table(apoe$agegrp)
# Number of person-years in each age group
pyears <- aggregate(apoe$time_to_dementia_yrs, by=list(apoe$agegrp), FUN=sum)


# Crude incidence rate per age group in the whole population
# Number of individuals in each age group by dementia status
agedement <- table(apoe$agegrp, apoe$dementia_status)
# Divide dementia cases by person-years in each age group
wholepop <- agedement[,2]/(pyears[,2]/100000)

# Age-adjusted
# To Do: make this into a function instead of copy-pasting
# Produce tables of crude and age-adjusted incidence rates in specified groups
incrates <- c(wholepop)
adjrates <- c()
for (df in list(apoe[apoe$e4carrier==TRUE,], 
                apoe[apoe$e4carrier==FALSE,],
                apoe[apoe$definedhypertension==TRUE,],
                apoe[apoe$definedhypertension==FALSE,])
     ) {
  
  agedement <- table(df$agegrp, df$dementia_status)
  pyears <- aggregate(df$time_to_dementia_yrs, by=list(df$agegrp), FUN=sum)
  
  # Crude incidence rates
  incrate <- round(agedement[,2]/(pyears[,2]/100000),2)
  incrates <- cbind(incrates, incrate)
  
  # Adjusted incidence rates
  adjrate <- ageadjust.direct(count=agedement[,2], pop=pyears[,2], stdpop=agepop)
  adjrate <- round(100000*adjrate,2)
  adjrates <- rbind(adjrates, adjrate)
}
colnames(incrates) <- c("Whole population", "e4 carriers", "no e4 alleles", "hypertensives", "not hypertensives")
kable(incrates, caption="Comparing crude incidence rates per 100,000 person-years in different groups")

rownames(adjrates) <- c("e4 carriers", "no e4 alleles", "hypertensives", "not hypertensives")
kable(adjrates, caption="Comparing age-adjusted incidence rates per 100,000 person years in different groups")


# Pair-wise groups
incrates <- c(wholepop)
adjrates <- c()
for (df in list(apoe[apoe$e4carrier==FALSE & apoe$definedhypertension==FALSE,], 
                apoe[apoe$e4carrier==TRUE & apoe$definedhypertension==FALSE,],
                apoe[apoe$e4carrier==FALSE & apoe$definedhypertension==TRUE,],
                apoe[apoe$e4carrier==TRUE & apoe$definedhypertension==TRUE,])
     ) {
  agedement <- table(df$agegrp, df$dementia_status)
  pyears <- aggregate(df$time_to_dementia_yrs, by=list(df$agegrp), FUN=sum)
  
  # Crude incidence rates
  incrate <- round(agedement[,2]/(pyears[,2]/100000),2)
  incrates <- cbind(incrates, incrate)
  
  # Adjusted incidence rates
  adjrate <- ageadjust.direct(count=agedement[,2], pop=pyears[,2], stdpop=agepop)
  adjrate <- round(100000*adjrate,2)
  adjrates <- rbind(adjrates, adjrate)
}
colnames(incrates) <- c("Whole population", "No e4 alleles, not hypertensive", "e4 carrier, not hypertensive", "No e4 alleles, hypertensive", "e4 carrier, hypertensive")
kable(incrates, caption="Comparing crude incidence rates per 100,000 person-years in different groups")

rownames(adjrates) <- c("No e4 alleles, not hypertensive", "e4 carrier, not hypertensive", "No e4 alleles, hypertensive", "e4 carrier, hypertensive")
kable(adjrates, caption="Comparing age-adjusted incidence rates per 100,000 person years in different groups")



```

## Cox model without interaction
```{r basemodel, include=TRUE, echo=FALSE}

# Interaction between hypertension and APOE e4
base <- coxph(Surv(time_to_dementia, dementia_status) ~ age + gender + definedhypertension + e4carrier, data=apoe)
base
L0 <- logLik(base)
```

## Cox model with interaction
```{r interactmodel, include=TRUE, echo=FALSE}

# Interaction between hypertension and APOE e4
interact <- coxph(Surv(time_to_dementia, dementia_status) ~ age + gender + definedhypertension * e4carrier, data=apoe)
interact
L1 <- logLik(interact)
```

#### Residual sums of squares test to determine whether the inclusion of the interaction significantly improves model fit
```{r lrtest, include=TRUE, echo=FALSE}

anova(base, interact)

# Likelihood ratio test
k <- 4
1 - pchisq(2*(L1-L0), df=k-1)
# What's k?

```

## Stratified analysis
```{r strat, include=TRUE, echo=TRUE}
# Stratified analysis
# Among APOE e4 carriers
coxph(Surv(time_to_dementia, dementia_status) ~ age + gender + definedhypertension, data=apoe[apoe$e4carrier==TRUE,])
# Among hypertensives
coxph(Surv(time_to_dementia, dementia_status) ~ age + gender + e4carrier, data=apoe[apoe$definedhypertension==TRUE,])
```

## Joint effects analysis
```{r joint, include=TRUE, echo=FALSE}
# Joint effects analysis
apoe$joint <- interaction(as.numeric(apoe$e4carrier), as.numeric(apoe$definedhypertension))
apoe$joint <- factor(as.numeric(apoe$joint)-1, labels=c("not a carrier, no hypertension", "e4 carrier, no hypertension", "not a carrier, hypertensive", "e4 carrier, hypertensive"))
coxph(Surv(time_to_dementia, dementia_status) ~ age + gender + joint, data=apoe)
```

Based on the joint-effect results, and assuming additivity, we would expect the hazards ratio of hypertensive e4 carriers to be 2.74 + 1.14 - 1 = 2.88, and we can see that this deviates from the observed hazard ratio of 3.61.

