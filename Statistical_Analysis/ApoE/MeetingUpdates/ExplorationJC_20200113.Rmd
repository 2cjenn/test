---
title: "ExplorationJC_20200113"
author: "Jennifer Collister"
date: "16/01/2020"
output: 
  word_document:
      reference_docx: "K:/TEU/TEU Guides/TEU_DocStyle_Rmd_2020.dotx"
      fig_width: 4
      fig_height: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(survival)
library(survminer)
library(lmtest)
library(kableExtra)
library(knitr)
library(timereg)
library(epitools)
library(tab)
library(popEpi)
source("K:/TEU/APOE on Dementia/Statistical_Analysis/JCfunctions.R")
library(yaml)
library(here)

# Specify the markdown format for knitr tables, otherwise they're not compatible with kableExtra
options(knitr.kable.NA='', knitr.table.format = "markdown")
options(kableExtra.auto_format = FALSE)
# Set the root directory to the project directory (otherwise knitr works in the directory of the Rmd file by default)
knitr::opts_knit$set(root.dir = here::here())

# Load the project config file for filepaths etc
config = yaml.load_file(here::here("./config.yml"))

# Load data
data <- readRDS(file=paste0(config$analysisdata$apoe_old, "apoe_excl.rds"))

printcoxresults <- function(modeloutput){
  results <- summary(modeloutput)$coefficients[,c(1:3,5)]
  colnames(results) <- c("Log HR", "Hazard Ratio", "SE(logHR)", "p-value")
  return(results)
}

```

```{r loaddata, include=TRUE, echo=FALSE}
data$selfrephyp <- data$prevHBP==TRUE | data$VIhyp==TRUE
data$controlled <- !(data$SBP>=140 | data$DBP>=90)
data$age <- data$age - 50
data$definedhypertension <- data$SBP >= 140 | data$DBP >= 90

# Make the key dichotomous variables into factors to improve readability of outputs
data$selfrephyp <- factor(as.numeric(data$selfrephyp), levels=c(0,1), labels=c("Self-reported normotensive", "Self-reported hypertensive"))
data$measuredhyp <- factor(as.numeric(data$measuredhyp), levels=c(0,1), labels=c("Not hypertensive at baseline", "Measured hypertensive at baseline"))
data$HBPmeds <- factor(as.numeric(data$HBPmeds), levels=c(0,1), labels=c("Self-reported no medication", "Self-reported BP medication"))
data$controlled <- factor(as.numeric(data$controlled), levels=c(0,1), labels=c("Inadequately controlled", "Successfully controlled"))

```

## Tabulation and Cox regression of all possible 2x2 joint hypertension variables against time to dementia, adjusted for age and gender

```{r jointvars, include=TRUE, echo=FALSE}
data$measured_or_reported_hypertension[data$measuredhyp=="Not hypertensive at baseline" & data$selfrephyp=="Self-reported normotensive"] <- "Neither"
data$measured_or_reported_hypertension[data$measuredhyp=="Measured hypertensive at baseline" & data$selfrephyp=="Self-reported normotensive"] <- "Measured only"
data$measured_or_reported_hypertension[data$measuredhyp=="Not hypertensive at baseline" & data$selfrephyp=="Self-reported hypertensive"] <- "Self-report only"
data$measured_or_reported_hypertension[data$measuredhyp=="Measured hypertensive at baseline" & data$selfrephyp=="Self-reported hypertensive"] <- "Both"

data$measured_or_reported_hypertension <- factor(data$measured_or_reported_hypertension, levels=c("Neither", "Measured only", "Self-report only", "Both"))


data$measuredHypt_or_reportedMeds[data$measuredhyp=="Not hypertensive at baseline" & data$HBPmeds=="Self-reported no medication"] <- "Neither"
data$measuredHypt_or_reportedMeds[data$measuredhyp=="Measured hypertensive at baseline" & data$HBPmeds=="Self-reported no medication"] <- "Measured hypt"
data$measuredHypt_or_reportedMeds[data$measuredhyp=="Not hypertensive at baseline" & data$HBPmeds=="Self-reported BP medication"] <- "Self-report BP meds"
data$measuredHypt_or_reportedMeds[data$measuredhyp=="Measured hypertensive at baseline" & data$HBPmeds=="Self-reported BP medication"] <- "Both"

data$measuredHypt_or_reportedMeds <- factor(data$measuredHypt_or_reportedMeds, levels=c("Neither", "Measured hypt", "Self-report BP meds", "Both"))


data$reported_hypt_or_meds[data$selfrephyp=="Self-reported normotensive" & data$HBPmeds=="Self-reported no medication"] <- "Neither"
data$reported_hypt_or_meds[data$selfrephyp=="Self-reported hypertensive" & data$HBPmeds=="Self-reported no medication"] <- "Self-report hypt"
data$reported_hypt_or_meds[data$selfrephyp=="Self-reported normotensive" & data$HBPmeds=="Self-reported BP medication"] <- "Self-report BP meds"
data$reported_hypt_or_meds[data$selfrephyp=="Self-reported hypertensive" & data$HBPmeds=="Self-reported BP medication"] <- "Both"

data$reported_hypt_or_meds <- factor(data$reported_hypt_or_meds, levels=c("Neither", "Self-report hypt", "Self-report BP meds", "Both"))


```


```{r coxmodels, include=TRUE, echo=FALSE}
kable(table(data$measured_or_reported_hypertension), caption="Measured hypertension at baseline and self-reported hypertension")
model1 <- coxph(Surv(time_to_dementia, dementia_status) ~ age + gender + measured_or_reported_hypertension, data=data)
kable(printcoxresults(model1), caption="Cox regression of measured/self-reported hypertension against time to dementia")


kable(table(data$measuredHypt_or_reportedMeds), caption="Measured hypertension at baseline and self-reported BP medication")
model1 <- coxph(Surv(time_to_dementia, dementia_status) ~ age + gender + measuredHypt_or_reportedMeds, data=data)
kable(printcoxresults(model1), caption="Cox regression of measured hypertension/self-reported BP medication against time to dementia")


kable(table(data$reported_hypt_or_meds), caption="Self-reported hypertension and self-reported BM medication")
model1 <- coxph(Surv(time_to_dementia, dementia_status) ~ age + gender + reported_hypt_or_meds, data=data)
kable(printcoxresults(model1), caption="Cox regression of self-reported hypertension/medication against time to dementia")


```

## Check that there aren't frequency peaks around 140/90, which we would expect from predominately manual BP readings:

```{r plot, include=TRUE, echo=FALSE}
bp <- readRDS("K:\\TEU\\APOE on Dementia\\Data Management\\R_Dataframes_TLA\\38358\\BlP_base.rds")

hist(bp$BlP_SBPMan.0[bp$BlP_SBPMan.0>=100 & bp$BlP_SBPMan.0<=180], breaks=seq(100,180,by=1), main="Manually measured systolic BP \nbetween 100 and 180 mmHg", xlab="Systolic BP, mmHg")
hist(bp$BlP_SBPAuto.0[bp$BlP_SBPAuto.0>=100 & bp$BlP_SBPAuto.0<=180], breaks=seq(100,180,by=1), main="Automatically measured systolic BP \nbetween 100 and 180 mmHg", xlab="Systolic BP, mmHg")
hist(bp$BlP_SBPMan.0 %% 5, main="Manually measured systolic BP,\n modulo 5", xlab="Systolic BP modulo 5")
hist(bp$BlP_SBPAuto.0 %% 5, main="Automatically measured systolic BP,\n modulo 5", xlab="Systolic BP modulo 5")
```

## Consider hypertensives taking BP medication who are successfully or unsuccessfully controlling their BP

```{r control, include=TRUE, echo=FALSE}
kable(table(data$controlled[data$HBPmeds=="Self-reported BP medication"]), caption="Control among those on BP medication")
model1 <- coxph(Surv(time_to_dementia, dementia_status) ~ age + gender + controlled, data=data[data$HBPmeds=="Self-reported BP medication",])
kable(printcoxresults(model1), caption="Cox regression of BP control among those taking BP medication against time to dementia")


data$hypstrata[data$measuredhyp=="Not hypertensive at baseline" & data$HBPmeds=="Self-reported no medication"] <- "Normotensive"
data$hypstrata[data$measuredhyp=="Measured hypertensive at baseline" & data$HBPmeds=="Self-reported no medication"] <- "Hypertensive without meds"
data$hypstrata[data$measuredhyp=="Not hypertensive at baseline" & data$HBPmeds=="Self-reported BP medication"] <- "On meds, in control"
data$hypstrata[data$measuredhyp=="Measured hypertensive at baseline" & data$HBPmeds=="Self-reported BP medication"] <- "On meds, uncontrolled"

data$hypstrata <- factor(data$hypstrata, levels=c("Normotensive", "Hypertensive without meds", "On meds, in control", "On meds, uncontrolled"))

kable(table(data$hypstrata), caption="Separating the never-hypertensives and the controlled hypertensives")
model1 <- coxph(Surv(time_to_dementia, dementia_status) ~ age + gender + hypstrata, data=data)
kable(printcoxresults(model1), caption="Cox regression of hypertension/control status against time to dementia")

```

```{r stroke, include=FALSE, echo=FALSE}
stroke <- readRDS(file="K:\\TEU\\APOE on Dementia\\Data Management\\R_Dataframes_TLA\\38358\\Organised\\stroke.rds")
data <- merge(data, stroke, by="ID", all=TRUE)

# Individuals with stroke as a cause of death should be included as having stroke
data$strdate <- data$stroke_date
data$strdate[data$strdeath==TRUE & !is.na(data$strdeath)] <- pmin(data$stroke_date[data$strdeath==TRUE & !is.na(data$strdeath)],
                                                                  data$deathdate[data$strdeath==TRUE & !is.na(data$strdeath)],
                                                                  na.rm=TRUE)

# Time to HES-recorded or death registry diagnosis of stroke
data$stroketime <- as.numeric(difftime(data$strdate, data$recdate, unit='days'))

# For the survival analysis, we want the time until the first of these end points
data$time_to_stroke <- pmin(data$stroketime, data$deathtime, data$lfutime, data$actime, na.rm=TRUE)
data$time_to_stroke_yrs <- data$time_to_stroke/365.25
# The status is whether they received a stroke diagnosis by the end point
data$stroke_status <- (!is.na(data$stroketime) & data$stroketime == data$time_to_stroke)

```

## Check that in this dataset the relationship between BP and stroke still holds

```{r coxstroke, include=TRUE, echo=FALSE}

model1 <- coxph(Surv(time_to_stroke, stroke_status) ~ age + gender + SBP, data=data)
kable(printcoxresults(model1), caption="Cox regression of continuous systolic blood pressure against time to stroke")

model1 <- coxph(Surv(time_to_stroke, stroke_status) ~ age + gender + SBPcat, data=data)
kable(printcoxresults(model1), caption="Cox regression of categorical systolic blood pressure against time to stroke (reference category SBP<=120)")

model1 <- coxph(Surv(time_to_stroke, stroke_status) ~ age + gender + DBP, data=data)
kable(printcoxresults(model1), caption="Cox regression of continuous diastolic blood pressure against time to stroke")

model1 <- coxph(Surv(time_to_stroke, stroke_status) ~ age + gender + DBPcat, data=data)
kable(printcoxresults(model1), caption="Cox regression of categorical diastolic blood pressure against time to stroke (reference category DBP<=80)")

model1 <- coxph(Surv(time_to_stroke, stroke_status) ~ age + gender + measuredhyp, data=data)
kable(printcoxresults(model1), caption="Cox regression of measured hypertensive status at baseline assessment against time to stroke")

```