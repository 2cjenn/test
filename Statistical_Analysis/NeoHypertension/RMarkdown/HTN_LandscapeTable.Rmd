---
title: "HTNtabulation (landscape)"
author: "Jennifer Collister"
date: "25/02/2020"
output: 
  word_document:
      reference_docx: "K:/TEU/APOE on Dementia/RMarkdownLandscape.docx"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(kableExtra)
library(knitr)
library(DiagrammeR)
library(DiagrammeRsvg)
library(magrittr)
library(svglite)
library(rsvg)
library(png)

source("K:/TEU/APOE on Dementia/Statistical Analysis/JCfunctions.R")
options(knitr.kable.NA='')

data <- readRDS(file="K:\\TEU\\APOE on Dementia\\Data Management\\R_Dataframes_TLA\\38358\\Organised\\Hypertension\\Neo\\HTN_excl.rds")

hypertensives <- data[data$evidenceHTN==TRUE & !is.na(data$evidenceHTN),]
treated <- data[data$treated==TRUE & !is.na(data$treated),]
```

# Note on data completeness

See email for discussion.

```{r data_completeness, include=TRUE, echo=FALSE}

varlist <- c("age", "gender", "BMIcat", "WaistCircCat", "ethnicity", "Smo_Status", "weekly_alcunits", "alc_binge_", "HTNdx_severity", "HTNdx_duration", "HTNdx_durcat", "hypmedsno", "townsend_depind", "income", "ISCED", "employment", "BirthCountryIncomeLevel", "BowelCancerScreening", "FamilyHist_CVD_", "PhA_METsWkAllAct", "METs_over150", "CVD_", "Diabetes_", "Asthma_or_COPD_", "Migraine_", "Depression_", "Back_pain_", "Other_chronic_comorbidities_")

count_missing <- c()
for(var in varlist){
  count_missing <- c(count_missing, nrow(treated[is.na(treated[[var]]),]))
}
count_missing <- cbind(varlist, count_missing)
kable(count_missing)
```

# Table 2. Univariable and multivariable logistic regression identifying factors associated with hypertension control, among UK adults on antihypertensive treatment, n = `r nrow(treated)`.

Note that it was not possible to include hypertension severity in the model, as this is defined based on the BP measured at baseline - and therefore all individuals with Stage 1, 2 or 3 hypertension were not controlling their BP, as control is also defined by baseline measured BP.


```{r logisticregression, include=TRUE, echo=FALSE}
source("K:/TEU/APOE on Dementia/Statistical Analysis/JCfunctions.R")

# treated$HTNdx_severity2 <- as.character(treated$HTNdx_severity)
# treated$HTNdx_severity2[treated$HTNdx_severity2 %in% c("Stage 2", "Stage 3")] <- "Stage 2 or 3"
# treated$HTNdx_severity2 <- factor(treated$HTNdx_severity2, levels=c("Normotensive", "Stage 1", "Stage 2 or 3"))

varlist <- c("age", "gender", "BMIcat", "WaistCircCat", "ethnicity", "Smo_Status", "weekly_alcunits", "alc_binge_", "HTNdx_durcat", "hypmedsno", "townsend_depind", "income", "ISCED", "employment", "BirthCountryIncomeLevel", "BowelCancerScreening", "FamilyHist_CVD_", "METs_over150", "CVD_", "Diabetes_", "Asthma_or_COPD_", "Migraine_", "Depression_", "Back_pain_", "Other_chronic_comorbidities_")
forlater <- c("PhA_METsWkAllAct", "HTNdx_duration")

preparecoefflist <- function(df, varname){
  if(is.factor(df[[varname]])){
        levels <- levels(df[[varname]])
        variable <- c(varname,rep(NA, length(levels)-1))
        coeffname <- paste0(varname,levels)
      } else {
        levels <- NA
        variable <- varname
        coeffname <- varname
      }
  return(data.frame(coeffname, variable, levels, stringsAsFactors=FALSE))
}

regressiontable <- function(df, varlist, regresstype){
  coefflist <- list()
  # Prepare the list of coefficients - variables and levels for factors or blanks for continuous
  for(var in varlist){
      coefflist[[var]] <- preparecoefflist(df=df, varname=var)
  }
  
  if(regresstype=="univariable"){
    modellist <- list()
    for(var in varlist){
      coeffnames <- coefflist[[var]]
      
      # Prepare the formula and pass it to the model
      formula <- paste0("controlled ~ ", var)
      model <- glm(formula, data=df, family="binomial")
      
      # Add the pretty-formatted outputs to the list
      modellist[[var]] <- printlogresults(model, coeffnames, IDcol=TRUE)
    }
    # Vertically concatenate all the pretty outputs into one output table
    outdf <- do.call(rbind, modellist)
    
  } else if (regresstype=="adjusted"){
    modellist <- list()
    adjvarlist <- c("age", "gender")
  
    # Run the regressions for age and gender separately to go on top of the table
    for(adjvar in adjvarlist){
      coeffnames <- preparecoefflist(df=df, varname=adjvar)
      
      formula <- paste0("controlled ~ ", paste(adjvarlist, collapse="+"))
      model <- glm(formula, data=df, family="binomial")
      
      # Add the pretty-formatted outputs to the list
      modellist[[adjvar]] <- printlogresults(model, coeffnames, IDcol=TRUE)
    }
        
    # Putting age or gender in the regression twice would confuse it, so make sure they're not in the varlist
    varlist <- varlist[!varlist %in% adjvarlist]
    
    for(var in varlist){
      coeffnames <- coefflist[[var]]
      
      # Prepare the formula and pass it to the model
      formula <- paste0("controlled ~ ", paste(adjvarlist, collapse="+"), "+", var)
      model <- glm(formula, data=df, family="binomial")
      
      # Add the pretty-formatted outputs to the list
      modellist[[var]] <- printlogresults(model, coeffnames, IDcol=TRUE)
    }
    outdf <- do.call(rbind, modellist)
    
  } else if (regresstype=="multivariable"){
    coeffnames <- do.call(rbind, coefflist)
    formula <- paste0("controlled ~ ", paste(varlist, collapse=" + "))
    model <- glm(formula, data=df, family="binomial")
    outdf <- printlogresults(model, coeffnames, IDcol=TRUE)
  }
  
  rownames(outdf) <- NULL
  return(outdf)
}

uni <- regressiontable(df=treated, varlist=varlist, regresstype="univariable")
adj <- regressiontable(df=treated, varlist=varlist, regresstype="adjusted")
multi <- regressiontable(df=treated, varlist=varlist, regresstype="multivariable")
tab2 <- merge(merge(uni, adj, by=c("IDcol", "Coefficient", "Level"), sort=FALSE),
              multi, by=c("IDcol", "Coefficient", "Level"), sort=FALSE)
tab2 <- tab2[,-which(names(tab2)=="IDcol")]
kable(tab2, caption="Logistic regressions of various factors against hypertension control status, odds ratios are for successful BP control.")


```















